# Asterless / MGPIC2025（合成猫 Meme）

本项目是一款基于经典“合成大西瓜”玩法的轻量级合并游戏，由 [MoonBit](https://www.moonbitlang.com/) 语言与 [Selene](https://github.com/moonbit-community/selene) 游戏引擎构建。

在线试玩（GitHub Pages）：[合成猫 Meme](https://asterless.github.io/MGPIC2025/)

在 Linux 与 macOS 系统上，也可通过以下命令在本地 8000 端口直接运行游戏：

```bash
git clone https://github.com/Asterless/MGPIC2025.git
cd ./MGPIC2025
./run.sh
```

## 游戏玩法

* 从屏幕顶部落下不同等级的猫 Meme。
* 两只相同等级的猫 Meme 相遇时会合成为更高等级的猫 Meme 并获得分数。
* 不同等级的猫 Meme 仅会发生物理碰撞。
* 目标是在有限空间内尽可能多地合成猫 Meme，获得高分，并防止猫 Meme 堆积到顶部。

## 游戏预览

![游戏预览](docs/image/preview_1.png)
![合成演示](docs/image/merge_demo.gif)

## 操作指南

* **A / D**：左右移动指针
* **空格（Space）**：从当前指针位置放下猫 Meme
* **Q / E**：对所有猫 Meme 施加水平力
* **鼠标左键点击猫 Meme**：猫 Meme 会发出可爱的叫声

---

## TODO 列表

未来计划改进与扩展的功能：

* [ ] **游戏结束机制**：当猫 Meme 堆积超过顶部警戒线时触发游戏结束（非必需）。
* [ ] **UI 优化**：
  * [ ] 改进分数显示与“下一个猫 Meme”提示界面。
  * [ ] 增加清晰的游戏结束画面（显示分数与重开按钮）。
* [ ] **音效增强**：
  * [x] 为不同等级的猫 Meme 添加独特点击音效。
  * [ ] 增加游戏结束音效。
* [ ] **视觉表现**：
  * [ ] 为合成过程添加粒子或动画特效。
  * [ ] 增加动态背景效果。
* [ ] **游戏平衡性**：
  * [ ] 调整猫 Meme 等级生成权重以优化节奏。
  * [ ] 调整物理参数（弹性、摩擦等）。
* [ ] **高分榜**：实现本地或在线排行榜，记录玩家最佳成绩。
* [x] **代码结构重构**：将 `main.mbt` 拆分为模块化文件（如 `state.mbt`, `systems.mbt`）。
* [ ] **函数式重构**：
  * [ ] 使用 Monad 管理副作用，简化状态管理逻辑。
  * [ ] 尽量消除可变状态，优先使用 `each()`、`map()`、`fold()` 等高阶函数替代循环。
* [ ] **插件系统**：
  * [ ] 定义插件接口，实现模块化玩法扩展。
  * [ ] 将当前玩法抽象为核心插件。
  * [ ] 支持“材质包插件”，允许用户替换猫 Meme 贴图。
* [ ] **物理系统改进**：
  * [ ] 完全舍弃 Selene 原生物理引擎，以插件形式实现新的物理模块，基于圆形检测范围重新设计碰撞逻辑，确保挤压行为良定义。

## 设计说明

### 核心系统设计

项目充分利用了 **MoonBit** 的函数式特性，构建出类型安全、可组合、可维护的游戏架构。

主要技术特点包括：

* **事件系统**：`bind_key` / `bind_keys` 接收函数参数 (`handler : () -> Unit`)，支持事件逻辑的组合与复用。
* **高阶函数式集合操作**：通过 `each()`、`map()`、`fold()` 等函数实现集合处理，避免命令式循环与可变状态。
* **ECS 架构**：基于 Selene 引擎的实体组件系统，将实体（Entity）与属性（Component）分离，通过系统（System）统一驱动逻辑。

### 模块结构

项目结构划分如下：

* `state`：全局状态管理
* `systems`：逻辑系统
* `control_event`：输入与事件捕获
* `prop`：实体属性访问
* `entities`：实体定义

在 `systems` 中定义的系统可直接加载到引擎。
`control_event` 提供便捷的按键绑定与事件注册，`prop` 封装实体属性访问逻辑，`entities` 定义了猫 Meme 实体及相关行为。

整体架构按层抽象，采用自顶向下逐层重构的方式，逐步实现模块解耦与高可维护性。
同时，为未来的函数式重构预留了 `state_monad` 模块，用于实现纯函数式状态管理，进一步提升鲁棒性与可测试性。

### 实现难点

* **实体挤压 UB**：
  Selene 引擎在实体挤压时存在未定义行为（UB），可能导致合成后的猫 Meme 获得极高速度并直接穿墙。
  临时方案是在 `cat_teleport_system` 中检测越界实体并将其传送回场内。
  后续计划 **完全舍弃 Selene 原生的物理引擎**，以 **插件形式** 自行实现新的物理模块。该模块将基于圆形检测范围重新设计碰撞逻辑，使挤压行为从未定义转化为良定义的物理交互。

* **全局状态的副作用管理**：
  当前实现依赖全局可变状态，增加了维护难度与心智负担。
  未来将通过 **State Monad** 重构事件系统，以纯函数式方式管理状态变化，消除隐式副作用并提升整体鲁棒性与可测试性。

## 团队信息

团队名称: LunaFlow

团队成员: [Asterless](https://github.com/Asterless) & [KCN-judu](https://github.com/KCN-judu)

联系方式: [zhehao0827@163.com](zhehao0827@163.com)