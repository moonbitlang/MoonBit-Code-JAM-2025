<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>My Game</title>
    <script> 

        function getLocationParams(href=null) {
            let params = {};
            let querys = href == null ? location.href.split("?") : href.split("?");
            if (querys.length > 1) {
                let items = querys[1].split("&");
                if (items.length > 0) {
                    for (let item of items) {
                        let pair = item.split("=");
                        if (pair.length > 1) {
                            params[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1]);
                        }
                    } 
                }
            }
            return params;
        }
        let aiApiHost = '/chat';
        {
            aiApiHost = 'https://ewbraent-mini111.ms.show/chat';

            //let params = getLocationParams();
            //if ('chat' in params && params['chat'] == 'moda') {
            //    aiApiHost = 'https://ewbraent-mini111.ms.show/chat'       
            //}

            let params = getLocationParams();
            if ('chat' in params && params['chat'] != 'moda') {
                aiApiHost = '/chat'       
            }
        }

        const chatUUID = crypto.randomUUID();
        document.cookie = "chatuuid=" + chatUUID;
        var keyObj = {btn:"", idx:0, x:0, y:0};
        function mylogAiBoard(s) {
            if (s.length == 0) return;
            s = s.replace("\\n", "\n");
            let p = document.createElement("pre")
            p.innerText = s;
            if (aiBoard.childElementCount > 0) {
                aiBoard.insertBefore(p, aiBoard.children[0]);
            } else {
                aiBoard.appendChild(p);
            }
            if (aiBoard.childElementCount > 50) {
                aiBoard.removeChild(aiBoard.childNodes[aiBoard.childElementCount - 1]);
            }
            aiPreviewBoard.innerText = s;
        
        }
        let llmresult = "[]"
        let stime = Date.now()
        let callcnt = 300
        function observe_and_act(ostr, raw = false) {
            try {
                let ret = []
                if (raw) {
                    if (llmresult == null) {
                        callcnt--;
                        if (callcnt < 0) {
                            callcnt = 300
                            llmresult = "[]"
                        } else {
                            return []
                        }
                    }
                    
                    let back = llmresult
                    llmresult = null
                    let r = /```json\s*(.*)\s*```/g.exec(back)                        
                    console.log("back", back, "r", r)
                    try {
                        if (r == null) {
                            ret = JSON.parse(back)
                        } else if (r.length > 1) {
                            ret = JSON.parse(r[1])
                        } else {
                            ret = []
                        }
                    } catch(e) {
                        console.log(e)
                        ret = []
                    }
                    
                    if (back != null) {
                        console.log("post", ostr, "back", ret)
                        
                        stime = Date.now()
                        fetch(aiApiHost + '?chatuuid='+chatUUID, {
                            method: 'POST', // 或者 'PUT' 取决于你想要的操作
                            headers: {
                                //'ChatUUID':chatUUID,
                                'Content-Type': 'text/plain' // 设置Content-Type为text/plain
                            },
                            body: ostr // 直接传递字符串
                        })
                        .then(response => response.text()) // 如果服务器返回文本，可以使用.text()
                        .then(data => {
                            console.log("answer consume:", Date.now() - stime);
                            llmresult = data;
                            mylogAiBoard(data);
                        })
                        .catch(err => console.log(err))
                    }
                } else {
                    let env = JSON.parse(ostr);
                    //TODO RL dealing 
                }
                return ret;
            } catch(e) {
                console.log(e)
            }  
            return []
            //return json describes the act
        }
    </script>
    <script src="survivors.js" defer></script>
</head>

<body>
    <div style="display: flex;">
        <div style="width: 300px; max-height:600px;overflow-y:scroll;" class="card">
            <input type="button" value ="移动端操作" style="position: absolute; left:10px;top:10px;font-size: 10px;" onclick = "Array.from(document.querySelectorAll('.mobile-controls')).forEach(e=>{if(e.style.display != 'none') {e.style.display = 'none'} else {e.style.display='inline-block';} }) "/>
            <input class="mobile-controls" type="button" value ="W" style="display:none; position:absolute; left:50px;top:50px;font-size: 20px;" onclick = "keyObj.btn='W'"/>
            <input class="mobile-controls" type="button" value ="A" style="display:none;position: absolute; left:5px;top:90px;font-size: 20px;" onclick = "keyObj.btn='A'"/>
            <input class="mobile-controls" type="button" value ="S" style="display:none;position: absolute; left:50px;top:90px;font-size: 20px;" onclick = "keyObj.btn='S'"/>
            <input class="mobile-controls" type="button" value ="D" style="display:none;position: absolute; left:95px;top:90px;font-size: 20px;" onclick = "keyObj.btn='D'"/>
            <input class="mobile-controls" type="button" value ="Q" style="display:none;position: absolute; left:5px;top:135px;font-size: 20px;" onclick = "keyObj.btn='Q'"/>
            <input class="mobile-controls" type="button" value ="H" style="display:none;position: absolute; left:50px;top:135px;font-size: 20px;" onclick = "keyObj.btn='H'"/>
            <input class="mobile-controls" type="button" value ="B" style="display:none;position: absolute; left:80px;top:135px;font-size: 20px;" onclick = "keyObj.btn='B'"/>
            
            <input class="mobile-controls" type="button" value ="建筑/英雄" style="display:none;position: absolute; left:190px;top:135px;font-size: 20px;" onclick = "keyObj.btn='建筑/英雄'"/>
            
            <label class="mobile-controls"  style="display:none;position: absolute; left:10px;top:180px;font-size: 15px;">水平坐标👉</label>
            <select class="mobile-controls" id="xSelect" style="display:none;position: absolute; left:90px;top:180px;font-size: 15px;" onchange="a=Number(xSelect.value);if (isNaN(a)) {a = 0;};keyObj.x = a;">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
            </select>
             <label class="mobile-controls"  style="display:none;position: absolute; left:160px;top:180px;font-size: 15px;">垂直坐标👇</label>
            <select class="mobile-controls" id="ySelect" style="display:none;position: absolute; left:240px;top:180px;font-size: 15px;" onchange="a=Number(ySelect.value);if (isNaN(a)) {a = 0;};keyObj.y = a;">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
            </select>
            <label class="mobile-controls"  style="display:none;position: absolute; left:5px;top:230px;font-size: 15px;">列表项</label>
            <select class="mobile-controls" id="idxSelect" style="display:none;position: absolute; left:50px;top:230px;font-size: 20px;" onchange="a=Number(idxSelect.value);if (isNaN(a)) {a = 0;};keyObj.idx = a;">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
            </select>
            <input class="mobile-controls" type="button" value ="-" style="display:none;position: absolute; left:105px;top:230px;font-size: 20px;"  onclick = "keyObj.btn='-'"/>
            <input class="mobile-controls" type="button" value ="+" style="display:none;position: absolute; left:130px;top:230px;font-size: 20px;"  onclick = "keyObj.btn='+'"/>
            <p stlye="margin-top:15px"></p>

            WASD移动,攻击和交互。交互人类会回血。

            <br /> 可以攻击敌对单位(如各种魔物)和敌对建筑(如魔物巢穴)

            <br /> Q切换大世界和小区域, 大世界用颜色表示势力, 有四个国家, 无主地绿色, 以及象征魔物占领地黑色。

            <br /> 小区域内也可以从地图边缘回到大世界, 小区域里水域不可建造和移动。

            <br /> 你是拯救世界的勇者之一, 在你所在的附近会不断出现新的人物和魔物。

            <br /> 消灭魔物和怪物巢穴会获得功绩。满1000点功绩进入自己国度的村镇会自动消耗并成为当地的领主, 获得经济建筑营利的税收。

            <br /> 消耗金币可以在当前区域招募新的人口。

            <br /> 带领人类发展壮大, 消灭魔物吧。

            <br /> 当然, 也可以尽可能多地刷金币! 

            <br /> 这个世界在自然演化中。每隔几天会出现一个怪物巢穴, 怪物巢穴每天会生成不离开区域的魔物。

            <br /> 世界上有若干国家。每个国家初始有若干城市。有许多种建筑，需要消耗经济值建造(点击建造按钮然后点击地图), 建筑处派驻空闲人口会产出经济值/食物等等, 而人物被派驻到建筑会获得相应的职业得到加成。可以创建英雄，英雄可以分配某个种类的士兵并叠加此单位的攻击力(比升级提升战斗力要快)。这些城市也会在其领主的决策下自动建造建筑，分配人口，招募英雄。城墙可以提升区域的防御值, 敌对的单位只有削减完区域的防御值才能从大地图进入城市。人物游荡时可能离开小区域前往大世界, 从而可能前往其他小区域, 荒野区域中, 游荡的人口数量超过5则可能建立新的城镇。

            <br /> 国家之间会有小概率发生战争从而改变城市的归属。魔物/英雄/士兵/武装起来的普通职业者都会自动寻找并攻击城市内的敌对单位和建筑。最终大世界会持续地动态地变化填色(荒野的绿色, 魔物巢穴的黑色, 以及四个国家的四种颜色)。

            <br /> 除此之外, 我们接入了大模型(可以访问 https://www.modelscope.cn/studios/ewbraent/mini111/summary 这里是部署了大模型的，或者使用我们的win/linux/mac客户端), ai可以扮演各个国家, 经济值建造各种经营性和人口建筑, 宣战和谈, 军事调拨。
            
            <br /> 大模型通信默认使用'/chat'路径, 如果链接参数带 'chat=moda' 那么会使用魔搭的后端接入ai
        </div>
        <canvas id="canvas" style="display: block; margin: 0 auto;" height="32" width="32">
        </canvas>
        <div style = "display: flex; height:600px; flex-direction: column; justify-content: space-between;">
            <div style="width: 300px; max-height:300px;overflow-y:scroll;" id="logBoard" class="card"></div>
            <div style="width: 300px; max-height:300px;overflow-y:scroll;" id="aiPreviewBoard" class="card"></div>
        </div>
    </div>
    <div id ="board"></div>
    <div id ="aiBoard" class="card"></div>
    <style type="text/css">
        #logBoard p {
            margin-top: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
            font-size: 12px;
        }
        #aiPreviewBoard {
            font-size: 12px;
        }
        .card {
            border: 1px solid #333;
            border-radius: 4px;
            padding: 2px;    
        }
        .card:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</body>

</html>