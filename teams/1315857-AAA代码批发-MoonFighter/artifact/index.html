<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoonFighter - WASM-4 Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
        }
        
        #main-container {
            display: grid;
            grid-template-columns: 300px 640px 300px;
            gap: 30px;
            max-width: 1300px;
            width: 100%;
            align-items: start;
        }
        
        #left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        #title-section {
            text-align: center;
            padding: 30px 20px;
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid #00ff88;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
        }
        
        h1 {
            font-size: 2.5em;
            color: #00ff88;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px rgba(0, 255, 136, 0.5); }
            to { text-shadow: 0 0 30px rgba(0, 255, 136, 1); }
        }
        
        .subtitle {
            color: #88ffdd;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .info-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .info-box h3 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
            padding-bottom: 8px;
        }
        
        .info-box p {
            margin: 10px 0;
            line-height: 1.6;
            color: #ccc;
        }
        
        .info-box ul {
            list-style: none;
            padding: 0;
        }
        
        .info-box li {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
            color: #ccc;
        }
        
        .info-box li:before {
            content: "â–¸";
            position: absolute;
            left: 0;
            color: #00ff88;
        }
        
        #center-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        #game-container {
            position: relative;
            background: #000;
            padding: 15px;
            border-radius: 15px;
            border: 3px solid #00ff88;
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.4);
        }
        
        canvas {
            display: block;
            width: 640px;
            height: 640px;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            border-radius: 8px;
        }
        
        #status {
            text-align: center;
            padding: 15px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            font-size: 1.1em;
        }
        
        #right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            margin: 12px 0;
            gap: 15px;
        }
        
        .key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 45px;
            height: 35px;
            padding: 0 12px;
            background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
            border: 2px solid #00ff88;
            border-radius: 6px;
            font-weight: bold;
            color: #00ff88;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
            font-size: 1.1em;
        }
        
        .key-group {
            display: flex;
            gap: 8px;
        }
        
        #debug {
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
        }
        
        #debug h3 {
            color: #ffaa00;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        #debug-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #aaa;
            line-height: 1.4;
        }
        
        .loading { color: #ffaa00; }
        .error { color: #ff4444; }
        .success { color: #00ff88; }
        
        @media (max-width: 1280px) {
            #main-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            #left-panel, #right-panel {
                max-width: 640px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="left-panel">
            <div id="title-section">
                <h1>ğŸŒ™ MoonFighter</h1>
                <p class="subtitle">MoonBit Ã— WASM-4</p>
            </div>
            
            <div class="info-box">
                <h3>ğŸ“– æ¸¸æˆè¯´æ˜</h3>
                <ul>
                    <li>æ§åˆ¶é£èˆ¹æ¶ˆç­æ•Œæœº</li>
                    <li>æ¯å‡»æ¯ä¸€æ¶æ•Œæœºå¾— 10 åˆ†</li>
                    <li>é¿å…ä¸æ•Œæœºç¢°æ’</li>
                    <li>æŒ‘æˆ˜æœ€é«˜åˆ†æ•°è®°å½•</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h3>ğŸ¯ æ¸¸æˆç‰¹è‰²</h3>
                <p>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ MoonBit ç¼–ç¨‹è¯­è¨€å¼€å‘çš„å¤å¤é£æ ¼å¤ªç©ºå°„å‡»æ¸¸æˆï¼Œè¿è¡Œåœ¨ WASM-4 è™šæ‹Ÿæ¸¸æˆæœºä¸Šã€‚</p>
                <p>ä½“éªŒç»å…¸çš„åƒç´ è‰ºæœ¯é£æ ¼å’Œæµç•…çš„æ¸¸æˆä½“éªŒï¼</p>
            </div>
        </div>
        
        <div id="center-panel">
            <div id="game-container">
                <canvas id="canvas" width="160" height="160"></canvas>
            </div>
            <div id="status" class="loading">æ­£åœ¨åˆå§‹åŒ–...</div>
        </div>
        
        <div id="right-panel">
            <div class="info-box">
                <h3>ğŸ® æ“ä½œæ§åˆ¶</h3>
                <div class="control-row">
                    <div class="key-group">
                        <div class="key">â†</div>
                        <div class="key">â†’</div>
                    </div>
                    <span>ç§»åŠ¨é£èˆ¹</span>
                </div>
                <div class="control-row">
                    <div class="key">Z</div>
                    <span>å‘å°„å­å¼¹</span>
                </div>
                <div class="control-row">
                    <div class="key">R</div>
                    <span>é‡æ–°å¼€å§‹</span>
                </div>
            </div>
            
            <div class="info-box">
                <h3>ğŸ’¡ æ¸¸æˆæç¤º</h3>
                <ul>
                    <li>ä¿æŒç§»åŠ¨é¿å…è¢«å‡»ä¸­</li>
                    <li>é¢„åˆ¤æ•Œæœºç§»åŠ¨è½¨è¿¹</li>
                    <li>åˆç†ä½¿ç”¨å­å¼¹</li>
                    <li>æ³¨æ„å±å¹•è¾¹ç•Œ</li>
                </ul>
            </div>
            
            <div id="debug">
                <h3>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h3>
                <div id="debug-content">ç­‰å¾…æ—¥å¿—...</div>
            </div>
        </div>
    </div>

    <script>
        let logCount = 0;
        let lastLogTime = Date.now();
        const MAX_LOGS = 100;
        
        const debugLog = function(msg) {
            logCount++;
            const now = Date.now();
            
            if (msg.includes('[TRACE]') && now - lastLogTime < 1000) {
                return;
            }
            lastLogTime = now;
            
            const debugContent = document.getElementById('debug-content');
            const timestamp = new Date().toLocaleTimeString();
            
            const lines = debugContent.textContent.split('\n');
            if (lines.length > MAX_LOGS) {
                lines.shift();
                debugContent.textContent = lines.join('\n');
            }
            
            debugContent.textContent += '[' + timestamp + '] ' + msg + '\n';
            debugContent.parentElement.scrollTop = debugContent.parentElement.scrollHeight;
            console.log(msg);
        };
        
        class WASM4Runtime {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d', { 
                    alpha: false,
                    desynchronized: true
                });
                
                this.ctx.imageSmoothingEnabled = false;
                this.memory = null;
                this.instance = null;
                
                this.PALETTE = 0x04;
                this.DRAW_COLORS = 0x14;
                this.GAMEPAD1 = 0x16;
                this.GAMEPAD2 = 0x17;
                this.GAMEPAD3 = 0x18;
                this.GAMEPAD4 = 0x19;
                this.FRAMEBUFFER = 0xa0;
                
                this.palette = [0xe0f8cf, 0x86c06c, 0x306850, 0x071821];
                this.gamepadState = 0;
                
                this.keyMap = {
                    'ArrowLeft': 0x10,
                    'ArrowRight': 0x20,
                    'ArrowUp': 0x40,
                    'ArrowDown': 0x80,
                    'z': 0x01, 'Z': 0x01,
                    'x': 0x02, 'X': 0x02,
                    'r': 0x01, 'R': 0x01
                };
                
                this.setupInput();
                debugLog('è¿è¡Œæ—¶åˆå§‹åŒ–å®Œæˆ');
            }
            
            setupInput() {
                const self = this;
                window.addEventListener('keydown', function(e) {
                    const btn = self.keyMap[e.key];
                    if (btn !== undefined) {
                        self.gamepadState |= btn;
                        e.preventDefault();
                        // è°ƒè¯•æŒ‰é”®
                        if (e.key === 'r' || e.key === 'R') {
                            debugLog('Ré”®æŒ‰ä¸‹ - æ‰‹æŸ„çŠ¶æ€: 0x' + self.gamepadState.toString(16));
                        }
                    }
                });
                
                window.addEventListener('keyup', function(e) {
                    const btn = self.keyMap[e.key];
                    if (btn !== undefined) {
                        self.gamepadState &= ~btn;
                        e.preventDefault();
                    }
                });
            }
            
            readString(ptr) {
                if (!this.memory) return '';
                const mem = new Uint8Array(this.memory.buffer);
                let end = ptr;
                while (end < mem.length && mem[end] !== 0) end++;
                const bytes = mem.slice(ptr, end);
                return new TextDecoder().decode(bytes);
            }
            
            getDrawColors() {
                if (!this.memory) return [1, 0, 0, 0];
                const view = new DataView(this.memory.buffer);
                const dc = view.getUint16(this.DRAW_COLORS, true);
                return [
                    dc & 0xf,
                    (dc >> 4) & 0xf,
                    (dc >> 8) & 0xf,
                    (dc >> 12) & 0xf
                ];
            }
            
            getPaletteColor(index) {
                if (index === 0) return 'transparent';
                const color = this.palette[index - 1] || 0;
                const r = (color >> 16) & 0xff;
                const g = (color >> 8) & 0xff;
                const b = color & 0xff;
                return 'rgb(' + r + ',' + g + ',' + b + ')';
            }
            
            drawPixelText(str, x, y, color) {
                this.ctx.save();
                this.ctx.fillStyle = color;
                // å› ä¸ºæ•´ä¸ª canvas å·²ç»è¢« scale(4, 4)ï¼Œè¿™é‡Œç›´æ¥ç”¨ 8px å­—ä½“
                // å®é™…æ¸²æŸ“æ—¶ä¼šå˜æˆ 32pxï¼Œéå¸¸æ¸…æ™°
                this.ctx.font = 'bold 8px monospace';
                this.ctx.textBaseline = 'top';
                this.ctx.textAlign = 'left';
                this.ctx.fillText(str, x, y);
                this.ctx.restore();
            }
            
            createImports() {
                const self = this;
                this.memory = new WebAssembly.Memory({ 
                    initial: 1,
                    maximum: 1
                });
                
                return {
                    env: {
                        memory: this.memory,
                        
                        line: function(x1, y1, x2, y2) {
                            const colors = self.getDrawColors();
                            if (colors[0]) {
                                self.ctx.strokeStyle = self.getPaletteColor(colors[0]);
                                self.ctx.lineWidth = 1;
                                self.ctx.beginPath();
                                self.ctx.moveTo(x1, y1);
                                self.ctx.lineTo(x2, y2);
                                self.ctx.stroke();
                            }
                        },
                        
                        rect: function(x, y, w, h) {
                            const colors = self.getDrawColors();
                            if (colors[0]) {
                                self.ctx.fillStyle = self.getPaletteColor(colors[0]);
                                self.ctx.fillRect(x, y, w, h);
                            }
                        },
                        
                        text: function(strPtr, x, y) {
                            const str = self.readString(strPtr);
                            const colors = self.getDrawColors();
                            if (colors[0]) {
                                const color = self.getPaletteColor(colors[0]);
                                self.drawPixelText(str, x, y, color);
                            }
                        },
                        
                        textUtf8: function(strPtr, len, x, y) {
                            const bytes = new Uint8Array(self.memory.buffer, strPtr, len);
                            const str = new TextDecoder().decode(bytes);
                            const colors = self.getDrawColors();
                            if (colors[0]) {
                                const color = self.getPaletteColor(colors[0]);
                                self.drawPixelText(str, x, y, color);
                            }
                        },
                        
                        trace: function() {},
                        traceUtf8: function() {},
                        tracef: function() {},
                        blit: function() {},
                        blitSub: function() {},
                        hline: function() {},
                        vline: function() {},
                        oval: function() {},
                        tone: function() {},
                        diskr: function() { return 0; },
                        diskw: function() { return 0; }
                    }
                };
            }
            
            updateMemory() {
                if (!this.memory) return;
                
                const view = new DataView(this.memory.buffer);
                
                // æ›´æ–°è°ƒè‰²æ¿
                for (let i = 0; i < 4; i++) {
                    const addr = this.PALETTE + i * 4;
                    if (addr + 3 < this.memory.buffer.byteLength) {
                        this.palette[i] = view.getUint32(addr, true) & 0xffffff;
                    }
                }
                
                // æ›´æ–°æ‰‹æŸ„çŠ¶æ€ - åŒæ—¶å†™å…¥ index 0 å’Œ 1
                if (this.GAMEPAD1 < this.memory.buffer.byteLength) {
                    view.setUint8(0x16, this.gamepadState); // index 0
                }
                if (0x17 < this.memory.buffer.byteLength) {
                    view.setUint8(0x17, this.gamepadState); // index 1  
                }
            }
            
            async load(wasmPath) {
                try {
                    debugLog('æ­£åœ¨åŠ è½½ ' + wasmPath + '...');
                    const response = await fetch(wasmPath);
                    
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                    }
                    
                    const bytes = await response.arrayBuffer();
                    debugLog('WASM æ–‡ä»¶å¤§å°: ' + bytes.byteLength + ' å­—èŠ‚');
                    
                    const imports = this.createImports();
                    const result = await WebAssembly.instantiate(bytes, imports);
                    
                    this.instance = result.instance;
                    
                    debugLog('å†…å­˜å¤§å°: ' + this.memory.buffer.byteLength + ' å­—èŠ‚');
                    
                    const exports = Object.keys(this.instance.exports);
                    debugLog('å¯¼å‡ºå‡½æ•°: ' + exports.join(', '));
                    
                    if (this.instance.exports.start) {
                        debugLog('è°ƒç”¨ start() å‡½æ•°...');
                        this.instance.exports.start();
                    }
                    
                    return true;
                } catch (error) {
                    debugLog('é”™è¯¯: ' + error.message);
                    throw error;
                }
            }
            
            gameLoop() {
                const self = this;
                
                // å…ˆæ›´æ–°æ‰‹æŸ„çŠ¶æ€
                self.updateMemory();
                
                // æ¸…ç©ºç”»å¸ƒ
                self.ctx.fillStyle = '#000';
                self.ctx.fillRect(0, 0, 160, 160);
                
                // è°ƒç”¨æ¸¸æˆæ›´æ–°
                if (self.instance.exports.update) {
                    self.instance.exports.update();
                } else if (self.instance.exports.upd) {
                    self.instance.exports.upd();
                }
                
                requestAnimationFrame(function() {
                    self.gameLoop();
                });
            }
        }
        
        (async function() {
            const canvas = document.getElementById('canvas');
            const statusEl = document.getElementById('status');
            const runtime = new WASM4Runtime(canvas);
            
            // ä½¿ç”¨é«˜åˆ†è¾¨ç‡ canvas ä½†ä¿æŒé€»è¾‘å°ºå¯¸
            const displayScale = 4; // æ˜¾ç¤ºæ—¶æ”¾å¤§4å€
            canvas.width = 160 * displayScale;
            canvas.height = 160 * displayScale;
            canvas.style.width = '640px';
            canvas.style.height = '640px';
            
            // ç¼©æ”¾ç»˜å›¾ä¸Šä¸‹æ–‡ï¼Œè¿™æ ·æ‰€æœ‰ç»˜åˆ¶å‘½ä»¤è‡ªåŠ¨æ”¾å¤§
            runtime.ctx.scale(displayScale, displayScale);
            
            // ç¡®ä¿åƒç´ å®Œç¾
            runtime.ctx.imageSmoothingEnabled = false;
            runtime.ctx.webkitImageSmoothingEnabled = false;
            runtime.ctx.mozImageSmoothingEnabled = false;
            runtime.ctx.msImageSmoothingEnabled = false;
            
            try {
                statusEl.textContent = 'â³ æ­£åœ¨åŠ è½½æ¸¸æˆ...';
                statusEl.className = 'loading';
                
                const paths = [
                    'moonfighter.wasm',
                    'target/wasm-gc/release/build/moonfighter.wasm',
                    './moonfighter.wasm'
                ];
                
                let loaded = false;
                for (let i = 0; i < paths.length; i++) {
                    try {
                        await runtime.load(paths[i]);
                        loaded = true;
                        debugLog('âœ“ æˆåŠŸä» ' + paths[i] + ' åŠ è½½');
                        break;
                    } catch (e) {
                        debugLog('âœ— æ— æ³•ä» ' + paths[i] + ' åŠ è½½: ' + e.message);
                    }
                }
                
                if (!loaded) {
                    throw new Error('æ— æ³•ä»ä»»ä½•è·¯å¾„åŠ è½½ WASM æ–‡ä»¶');
                }
                
                statusEl.textContent = 'âœ“ æ¸¸æˆå·²å°±ç»ª - å¼€å§‹æ¸¸æˆï¼';
                statusEl.className = 'success';
                
                debugLog('å¯åŠ¨æ¸¸æˆå¾ªç¯...');
                runtime.gameLoop();
                
            } catch (error) {
                statusEl.textContent = 'âœ— åŠ è½½å¤±è´¥: ' + error.message;
                statusEl.className = 'error';
                debugLog('è‡´å‘½é”™è¯¯: ' + error.message);
            }
        })();
    </script>
</body>
</html>