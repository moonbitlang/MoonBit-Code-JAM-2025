
// moon clean
// moon build --target wasm-gc
// npx wasm4 run target/wasm-gc/release/build/moonfighter.wasm


// ===== ç©å®¶ç»“æ„ä½“ =====
struct Player {
    mut x: Int
    y: Int
}
pub fn Player::new() -> Player {
  {x : 76, y : 140 }
}

pub fn move_left(self : Player) -> Unit{
  if self.x > 0 {
      self.x = self.x - 2
  }
}

pub fn move_right(self : Player) -> Unit{
  if self.x < 152 {
      self.x = self.x + 2
  }
}

// pub fn draw(self : Player) -> Unit{
//   @wasm4.set_draw_colors(1)
//   // ç»˜åˆ¶ä¸‰è§’å½¢æˆ˜æœº â–²
//   @wasm4.line(self.x + 4, self.y, self.x, self.y + 8)
//   @wasm4.line(self.x + 4, self.y, self.x + 8, self.y + 8)
//   @wasm4.line(self.x, self.y + 8, self.x + 8, self.y + 8)
// }
pub fn draw(self: Player)  -> Unit{
    @wasm4.set_draw_colors(1);
    
    // å‡è®¾self.xå’Œself.yæ˜¯é£èˆ¹ä¸­å¿ƒç‚¹çš„ä½ç½®
    let x = self.x;
    let y = self.y;
    
    // æ–°çš„é£èˆ¹è®¾è®¡ï¼šä¸»ä½“åŠ ä¸¤ä¸ªå°¾ç¿¼
    // ä¸»ä½“éƒ¨åˆ†
    @wasm4.line(x, y, x - 3, y + 8); // å·¦ä¾§çº¿
    @wasm4.line(x, y, x + 3, y + 8); // å³ä¾§çº¿
    @wasm4.line(x - 3, y + 8, x + 3, y + 8); // åº•éƒ¨è¿æ¥çº¿
    
    // å°¾ç¿¼å·¦
    @wasm4.line(x - 3, y + 8, x - 6, y + 5);
    @wasm4.line(x - 6, y + 5, x - 3, y + 2);
    @wasm4.line(x - 3, y + 2, x, y);
    
    // å°¾ç¿¼å³
    @wasm4.line(x + 3, y + 8, x + 6, y + 5);
    @wasm4.line(x + 6, y + 5, x + 3, y + 2);
    @wasm4.line(x + 3, y + 2, x, y);
}


pub fn get_center_x(self : Player) -> Int {
  self.x + 4
}

// ===== å­å¼¹ç³»ç»Ÿ =====
struct Bullet {
    mut x: Int
    mut y: Int
    mut active: Bool
}
pub fn Bullet::new() -> Bullet {
  { x: 0, y: 0, active: false }
}

pub fn fire(self: Bullet, x: Int, y: Int) -> Unit {
  self.x = x
  self.y = y
  self.active = true
}

pub fn Bullet::update(self: Bullet) -> Bool {
  if !self.active {
      return false
  }
  self.y = self.y - 3
  if self.y < -4 {
      self.active = false
      return false
  }
  // ç»˜åˆ¶
  @wasm4.set_draw_colors(0b0001)
  @wasm4.rect(self.x, self.y, 2, 4)
  true
}

// ===== æ•Œæœºç³»ç»Ÿ =====
struct Enemy {
  mut x: Int
  mut y: Int
  mut active: Bool
}


pub fn Enemy::new() -> Enemy {
  { x: 0, y: -10, active: false }
}

pub fn spawn(self: Enemy, x: Int) -> Unit {
    self.x = x
    self.y = -10
    self.active = true
}

pub fn Enemy::update(self: Enemy) -> Bool {
  if !self.active {
      return false
  }
  self.y = self.y + 1
  if self.y > 160 {
      self.active = false
      return false
  }
  // ç»˜åˆ¶æ•Œæœºï¼ˆçº¢è‰²ï¼‰
  @wasm4.set_draw_colors(3)
  @wasm4.rect(self.x, self.y, 8, 8)
  true
}

pub fn collide_with(self: Enemy, other_x: Int, other_y: Int, w: Int, h: Int) -> Bool {
  return self.x < other_x + w && self.x + 8 > other_x &&
          self.y < other_y + h && self.y + 8 > other_y
}


// ===== ä¸»æ¸¸æˆç»“æ„ä½“ =====
struct Game {
  mut player: Player
  bullets: Array[Bullet]
  enemies: Array[Enemy]
  mut score: Int
  mut game_over: Bool
  mut frame_count: Int
}


pub fn Game::new() -> Game {
  let bullets: Array[Bullet] = [
      Bullet::new(), Bullet::new(), Bullet::new(), Bullet::new(),
      Bullet::new(), Bullet::new(), Bullet::new(), Bullet::new()
  ]
  let enemies: Array[Enemy] = [
      Enemy::new(), Enemy::new(), Enemy::new(),
      Enemy::new(), Enemy::new(), Enemy::new()
  ]
  {
      player: Player::new(),
      bullets: bullets,
      enemies: enemies,
      score: 0,
      game_over: false,
      frame_count: 0,
  }
}

pub fn Game::handle_input(self: Game) -> Unit {
  let pad = @wasm4.get_gamepad(index = 1)

  if pad.button_left {
      self.player.move_left()
  }
  if pad.button_right {
      self.player.move_right()
  }
  if pad.button_1 { // æˆ– button_2ï¼Œçœ‹ä½ è®¾è®¡
      // å‘å°„å­å¼¹
      let px = self.player.get_center_x()
      let py = self.player.y
      let mut i = 0
      while i < 8 {
          if !self.bullets[i].active {
              self.bullets[i].fire(px, py)
              break
          }
          i = i + 1
      }
  }

  // é‡å¯æ¸¸æˆï¼ˆåœ¨ game over æ—¶ï¼‰
  if self.game_over && pad.button_1 {
      self.reset()
  }
}

pub fn update_entities(self: Game) -> Unit {
  // æ›´æ–°å­å¼¹
  let mut i = 0
  while i < 8 {
    let _ = self.bullets[i].update() // å¿½ç•¥è¿”å›å€¼ï¼Œæˆ–ç”¨äºå…¶ä»–é€»è¾‘
    i = i + 1 // ğŸ‘ˆ å¿…é¡»æ¯æ¬¡éƒ½é€’å¢ï¼
  }

  // æ›´æ–°æ•Œæœº
  i = 0
  while i < 6 {
    if self.enemies[i].update() {
      // æ£€æŸ¥å­å¼¹å‘½ä¸­
      let mut j = 0
      while j < 8 {
          if self.bullets[j].active {
              if self.enemies[i].collide_with(
                  self.bullets[j].x, self.bullets[j].y, 2, 4
              ) {
                  self.bullets[j].active = false
                  self.enemies[i].active = false
                  self.score = self.score + 10
                  break
              }
          }
          j = j + 1
      }

      // æ£€æŸ¥ç©å®¶ç¢°æ’
      if self.enemies[i].collide_with(self.player.x, self.player.y, 8, 8) {
          self.game_over = true
      }
    }
    i = i + 1
  }
}

pub fn spawn_enemy(self: Game) -> Unit {
  let mut i = 0
  while i < 6 {
    if !self.enemies[i].active {
      // è¿™é‡Œéœ€è¦åŠ å…¥éšæœºåŒ–
      let rand_x = (self.frame_count * 17) % 152
      self.enemies[i].spawn(rand_x)
      break
    }
    i = i + 1
  }
}

pub fn draw_ui(self: Game) -> Unit{
    @wasm4.text("SCORE:", 5, 5)
    @wasm4.text(self.score.to_string(), 60, 5)
}

pub fn reset(self: Game) -> Unit{
  self.player = Player::new()
  self.score = 0
  self.game_over = false
  self.frame_count = 0

  let mut i = 0
  while i < 8 {
      self.bullets[i] = Bullet::new()
      i = i + 1
  }
  i = 0
  while i < 6 {
      self.enemies[i] = Enemy::new()
      i = i + 1
  }
}
