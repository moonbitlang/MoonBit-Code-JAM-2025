import{r as W,j as Z,n as oe,m as R,s as z,t as se,u as ce,v as de,w as ue,x as pe,y as fe,z as me,A as he,B as Q}from"./cs-BJ-F0Je_.js";const U="application/x-logic-tool",S="application/x-logic-cell",Y=[{id:"player",label:"玩家",description:"将 λ 放置在网格上"},{id:"goal",label:"Goal",description:"放置一个命题目标"},{id:"wall",label:"Wall",description:"添加不可移动方块"},{id:"prop",label:"Prop",description:"原子命题块"},{id:"implication",label:"→",description:"蕴涵块 A→B"},{id:"and",label:"∧",description:"合取块 A∧B"},{id:"pi1",label:"π₁",description:"Eliminator π₁"},{id:"pi2",label:"π₂",description:"Eliminator π₂"},{id:"neg",label:"¬",description:"否定块"},{id:"erase",label:"删除",description:"清除该格的内容"}],N=document.getElementById("editor-root");if(!N)throw new Error("Editor root element not found");let a=ee(),$=1,s=null;const M=[],ye=50,O=document.createElement("div");O.className="status-line";const L=document.createElement("div");L.className="editor-grid editor-panel";const I=document.createElement("div");I.className="toolbar";const _=document.createElement("textarea");_.placeholder="粘贴 Level JSON...";const B=document.createElement("textarea");B.readOnly=!0;const E={};function w(e){return new Promise(t=>{const n=document.createElement("div");n.className="modal-overlay";const i=document.createElement("div");i.className="modal-panel";const o=document.createElement("h3");if(o.textContent=e.title,i.appendChild(o),e.description){const f=document.createElement("p");f.textContent=e.description,i.appendChild(f)}const d=document.createElement("form");d.className="modal-form";const l={};e.fields.forEach((f,m)=>{const h=document.createElement("label");h.textContent=f.label;const g=document.createElement("input");g.type=f.type??"text",g.name=f.name,g.placeholder=f.placeholder??"",f.defaultValue!==void 0&&(g.value=f.defaultValue),(m===0||f.autofocus)&&requestAnimationFrame(()=>g.focus()),l[f.name]=g,h.appendChild(g),d.appendChild(h)});const r=document.createElement("div");r.className="modal-actions";const u=document.createElement("button");u.type="button",u.className="secondary",u.textContent=e.cancelLabel??"取消";const p=document.createElement("button");p.type="submit",p.textContent=e.confirmLabel??"确定",r.appendChild(u),r.appendChild(p),d.appendChild(r),i.appendChild(d),n.appendChild(i);const x=f=>{f.key==="Escape"&&(f.preventDefault(),b(null))};document.addEventListener("keydown",x);function b(f){document.removeEventListener("keydown",x),document.body.removeChild(n),t(f)}u.addEventListener("click",()=>b(null)),n.addEventListener("click",f=>{f.target===n&&b(null)}),d.addEventListener("submit",f=>{f.preventDefault();const m={};e.fields.forEach(h=>{m[h.name]=l[h.name].value}),b(m)}),document.body.appendChild(n)})}function ee(){return{info:{id:1e3,name:"新关卡",description:"在此输入关卡描述 / 提示",gridWidth:6,gridHeight:6,cellSize:48},player:{x:0,y:0},boxes:[],goals:[]}}function V(e){return e.reduce((t,n)=>Math.max(t,n.id),0)+1}function G(e){const t=W(e),n=Z(t);if(!n||n.$tag===0)throw new Error("无法克隆 Level 数据");return n._0}function J(){const{gridWidth:e,gridHeight:t}=a.info;a.player.x=Math.min(Math.max(a.player.x,0),e-1),a.player.y=Math.min(Math.max(a.player.y,0),t-1),a.boxes=a.boxes.filter(n=>n.pos.x>=0&&n.pos.x<e&&n.pos.y>=0&&n.pos.y<t),a.goals=a.goals.filter(n=>n.pos.x>=0&&n.pos.x<e&&n.pos.y>=0&&n.pos.y<t)}function te(e){a=G(e),J(),$=V(a.boxes),le(),re(),y(),c("已加载关卡")}function c(e,t=!1){O.textContent=e,O.style.color=t?"#ff7b7b":"#8fe8ff"}function C(){M.push(G(a)),M.length>ye&&M.shift()}function be(){const e=M.pop();if(!e){c("没有可撤销的操作");return}a=G(e),J(),$=V(a.boxes),y(),c("已撤销上一次编辑")}function A(e,t){return a.boxes.find(n=>n.pos.x===e&&n.pos.y===t)}function k(e,t){return a.goals.find(n=>n.pos.x===e&&n.pos.y===t)}function ge(e,t){a.boxes=a.boxes.filter(n=>!(n.pos.x===e&&n.pos.y===t)),a.goals=a.goals.filter(n=>!(n.pos.x===e&&n.pos.y===t)),a.player.x===e&&a.player.y===t&&(a.player={x:0,y:0})}async function j(e,t,n){var r,u,p,x,b,f;if(e==="erase"){if(!A(t,n)&&!k(t,n)&&!(a.player.x===t&&a.player.y===n)){v(t,n);return}C(),ge(t,n),v(t,n),y();return}if(e==="player"){if(a.player.x===t&&a.player.y===n){v(t,n);return}C(),a.player={x:t,y:n},v(t,n),y();return}if(e==="goal"){const m=k(t,n),h=await P({title:"Goal 目标",description:"输入逻辑表达式，例如 A & B、A -> !B、fst (A & B)",defaultValue:m?z(m.prop):"A",confirmLabel:"保存 Goal"});if(!h||h.$tag===0)return;C(),a.goals=a.goals.filter(g=>!(g.pos.x===t&&g.pos.y===n)),a.goals.push({pos:{x:t,y:n},prop:h._0}),v(t,n),y();return}const i=A(t,n),o=i?i.id:$;let d=!i,l=null;switch(e){case"wall":l=Q(o,t,n);break;case"prop":{const m=await Be({title:"命题块",description:"输入命题名称，例如 A、Goal、tmp1",label:"命题名称",placeholder:"A",defaultValue:"A",confirmLabel:"放置命题"});if(!m)return;l=he(o,t,n,m);break}case"implication":{const m=await w({title:"蕴涵块",description:"填写前件与后件，例如：前件 A，后件 B",confirmLabel:"放置蕴涵",fields:[{name:"premise",label:"前件",placeholder:"A",defaultValue:"A",autofocus:!0},{name:"conclusion",label:"后件",placeholder:"B",defaultValue:"B"}]});if(!m)return;const h=(r=m.premise)==null?void 0:r.trim(),g=(u=m.conclusion)==null?void 0:u.trim();if(!h||!g){c("请输入前件与后件",!0);return}l=me(o,t,n,h,g);break}case"and":{const m=await w({title:"合取块",description:"填写左右命题，例如：左侧 A，右侧 B",confirmLabel:"放置合取",fields:[{name:"left",label:"左侧命题",placeholder:"A",defaultValue:"A",autofocus:!0},{name:"right",label:"右侧命题",placeholder:"B",defaultValue:"B"}]});if(!m)return;const h=(p=m.left)==null?void 0:p.trim(),g=(x=m.right)==null?void 0:x.trim();if(!h||!g){c("请输入左右命题",!0);return}l=fe(o,t,n,h,g);break}case"pi1":l=pe(o,t,n);break;case"pi2":l=ue(o,t,n);break;case"neg":{const m=await w({title:"否定块",description:"可选输入被否定命题，留空表示通用否定",confirmLabel:"放置否定",fields:[{name:"inner",label:"被否定的命题（可选）",placeholder:"例如 A",defaultValue:"",autofocus:!0}]});if(!m)return;const h=(b=m.inner)==null?void 0:b.trim();l=h?ce(o,t,n,h):de(o,t,n);break}}l&&(C(),a.boxes=a.boxes.filter(m=>!(m.pos.x===t&&m.pos.y===n)),a.boxes.push(l),d?$=o+1:$=V(a.boxes),v(t,n),c(`放置 ${((f=Y.find(m=>m.id===e))==null?void 0:f.label)??"元素"}`),y())}async function ne(e,t){const n=A(e,t);if(!n)return!1;const i=await P({title:"编辑方块 Kind",description:"输入逻辑表达式，例如 A -> B、!(A & B)、fst (A & B)",defaultValue:z(n.kind),confirmLabel:"保存方块"});return!i||i.$tag===0?!1:(C(),n.kind=i._0,!0)}async function ae(e,t){const n=k(e,t);if(!n)return!1;const i=await P({title:"编辑 Goal",description:"输入逻辑表达式，例如 A、A & B、!fst X",defaultValue:z(n.prop),confirmLabel:"保存 Goal"});return!i||i.$tag===0?!1:(C(),n.prop=i._0,!0)}function Ee(){const e=Math.max(a.info.cellSize,32);L.style.setProperty("--cell-size",`${e}px`),L.style.gridTemplateColumns=`repeat(${a.info.gridWidth}, ${e}px)`,L.innerHTML="";for(let t=0;t<a.info.gridHeight;t++)for(let n=0;n<a.info.gridWidth;n++){const i=document.createElement("div");i.className="editor-cell",i.dataset.x=String(n),i.dataset.y=String(t),i.addEventListener("dragover",l=>{l.preventDefault()}),i.addEventListener("drop",l=>{var x,b;l.preventDefault();const r=(x=l.dataTransfer)==null?void 0:x.getData(S);if(r){Oe(JSON.parse(r),n,t);return}const u=(b=l.dataTransfer)==null?void 0:b.getData(U);if(!u)return;j(u,n,t)}),i.addEventListener("click",()=>{v(n,t)}),i.addEventListener("dblclick",()=>{(async()=>(v(n,t),A(n,t)?await ne(n,t)&&(y(),c("已更新方块 Kind")):k(n,t)?await ae(n,t)&&(y(),c("已更新 Goal")):await j("player",n,t)))()});const o=A(n,t);if(o){const l=oe(o.kind,a.info.cellSize),r=document.createElement("div");r.className="editor-box",r.style.background=F(l.fillColor),r.style.border=`2px solid ${F(l.borderColor)}`;const u=typeof l.symbol=="string"?l.symbol:l.symbol===void 0||l.symbol===null?"":String(l.symbol);r.textContent=u.trim().length>0?u:R(o.kind),r.setAttribute("draggable","true"),r.addEventListener("dragstart",p=>{var x,b;(x=p.dataTransfer)==null||x.setData(S,JSON.stringify({type:"box",x:n,y:t})),(b=p.dataTransfer)==null||b.setDragImage(r,l.size/2,l.size/2)}),i.appendChild(r)}const d=k(n,t);if(d){const l=document.createElement("div");l.className="editor-goal",l.textContent=R(d.prop),l.setAttribute("draggable","true"),l.addEventListener("dragstart",r=>{var u,p;(u=r.dataTransfer)==null||u.setData(S,JSON.stringify({type:"goal",x:n,y:t})),(p=r.dataTransfer)==null||p.setDragImage(l,l.clientWidth/2,l.clientHeight/2)}),i.appendChild(l)}if(a.player.x===n&&a.player.y===t){const l=document.createElement("div");l.className="editor-player",l.textContent="λ",l.setAttribute("draggable","true"),l.addEventListener("dragstart",r=>{var u,p;(u=r.dataTransfer)==null||u.setData(S,JSON.stringify({type:"player",x:n,y:t})),(p=r.dataTransfer)==null||p.setDragImage(l,10,10)}),i.appendChild(l)}s&&s.x===n&&s.y===t&&i.classList.add("selected"),L.appendChild(i)}X()}function F(e){return`#${(e>>>0).toString(16).padStart(6,"0")}`}function Ce(){I.innerHTML="";const e=document.createElement("div");e.className="editor-panel";const t=document.createElement("h2");t.textContent="工具箱 (拖动到网格)",e.appendChild(t);const n=document.createElement("div");n.className="toolbar-list",Y.forEach(i=>{const o=document.createElement("div");o.className="tool-item",o.setAttribute("draggable","true"),o.addEventListener("dragstart",r=>{var u,p;(u=r.dataTransfer)==null||u.setData(U,i.id),(p=r.dataTransfer)==null||p.setDragImage(o,20,10)}),o.addEventListener("click",()=>{c(`选择工具：${i.label}`)});const d=document.createElement("strong");d.textContent=i.label;const l=document.createElement("span");l.textContent=i.description,o.appendChild(d),o.appendChild(l),n.appendChild(o)}),e.appendChild(n),I.appendChild(e)}function xe(){const e=document.createElement("div");e.className="editor-panel";const t=document.createElement("h2");return t.textContent="结构工具",e.appendChild(t),[[{label:"左侧插入列",handler:()=>K("left")},{label:"右侧插入列",handler:()=>K("right")}],[{label:"上方插入行",handler:()=>q("up")},{label:"下方插入行",handler:()=>q("down")}],[{label:"删除选中行",handler:_e,tone:"secondary"},{label:"删除选中列",handler:Me,tone:"secondary"}]].forEach(i=>{const o=document.createElement("div");o.className="button-row",i.forEach(d=>{const l=document.createElement("button");l.type="button",l.textContent=d.label,d.tone==="secondary"&&l.classList.add("secondary"),l.addEventListener("click",d.handler),o.appendChild(l)}),e.appendChild(o)}),e}function ve(){const e=document.createElement("div");e.className="editor-panel";const t=document.createElement("h2");t.textContent="关卡信息",e.appendChild(t);const n=document.createElement("form");n.className="meta-grid",[{label:"ID",key:"id"},{label:"名称",key:"name"},{label:"宽度",key:"gridWidth"},{label:"高度",key:"gridHeight"},{label:"Cell Size",key:"cellSize"}].forEach(r=>{const u=document.createElement("label");u.textContent=r.label;const p=document.createElement("input");p.name=r.key,p.value=String(a.info[r.key]),r.key!=="name"&&(p.type="number",p.min="1"),E[r.key]=p,u.appendChild(p),n.appendChild(u)});const o=document.createElement("div");o.className="button-row";const d=document.createElement("button");d.type="submit",d.textContent="应用";const l=document.createElement("button");return l.type="button",l.className="secondary",l.textContent="新建",o.appendChild(d),o.appendChild(l),n.appendChild(o),e.appendChild(n),n.addEventListener("submit",r=>{var u,p,x,b,f;r.preventDefault(),C(),a.info={id:Number((u=E.id)==null?void 0:u.value)||a.info.id,name:((p=E.name)==null?void 0:p.value)||a.info.name,description:a.info.description||"",gridWidth:Math.max(1,Number((x=E.gridWidth)==null?void 0:x.value)||a.info.gridWidth),gridHeight:Math.max(1,Number((b=E.gridHeight)==null?void 0:b.value)||a.info.gridHeight),cellSize:Math.max(20,Number((f=E.cellSize)==null?void 0:f.value)||a.info.cellSize)},J(),y(),c("已更新关卡信息")}),l.addEventListener("click",()=>{te(ee())}),e}function Ae(){const e=document.createElement("div");e.className="editor-panel";const t=document.createElement("h2");t.textContent="导入 / 导出 JSON",e.appendChild(t);const n=document.createElement("label");n.textContent="粘贴 JSON 并加载",e.appendChild(n),e.appendChild(_);const i=document.createElement("div");i.className="button-row";const o=document.createElement("button");o.type="button",o.textContent="加载 JSON";const d=document.createElement("button");d.type="button",d.textContent="导出 JSON",i.appendChild(o),i.appendChild(d),e.appendChild(i);const l=document.createElement("label");return l.textContent="导出结果",e.appendChild(l),e.appendChild(B),o.addEventListener("click",()=>{try{if(!_.value.trim()){c("请输入 JSON 字符串",!0);return}const r=Z(_.value);if(!r||r.$tag===0)throw new Error("无效的 Level JSON");te(r._0),le()}catch(r){console.error(r),c("加载 JSON 失败，请检查格式",!0)}}),d.addEventListener("click",()=>{var r;try{const u=W(a);B.value=u,(r=navigator.clipboard)==null||r.writeText(u).catch(()=>{}),c("已导出 JSON，并复制到剪贴板")}catch(u){console.error(u),c("导出失败",!0)}}),e}function y(){re(),Ee(),B.value=W(a)}function re(){E.id&&(E.id.value=String(a.info.id),E.name&&(E.name.value=a.info.name),E.gridWidth&&(E.gridWidth.value=String(a.info.gridWidth)),E.gridHeight&&(E.gridHeight.value=String(a.info.gridHeight)),E.cellSize&&(E.cellSize.value=String(a.info.cellSize)))}function v(e,t){s={x:e,y:t},X()}function le(){s=null,X()}function X(){L.querySelectorAll(".editor-cell").forEach(t=>{const n=Number(t.getAttribute("data-x")),i=Number(t.getAttribute("data-y")),o=s&&s.x===n&&s.y===i;t.classList.toggle("selected",!!o)})}function T(){return s||(c("请先选中一个格子",!0),null)}function D(){if(!s)return;const e=a.info.gridWidth-1,t=a.info.gridHeight-1;if(e<0||t<0){s=null;return}const n=Math.min(Math.max(s.x,0),e),i=Math.min(Math.max(s.y,0),t);s={x:n,y:i}}function ke(){if(!s){c("请选择要删除的节点",!0);return}const{x:e,y:t}=s,n=A(e,t),i=k(e,t),o=a.player.x===e&&a.player.y===t;if(!n&&!i&&!o){c("该格没有可删除的节点",!0);return}n?a.boxes=a.boxes.filter(d=>!(d.pos.x===e&&d.pos.y===t)):i?a.goals=a.goals.filter(d=>!(d.pos.x===e&&d.pos.y===t)):o&&(a.player={x:0,y:0}),C(),y(),c("已删除选中节点")}async function Le(){if(!s){c("请选择要编辑的节点",!0);return}const{x:e,y:t}=s;if(A(e,t)){await ne(e,t)&&(y(),c("已编辑选中的方块"));return}if(k(e,t)){await ae(e,t)&&(y(),c("已编辑选中的 Goal"));return}c("该格没有可编辑的节点",!0)}function H(e,t,n,i){const o=r=>i==="insert"?r>=t?r+n:r:r>t?r-n:r,d=i==="delete"?r=>r!==t:()=>!0;a.boxes=a.boxes.filter(r=>d(r.pos[e])).map(r=>o(r.pos[e])===r.pos[e]?r:{...r,pos:{...r.pos,[e]:o(r.pos[e])}}),a.goals=a.goals.filter(r=>d(r.pos[e])).map(r=>o(r.pos[e])===r.pos[e]?r:{...r,pos:{...r.pos,[e]:o(r.pos[e])}});const l=a.player[e];i==="insert"?l>=t&&(a.player={...a.player,[e]:l+n}):l===t?a.player={...a.player,[e]:Math.max(0,l-1)}:l>t&&(a.player={...a.player,[e]:l-n})}function $e(e){return e<0||e>a.info.gridWidth?(c("无法在该位置插入列",!0),!1):(C(),H("x",e,1,"insert"),a.info.gridWidth+=1,s&&s.x>=e&&(s={x:s.x+1,y:s.y}),D(),y(),!0)}function we(e){return e<0||e>a.info.gridHeight?(c("无法在该位置插入行",!0),!1):(C(),H("y",e,1,"insert"),a.info.gridHeight+=1,s&&s.y>=e&&(s={x:s.x,y:s.y+1}),D(),y(),!0)}function Se(e){return a.info.gridWidth<=1?(c("无法再删除列",!0),!1):(C(),H("x",e,1,"delete"),a.info.gridWidth-=1,s&&(s.x>e?s={x:s.x-1,y:s.y}:s.x===e&&(s={x:Math.min(s.x,a.info.gridWidth-1),y:s.y})),D(),y(),!0)}function Ne(e){return a.info.gridHeight<=1?(c("无法再删除行",!0),!1):(C(),H("y",e,1,"delete"),a.info.gridHeight-=1,s&&(s.y>e?s={x:s.x,y:s.y-1}:s.y===e&&(s={x:s.x,y:Math.min(s.y,a.info.gridHeight-1)})),D(),y(),!0)}function K(e){const t=T();if(!t)return;const n=e==="left"?t.x:t.x+1;$e(n)&&c(e==="left"?"已在选中格子左侧新增一列":"已在选中格子右侧新增一列")}function q(e){const t=T();if(!t)return;const n=e==="up"?t.y:t.y+1;we(n)&&c(e==="up"?"已在选中格子上方新增一行":"已在选中格子下方新增一行")}function Me(){const e=T();e&&Se(e.x)&&c("已删除选中列")}function _e(){const e=T();e&&Ne(e.y)&&c("已删除选中行")}function ie(e,t){return!A(e,t)&&!k(e,t)&&!(a.player.x===e&&a.player.y===t)}function Oe(e,t,n){if(e.x===t&&e.y===n){v(t,n);return}if(!ie(t,n)){c("目标格已有内容，无法移动",!0);return}switch(e.type){case"box":{const i=A(e.x,e.y);if(!i){c("未找到该方块",!0);return}C(),i.pos={x:t,y:n};break}case"goal":{const i=k(e.x,e.y);if(!i){c("未找到该 Goal",!0);return}C(),i.pos={x:t,y:n};break}case"player":C(),a.player={x:t,y:n};break;default:c("无法移动该类型",!0);return}v(t,n),y(),c("已移动节点")}function Ie(){if(!s){c("请先选择一个网格",!0);return}const{x:e,y:t}=s;if(!ie(e,t)){c("该网格已有内容，无法放置 Wall",!0);return}C();const n=Q($++,e,t);a.boxes.push(n),c("已添加 Wall"),y()}async function Be(e){var n;let t=e.defaultValue??"";for(;;){const i=await w({title:e.title,description:e.description,confirmLabel:e.confirmLabel,fields:[{name:"value",label:e.label,placeholder:e.placeholder,defaultValue:t,autofocus:!0}]});if(!i)return null;const o=((n=i.value)==null?void 0:n.trim())??"";if(!o&&!e.allowEmpty){c("请输入内容",!0),t="";continue}return o}}async function P(e){var n;let t=e.defaultValue??"";for(;;){const i=await w({title:e.title,description:e.description??"语法：使用 !、&、->、fst、snd 以及括号组合命题",confirmLabel:e.confirmLabel??"确定",fields:[{name:"expression",label:"逻辑表达式",placeholder:"例如 A -> (B & !C)",defaultValue:t,autofocus:!0}]});if(!i)return null;const o=((n=i.expression)==null?void 0:n.trim())??"";if(!o){c("请输入逻辑表达式",!0),t="";continue}try{return se(o)}catch(d){console.error(d),c("解析失败，请检查语法",!0),t=o}}}function Te(e){return e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||(e==null?void 0:e.isContentEditable)}window.addEventListener("keydown",e=>{if(!Te(document.activeElement)){if(e.key==="z"||e.key==="Z"){e.preventDefault(),be();return}if(e.key==="d"||e.key==="D"){e.preventDefault(),ke();return}if(e.key==="e"||e.key==="E"){e.preventDefault(),Le();return}(e.key==="w"||e.key==="W")&&(e.preventDefault(),Ie())}});function De(){const e=document.createElement("div");e.className="editor-layout";const t=document.createElement("div");t.className="editor-left";const n=ve(),i=xe(),o=Ae();t.appendChild(n),t.appendChild(i),t.appendChild(L),t.appendChild(o),t.appendChild(O),Ce(),e.appendChild(t),e.appendChild(I),N==null||N.appendChild(e),y()}De();
