import{r as H,i as Z,s as oe,n as R,t as z,u as se,v as ce,w as de,x as ue,y as pe,z as fe,A as me,B as he,D as Q}from"./utils-DDgWolnZ.js";const U="application/x-logic-tool",S="application/x-logic-cell",Y=[{id:"player",label:"玩家",description:"将 λ 放置在网格上"},{id:"goal",label:"Goal",description:"放置一个命题目标"},{id:"wall",label:"Wall",description:"添加不可移动方块"},{id:"prop",label:"Prop",description:"原子命题块"},{id:"implication",label:"→",description:"蕴涵块 A→B"},{id:"and",label:"∧",description:"合取块 A∧B"},{id:"pi1",label:"π₁",description:"Eliminator π₁"},{id:"pi2",label:"π₂",description:"Eliminator π₂"},{id:"neg",label:"¬",description:"否定块"}],$=document.getElementById("editor-root");if(!$)throw new Error("Editor root element not found");let a=ee(),w=1,s=null;const M=[],ye=50,O=document.createElement("div");O.className="status-line";const L=document.createElement("div");L.className="editor-grid editor-panel";const _=document.createElement("div");_.className="toolbar";const B=document.createElement("textarea");B.placeholder="粘贴 Level JSON...";const I=document.createElement("textarea");I.readOnly=!0;const y={};function N(e){return new Promise(t=>{const n=document.createElement("div");n.className="modal-overlay";const i=document.createElement("div");i.className="modal-panel";const o=document.createElement("h3");if(o.textContent=e.title,i.appendChild(o),e.description){const m=document.createElement("p");m.textContent=e.description,i.appendChild(m)}const c=document.createElement("form");c.className="modal-form";const l={};e.fields.forEach((m,f)=>{const h=document.createElement("label");h.textContent=m.label;const C=document.createElement("input");C.type=m.type??"text",C.name=m.name,C.placeholder=m.placeholder??"",m.defaultValue!==void 0&&(C.value=m.defaultValue),(f===0||m.autofocus)&&requestAnimationFrame(()=>C.focus()),l[m.name]=C,h.appendChild(C),c.appendChild(h)});const r=document.createElement("div");r.className="modal-actions";const u=document.createElement("button");u.type="button",u.className="secondary",u.textContent=e.cancelLabel??"取消";const p=document.createElement("button");p.type="submit",p.textContent=e.confirmLabel??"确定",r.appendChild(u),r.appendChild(p),c.appendChild(r),i.appendChild(c),n.appendChild(i);const x=m=>{m.key==="Escape"&&(m.preventDefault(),g(null))};document.addEventListener("keydown",x);function g(m){document.removeEventListener("keydown",x),document.body.removeChild(n),t(m)}u.addEventListener("click",()=>g(null)),n.addEventListener("click",m=>{m.target===n&&g(null)}),c.addEventListener("submit",m=>{m.preventDefault();const f={};e.fields.forEach(h=>{f[h.name]=l[h.name].value}),g(f)}),document.body.appendChild(n)})}function ee(){return{info:{id:1e3,name:"新关卡",description:"",gridWidth:6,gridHeight:6,cellSize:48},player:{x:0,y:0},boxes:[],goals:[]}}function V(e){return e.reduce((t,n)=>Math.max(t,n.id),0)+1}function G(e){const t=H(e),n=Z(t);if(!n||n.$tag===0)throw new Error("无法克隆 Level 数据");return n._0}function J(){const{gridWidth:e,gridHeight:t}=a.info;a.player.x=Math.min(Math.max(a.player.x,0),e-1),a.player.y=Math.min(Math.max(a.player.y,0),t-1),a.boxes=a.boxes.filter(n=>n.pos.x>=0&&n.pos.x<e&&n.pos.y>=0&&n.pos.y<t),a.goals=a.goals.filter(n=>n.pos.x>=0&&n.pos.x<e&&n.pos.y>=0&&n.pos.y<t)}function te(e){a=G(e),J(),w=V(a.boxes),le(),re(),b(),d("已加载关卡")}function d(e,t=!1){O.textContent=e,O.style.color=t?"#ff7b7b":"#8fe8ff"}function E(){M.push(G(a)),M.length>ye&&M.shift()}function be(){const e=M.pop();if(!e){d("没有可撤销的操作");return}a=G(e),J(),w=V(a.boxes),b(),d("已撤销上一次编辑")}function k(e,t){return a.boxes.find(n=>n.pos.x===e&&n.pos.y===t)}function A(e,t){return a.goals.find(n=>n.pos.x===e&&n.pos.y===t)}function ge(e,t){a.boxes=a.boxes.filter(n=>!(n.pos.x===e&&n.pos.y===t)),a.goals=a.goals.filter(n=>!(n.pos.x===e&&n.pos.y===t)),a.player.x===e&&a.player.y===t&&(a.player={x:0,y:0})}async function F(e,t,n){var r,u,p,x,g,m;if(e==="erase"){if(!k(t,n)&&!A(t,n)&&!(a.player.x===t&&a.player.y===n)){v(t,n);return}E(),ge(t,n),v(t,n),b();return}if(e==="player"){if(a.player.x===t&&a.player.y===n){v(t,n);return}E(),a.player={x:t,y:n},v(t,n),b();return}if(e==="goal"){const f=A(t,n),h=await X({title:"Goal 目标",description:"输入逻辑表达式，例如 A & B、A -> !B、fst (A & B)",defaultValue:f?z(f.prop):"A",confirmLabel:"保存 Goal"});if(!h||h.$tag===0)return;E(),a.goals=a.goals.filter(C=>!(C.pos.x===t&&C.pos.y===n)),a.goals.push({pos:{x:t,y:n},prop:h._0}),v(t,n),b();return}const i=k(t,n),o=i?i.id:w;let c=!i,l=null;switch(e){case"wall":l=Q(o,t,n);break;case"prop":{const f=await De({title:"命题块",description:"输入命题名称，例如 A、Goal、tmp1",label:"命题名称",placeholder:"A",defaultValue:"A",confirmLabel:"放置命题"});if(!f)return;l=he(o,t,n,f);break}case"implication":{const f=await N({title:"蕴涵块",description:"填写前件与后件，例如：前件 A，后件 B",confirmLabel:"放置蕴涵",fields:[{name:"premise",label:"前件",placeholder:"A",defaultValue:"A",autofocus:!0},{name:"conclusion",label:"后件",placeholder:"B",defaultValue:"B"}]});if(!f)return;const h=(r=f.premise)==null?void 0:r.trim(),C=(u=f.conclusion)==null?void 0:u.trim();if(!h||!C){d("请输入前件与后件",!0);return}l=me(o,t,n,h,C);break}case"and":{const f=await N({title:"合取块",description:"填写左右命题，例如：左侧 A，右侧 B",confirmLabel:"放置合取",fields:[{name:"left",label:"左侧命题",placeholder:"A",defaultValue:"A",autofocus:!0},{name:"right",label:"右侧命题",placeholder:"B",defaultValue:"B"}]});if(!f)return;const h=(p=f.left)==null?void 0:p.trim(),C=(x=f.right)==null?void 0:x.trim();if(!h||!C){d("请输入左右命题",!0);return}l=fe(o,t,n,h,C);break}case"pi1":l=pe(o,t,n);break;case"pi2":l=ue(o,t,n);break;case"neg":{const f=await N({title:"否定块",description:"可选输入被否定命题，留空表示通用否定",confirmLabel:"放置否定",fields:[{name:"inner",label:"被否定的命题（可选）",placeholder:"例如 A",defaultValue:"",autofocus:!0}]});if(!f)return;const h=(g=f.inner)==null?void 0:g.trim();l=h?ce(o,t,n,h):de(o,t,n);break}}l&&(E(),a.boxes=a.boxes.filter(f=>!(f.pos.x===t&&f.pos.y===n)),a.boxes.push(l),c?w=o+1:w=V(a.boxes),v(t,n),d(`放置 ${((m=Y.find(f=>f.id===e))==null?void 0:m.label)??"元素"}`),b())}async function ne(e,t){const n=k(e,t);if(!n)return!1;const i=await X({title:"编辑方块 Kind",description:"输入逻辑表达式，例如 A -> B、!(A & B)、fst (A & B)",defaultValue:z(n.kind),confirmLabel:"保存方块"});return!i||i.$tag===0?!1:(E(),n.kind=i._0,!0)}async function ae(e,t){const n=A(e,t);if(!n)return!1;const i=await X({title:"编辑 Goal",description:"输入逻辑表达式，例如 A、A & B、!fst X",defaultValue:z(n.prop),confirmLabel:"保存 Goal"});return!i||i.$tag===0?!1:(E(),n.prop=i._0,!0)}function Ce(){const e=Math.max(a.info.cellSize,32);L.style.setProperty("--cell-size",`${e}px`),L.style.gridTemplateColumns=`repeat(${a.info.gridWidth}, ${e}px)`,L.innerHTML="";for(let t=0;t<a.info.gridHeight;t++)for(let n=0;n<a.info.gridWidth;n++){const i=document.createElement("div");i.className="editor-cell",i.dataset.x=String(n),i.dataset.y=String(t),i.addEventListener("dragover",l=>{l.preventDefault()}),i.addEventListener("drop",l=>{var x,g;l.preventDefault();const r=(x=l.dataTransfer)==null?void 0:x.getData(S);if(r){_e(JSON.parse(r),n,t);return}const u=(g=l.dataTransfer)==null?void 0:g.getData(U);if(!u)return;F(u,n,t)}),i.addEventListener("click",()=>{v(n,t)}),i.addEventListener("dblclick",()=>{(async()=>(v(n,t),k(n,t)?await ne(n,t)&&(b(),d("已更新方块 Kind")):A(n,t)?await ae(n,t)&&(b(),d("已更新 Goal")):await F("player",n,t)))()});const o=k(n,t);if(o){const l=oe(o.kind);l.borderWidth=2,l.size=a.info.cellSize;const r=document.createElement("div");r.className="editor-box",r.style.background=K(l.fillColor),r.style.border=`2px solid ${K(l.borderColor)}`;const u=typeof l.symbol=="string"?l.symbol:l.symbol===void 0||l.symbol===null?"":String(l.symbol);r.textContent=u.trim().length>0?u:R(o.kind),r.setAttribute("draggable","true"),r.addEventListener("dragstart",p=>{var x,g;(x=p.dataTransfer)==null||x.setData(S,JSON.stringify({type:"box",x:n,y:t})),(g=p.dataTransfer)==null||g.setDragImage(r,l.size/2,l.size/2)}),i.appendChild(r)}const c=A(n,t);if(c){const l=document.createElement("div");l.className="editor-goal",l.textContent=R(c.prop),l.setAttribute("draggable","true"),l.addEventListener("dragstart",r=>{var u,p;(u=r.dataTransfer)==null||u.setData(S,JSON.stringify({type:"goal",x:n,y:t})),(p=r.dataTransfer)==null||p.setDragImage(l,l.clientWidth/2,l.clientHeight/2)}),i.appendChild(l)}if(a.player.x===n&&a.player.y===t){const l=document.createElement("div");l.className="editor-player",l.textContent="λ",l.setAttribute("draggable","true"),l.addEventListener("dragstart",r=>{var u,p;(u=r.dataTransfer)==null||u.setData(S,JSON.stringify({type:"player",x:n,y:t})),(p=r.dataTransfer)==null||p.setDragImage(l,10,10)}),i.appendChild(l)}s&&s.x===n&&s.y===t&&i.classList.add("selected"),L.appendChild(i)}P()}function K(e){return`#${(e>>>0).toString(16).padStart(6,"0")}`}function Ee(){_.innerHTML="";const e=document.createElement("div");e.className="editor-panel";const t=document.createElement("h2");t.textContent="工具箱 (拖动到网格)",e.appendChild(t);const n=document.createElement("div");n.className="toolbar-list",Y.forEach(i=>{const o=document.createElement("div");o.className="tool-item",o.setAttribute("draggable","true"),o.addEventListener("dragstart",r=>{var u,p;(u=r.dataTransfer)==null||u.setData(U,i.id),(p=r.dataTransfer)==null||p.setDragImage(o,20,10)}),o.addEventListener("click",()=>{d(`选择工具：${i.label}`)});const c=document.createElement("strong");c.textContent=i.label;const l=document.createElement("span");l.textContent=i.description,o.appendChild(c),o.appendChild(l),n.appendChild(o)}),e.appendChild(n),_.appendChild(e)}function xe(){const e=document.createElement("div");e.className="editor-panel";const t=document.createElement("h2");t.textContent="快捷提示",e.appendChild(t);const n=document.createElement("ul");return n.className="shortcut-list",[{key:"W",text:"可以制造墙壁"},{key:"D",text:"快捷删除"},{key:"Z",text:"撤销上一次编辑"},{text:"双击 Box 可以编辑 Kind，使用经典的逻辑符号，例如 A & B, !A, A -> B, fst A, snd B"}].forEach(o=>{const c=document.createElement("li");if(o.key){const l=document.createElement("span");l.textContent="按下 ";const r=document.createElement("kbd");r.className="shortcut-key",r.textContent=o.key;const u=document.createElement("span");u.textContent=` ${o.text}`,c.appendChild(l),c.appendChild(r),c.appendChild(u)}else c.textContent=o.text;n.appendChild(c)}),e.appendChild(n),e}function ve(){const e=document.createElement("div");e.className="editor-panel";const t=document.createElement("h2");return t.textContent="结构工具",e.appendChild(t),[[{label:"左侧插入列",handler:()=>j("left")},{label:"右侧插入列",handler:()=>j("right")},{label:"上方插入行",handler:()=>q("up")},{label:"下方插入行",handler:()=>q("down")},{label:"删除选中行",handler:Oe,tone:"secondary"},{label:"删除选中列",handler:Be,tone:"secondary"}]].forEach(i=>{const o=document.createElement("div");o.className="button-row",i.forEach(c=>{const l=document.createElement("button");l.type="button",l.textContent=c.label,c.tone==="secondary"&&l.classList.add("secondary"),l.addEventListener("click",c.handler),o.appendChild(l)}),e.appendChild(o)}),e}function ke(){const e=document.createElement("div");e.className="editor-panel";const t=document.createElement("h2");t.textContent="关卡信息",e.appendChild(t);const n=document.createElement("form");n.className="meta-grid",[{label:"ID",key:"id"},{label:"名称",key:"name"},{label:"描述",key:"description"},{label:"宽度",key:"gridWidth"},{label:"高度",key:"gridHeight"},{label:"Cell Size",key:"cellSize"}].forEach(r=>{const u=document.createElement("label");u.textContent=r.label;const p=document.createElement("input");p.name=r.key,p.value=String(a.info[r.key]),r.key!=="name"&&(p.type="number",p.min="1"),y[r.key]=p,u.appendChild(p),n.appendChild(u)});const o=document.createElement("div");o.className="button-row";const c=document.createElement("button");c.type="submit",c.textContent="应用";const l=document.createElement("button");return l.type="button",l.className="secondary",l.textContent="新建",o.appendChild(c),o.appendChild(l),n.appendChild(o),e.appendChild(n),n.addEventListener("submit",r=>{var u,p,x,g,m,f;r.preventDefault(),E(),a.info={id:Number((u=y.id)==null?void 0:u.value)||a.info.id,name:((p=y.name)==null?void 0:p.value)||a.info.name,description:((x=y.description)==null?void 0:x.value)||a.info.description,gridWidth:Math.max(1,Number((g=y.gridWidth)==null?void 0:g.value)||a.info.gridWidth),gridHeight:Math.max(1,Number((m=y.gridHeight)==null?void 0:m.value)||a.info.gridHeight),cellSize:Math.max(20,Number((f=y.cellSize)==null?void 0:f.value)||a.info.cellSize)},J(),b(),d("已更新关卡信息")}),l.addEventListener("click",()=>{te(ee())}),e}function Ae(){const e=document.createElement("div");e.className="editor-panel";const t=document.createElement("h2");t.textContent="导入 / 导出 JSON",e.appendChild(t);const n=document.createElement("label");n.textContent="粘贴 JSON 并加载",e.appendChild(n),e.appendChild(B);const i=document.createElement("div");i.className="button-row";const o=document.createElement("button");o.type="button",o.textContent="加载 JSON";const c=document.createElement("button");c.type="button",c.textContent="导出 JSON",i.appendChild(o),i.appendChild(c),e.appendChild(i);const l=document.createElement("label");return l.textContent="导出结果",e.appendChild(l),e.appendChild(I),o.addEventListener("click",()=>{try{if(!B.value.trim()){d("请输入 JSON 字符串",!0);return}const r=Z(B.value);if(!r||r.$tag===0)throw new Error("无效的 Level JSON");te(r._0),le()}catch(r){console.error(r),d("加载 JSON 失败，请检查格式",!0)}}),c.addEventListener("click",()=>{var r;try{const u=H(a);I.value=u,(r=navigator.clipboard)==null||r.writeText(u).catch(()=>{}),d("已导出 JSON，并复制到剪贴板")}catch(u){console.error(u),d("导出失败",!0)}}),e}function b(){re(),Ce(),I.value=H(a)}function re(){y.id&&(y.id.value=String(a.info.id),y.name&&(y.name.value=a.info.name),y.gridWidth&&(y.gridWidth.value=String(a.info.gridWidth)),y.gridHeight&&(y.gridHeight.value=String(a.info.gridHeight)),y.cellSize&&(y.cellSize.value=String(a.info.cellSize)),y.description&&(y.description.value=a.info.description))}function v(e,t){s={x:e,y:t},P()}function le(){s=null,P()}function P(){L.querySelectorAll(".editor-cell").forEach(t=>{const n=Number(t.getAttribute("data-x")),i=Number(t.getAttribute("data-y")),o=s&&s.x===n&&s.y===i;t.classList.toggle("selected",!!o)})}function D(){return s||(d("请先选中一个格子",!0),null)}function T(){if(!s)return;const e=a.info.gridWidth-1,t=a.info.gridHeight-1;if(e<0||t<0){s=null;return}const n=Math.min(Math.max(s.x,0),e),i=Math.min(Math.max(s.y,0),t);s={x:n,y:i}}function Le(){if(!s){d("请选择要删除的节点",!0);return}const{x:e,y:t}=s,n=k(e,t),i=A(e,t),o=a.player.x===e&&a.player.y===t;if(!n&&!i&&!o){d("该格没有可删除的节点",!0);return}n?a.boxes=a.boxes.filter(c=>!(c.pos.x===e&&c.pos.y===t)):i?a.goals=a.goals.filter(c=>!(c.pos.x===e&&c.pos.y===t)):o&&(a.player={x:0,y:0}),E(),b(),d("已删除选中节点")}async function we(){if(!s){d("请选择要编辑的节点",!0);return}const{x:e,y:t}=s;if(k(e,t)){await ne(e,t)&&(b(),d("已编辑选中的方块"));return}if(A(e,t)){await ae(e,t)&&(b(),d("已编辑选中的 Goal"));return}d("该格没有可编辑的节点",!0)}function W(e,t,n,i){const o=r=>i==="insert"?r>=t?r+n:r:r>t?r-n:r,c=i==="delete"?r=>r!==t:()=>!0;a.boxes=a.boxes.filter(r=>c(r.pos[e])).map(r=>o(r.pos[e])===r.pos[e]?r:{...r,pos:{...r.pos,[e]:o(r.pos[e])}}),a.goals=a.goals.filter(r=>c(r.pos[e])).map(r=>o(r.pos[e])===r.pos[e]?r:{...r,pos:{...r.pos,[e]:o(r.pos[e])}});const l=a.player[e];i==="insert"?l>=t&&(a.player={...a.player,[e]:l+n}):l===t?a.player={...a.player,[e]:Math.max(0,l-1)}:l>t&&(a.player={...a.player,[e]:l-n})}function Ne(e){return e<0||e>a.info.gridWidth?(d("无法在该位置插入列",!0),!1):(E(),W("x",e,1,"insert"),a.info.gridWidth+=1,s&&s.x>=e&&(s={x:s.x+1,y:s.y}),T(),b(),!0)}function Se(e){return e<0||e>a.info.gridHeight?(d("无法在该位置插入行",!0),!1):(E(),W("y",e,1,"insert"),a.info.gridHeight+=1,s&&s.y>=e&&(s={x:s.x,y:s.y+1}),T(),b(),!0)}function $e(e){return a.info.gridWidth<=1?(d("无法再删除列",!0),!1):(E(),W("x",e,1,"delete"),a.info.gridWidth-=1,s&&(s.x>e?s={x:s.x-1,y:s.y}:s.x===e&&(s={x:Math.min(s.x,a.info.gridWidth-1),y:s.y})),T(),b(),!0)}function Me(e){return a.info.gridHeight<=1?(d("无法再删除行",!0),!1):(E(),W("y",e,1,"delete"),a.info.gridHeight-=1,s&&(s.y>e?s={x:s.x,y:s.y-1}:s.y===e&&(s={x:s.x,y:Math.min(s.y,a.info.gridHeight-1)})),T(),b(),!0)}function j(e){const t=D();if(!t)return;const n=e==="left"?t.x:t.x+1;Ne(n)&&d(e==="left"?"已在选中格子左侧新增一列":"已在选中格子右侧新增一列")}function q(e){const t=D();if(!t)return;const n=e==="up"?t.y:t.y+1;Se(n)&&d(e==="up"?"已在选中格子上方新增一行":"已在选中格子下方新增一行")}function Be(){const e=D();e&&$e(e.x)&&d("已删除选中列")}function Oe(){const e=D();e&&Me(e.y)&&d("已删除选中行")}function ie(e,t){return!k(e,t)&&!A(e,t)&&!(a.player.x===e&&a.player.y===t)}function _e(e,t,n){if(e.x===t&&e.y===n){v(t,n);return}if(!ie(t,n)){d("目标格已有内容，无法移动",!0);return}switch(e.type){case"box":{const i=k(e.x,e.y);if(!i){d("未找到该方块",!0);return}E(),i.pos={x:t,y:n};break}case"goal":{const i=A(e.x,e.y);if(!i){d("未找到该 Goal",!0);return}E(),i.pos={x:t,y:n};break}case"player":E(),a.player={x:t,y:n};break;default:d("无法移动该类型",!0);return}v(t,n),b(),d("已移动节点")}function Ie(){if(!s){d("请先选择一个网格",!0);return}const{x:e,y:t}=s;if(!ie(e,t)){d("该网格已有内容，无法放置 Wall",!0);return}E();const n=Q(w++,e,t);a.boxes.push(n),d("已添加 Wall"),b()}async function De(e){var n;let t=e.defaultValue??"";for(;;){const i=await N({title:e.title,description:e.description,confirmLabel:e.confirmLabel,fields:[{name:"value",label:e.label,placeholder:e.placeholder,defaultValue:t,autofocus:!0}]});if(!i)return null;const o=((n=i.value)==null?void 0:n.trim())??"";if(!o&&!e.allowEmpty){d("请输入内容",!0),t="";continue}return o}}async function X(e){var n;let t=e.defaultValue??"";for(;;){const i=await N({title:e.title,description:e.description??"语法：使用 !、&、->、fst、snd 以及括号组合命题",confirmLabel:e.confirmLabel??"确定",fields:[{name:"expression",label:"逻辑表达式",placeholder:"例如 A -> (B & !C)",defaultValue:t,autofocus:!0}]});if(!i)return null;const o=((n=i.expression)==null?void 0:n.trim())??"";if(!o){d("请输入逻辑表达式",!0),t="";continue}try{return se(o)}catch(c){console.error(c),d("解析失败，请检查语法",!0),t=o}}}function Te(e){return e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||(e==null?void 0:e.isContentEditable)}window.addEventListener("keydown",e=>{if(!Te(document.activeElement)){if(e.key==="z"||e.key==="Z"){e.preventDefault(),be();return}if(e.key==="d"||e.key==="D"){e.preventDefault(),Le();return}if(e.key==="e"||e.key==="E"){e.preventDefault(),we();return}(e.key==="w"||e.key==="W")&&(e.preventDefault(),Ie())}});function We(){const e=document.createElement("div");e.className="editor-layout";const t=document.createElement("div");t.className="editor-left";const n=ke(),i=ve(),o=xe(),c=Ae();t.appendChild(n),t.appendChild(i),t.appendChild(L),t.appendChild(o),t.appendChild(c),t.appendChild(O),Ee(),e.appendChild(t),e.appendChild(_),$==null||$.appendChild(e),b()}We();
