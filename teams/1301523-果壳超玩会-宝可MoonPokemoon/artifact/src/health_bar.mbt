// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the Apache License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
// è¡€æ¡ç»„ä»¶ç»“æ„
struct HealthBar {
  // è¡€æ¡å±æ€§
  mut width: Double
  mut height: Double
  mut current_hp: Int
  mut max_hp: Int
  
  // ä½ç½®ä¿¡æ¯
  mut x: Double
  mut y: Double
  
  // é¢œè‰²é…ç½®
  mut background_color: String
  mut fill_color: String
  mut text_color: String
  
  // åŠ¨ç”»çŠ¶æ€
  mut is_animating: Bool
  mut target_width: Double
  animation_speed: Double
  
  // æ˜¾ç¤ºçŠ¶æ€
  mut is_visible: Bool
}

///|
// ç®€åŒ–çš„Pokemonç»“æ„
struct SimplePokemon {
  name: String
  hp: Int
  max_hp: Int
  level: Int
}

///|
// è¡€æ¡ç®¡ç†å™¨ç»“æ„
struct HealthBarManager {
  // è¡€æ¡æ˜ å°„
  mut health_bars: Map[String, HealthBar]
  
  // é…ç½®
  default_width: Double
  default_height: Double
  animation_speed: Double
  
  // çŠ¶æ€
  mut is_active: Bool
  mut total_bars: Int
}

///|
// å…¨å±€è¡€æ¡ç®¡ç†å™¨å®ä¾‹
let health_bar_manager: HealthBarManager = {
  health_bars: Map::new(),
  default_width: 300.0,
  default_height: 25.0,
  animation_speed: 2.0,
  is_active: false,
  total_bars: 0
}

///|
// åˆ›å»ºè¡€æ¡ç»„ä»¶
fn create_health_bar(
  x: Double,
  y: Double,
  width: Double,
  height: Double,
  max_hp: Int,
  is_player: Bool
) -> HealthBar {
  // æ ¹æ®æ˜¯å¦ä¸ºç©å®¶è®¾ç½®ä¸åŒé¢œè‰²
  let (background_color, fill_color, text_color) = if is_player {
    ("#444444", "#00FF00", "#FFFFFF")
  } else {
    ("#444444", "#FF0000", "#FFFFFF")
  }
  
  // è¿”å›è¡€æ¡ç»„ä»¶
  {
    width: width,
    height: height,
    current_hp: max_hp,
    max_hp: max_hp,
    x: x,
    y: y,
    background_color: background_color,
    fill_color: fill_color,
    text_color: text_color,
    is_animating: false,
    target_width: width - 4.0,
    animation_speed: 2.0,
    is_visible: true
  }
}

///|
// æ›´æ–°è¡€æ¡æ˜¾ç¤º
fn update_health_bar(health_bar: HealthBar, current_hp: Int, max_hp: Int) -> HealthBar {
  let updated_bar = health_bar
  updated_bar.current_hp = current_hp
  updated_bar.max_hp = max_hp
  
  // è®¡ç®—HPç™¾åˆ†æ¯”
  let hp_percentage = if max_hp > 0 {
    current_hp.to_double() / max_hp.to_double()
  } else {
    0.0
  }
  
  // è®¡ç®—æ–°çš„å¡«å……å®½åº¦
  let new_fill_width = (health_bar.width - 4.0) * hp_percentage
  updated_bar.target_width = new_fill_width
  
  // æ ¹æ®HPç™¾åˆ†æ¯”ç¡®å®šé¢œè‰²
  let new_fill_color = if hp_percentage > 0.5 {
    health_bar.fill_color
  } else if hp_percentage > 0.25 {
    "#FFFF00"  // é»„è‰²
  } else {
    "#FF0000"  // çº¢è‰²
  }
  
  updated_bar.fill_color = new_fill_color
  
  // æ›´æ–°æ–‡æœ¬é¢œè‰²
  let new_text_color = if hp_percentage < 0.3 {
    "#FF0000"  // çº¢è‰²æ–‡æœ¬
  } else {
    health_bar.text_color
  }
  
  updated_bar.text_color = new_text_color
  
  // æ ‡è®°ä¸ºåŠ¨ç”»çŠ¶æ€
  updated_bar.is_animating = true
  
  let hp_text = "HP: " + current_hp.to_string() + "/" + max_hp.to_string()
  println("ğŸ“Š è¡€æ¡æ›´æ–°: " + hp_text + " (" + (hp_percentage * 100.0).to_string() + "%)")
  
  updated_bar
}

///|
// åŠ¨ç”»æ›´æ–°è¡€æ¡
fn animate_health_bar(health_bar: HealthBar) -> HealthBar {
  if !health_bar.is_animating {
    return health_bar
  }
  
  let updated_bar = health_bar
  
  // ç®€åŒ–çš„åŠ¨ç”»é€»è¾‘
  let width_diff = health_bar.target_width - health_bar.width
  let step = width_diff * health_bar.animation_speed * 0.016  // å‡è®¾60FPS
  
  if width_diff.abs() < 1.0 {
    // åŠ¨ç”»å®Œæˆ
    updated_bar.is_animating = false
    return updated_bar
  }
  
  // æ›´æ–°å®½åº¦
  updated_bar.width = health_bar.width + step
  
  updated_bar
}

///|
// è·å–è¡€æ¡æ˜¯å¦æ­£åœ¨åŠ¨ç”»
fn is_health_bar_animating(health_bar: HealthBar) -> Bool {
  health_bar.is_animating
}

///|
// è·å–è¡€æ¡HPç™¾åˆ†æ¯”
fn get_health_bar_percentage(health_bar: HealthBar) -> Double {
  if health_bar.max_hp > 0 {
    health_bar.current_hp.to_double() / health_bar.max_hp.to_double()
  } else {
    0.0
  }
}

///|
// è·å–è¡€æ¡æ˜¾ç¤ºæ–‡æœ¬
fn get_health_bar_text(health_bar: HealthBar) -> String {
  "HP: " + health_bar.current_hp.to_string() + "/" + health_bar.max_hp.to_string()
}

///|
// è®¾ç½®è¡€æ¡å¯è§æ€§
fn set_health_bar_visibility(health_bar: HealthBar, is_visible: Bool) -> HealthBar {
  let updated_bar = health_bar
  updated_bar.is_visible = is_visible
  updated_bar
}

///|
// æ£€æŸ¥è¡€æ¡æ˜¯å¦å¯è§
fn is_health_bar_visible(health_bar: HealthBar) -> Bool {
  health_bar.is_visible
}

///|
// è·å–è¡€æ¡ä½ç½®
fn get_health_bar_position(health_bar: HealthBar) -> (Double, Double) {
  (health_bar.x, health_bar.y)
}

///|
// è®¾ç½®è¡€æ¡ä½ç½®
fn set_health_bar_position(health_bar: HealthBar, x: Double, y: Double) -> HealthBar {
  let updated_bar = health_bar
  updated_bar.x = x
  updated_bar.y = y
  updated_bar
}

///|
// æµ‹è¯•è¡€æ¡ç»„ä»¶
fn test_health_bar() -> Unit {
  println("=== è¡€æ¡ç»„ä»¶æµ‹è¯•å¼€å§‹ ===")
  
  // åˆ›å»ºç©å®¶è¡€æ¡
  let player_bar = create_health_bar(50.0, 400.0, 200.0, 20.0, 100, true)
  println("âœ… ç©å®¶è¡€æ¡åˆ›å»ºæˆåŠŸ")
  
  // åˆ›å»ºæ•Œäººè¡€æ¡
  let enemy_bar = create_health_bar(550.0, 100.0, 200.0, 20.0, 80, false)
  println("âœ… æ•Œäººè¡€æ¡åˆ›å»ºæˆåŠŸ")
  
  // æµ‹è¯•è¡€æ¡æ›´æ–°
  let updated_player_bar = update_health_bar(player_bar, 75, 100)
  println("âœ… ç©å®¶è¡€æ¡æ›´æ–°æˆåŠŸ (75/100)")
  
  let updated_enemy_bar = update_health_bar(enemy_bar, 20, 80)
  println("âœ… æ•Œäººè¡€æ¡æ›´æ–°æˆåŠŸ (20/80)")
  
  // æµ‹è¯•åŠ¨ç”»
  let animated_player_bar = animate_health_bar(updated_player_bar)
  let animated_enemy_bar = animate_health_bar(updated_enemy_bar)
  println("âœ… è¡€æ¡åŠ¨ç”»æ›´æ–°æˆåŠŸ")
  
  // æµ‹è¯•ç™¾åˆ†æ¯”è®¡ç®—
  let player_percent = get_health_bar_percentage(updated_player_bar)
  let enemy_percent = get_health_bar_percentage(updated_enemy_bar)
  println("ç©å®¶HPç™¾åˆ†æ¯”: " + (player_percent * 100.0).to_string() + "%")
  println("æ•ŒäººHPç™¾åˆ†æ¯”: " + (enemy_percent * 100.0).to_string() + "%")
  
  // æµ‹è¯•æ–‡æœ¬è·å–
  let player_text = get_health_bar_text(updated_player_bar)
  let enemy_text = get_health_bar_text(updated_enemy_bar)
  println("ç©å®¶è¡€æ¡æ–‡æœ¬: " + player_text)
  println("æ•Œäººè¡€æ¡æ–‡æœ¬: " + enemy_text)
  
  // æµ‹è¯•ä½ç½®æ“ä½œ
  let (player_x, player_y) = get_health_bar_position(updated_player_bar)
  println("ç©å®¶è¡€æ¡ä½ç½®: (" + player_x.to_string() + ", " + player_y.to_string() + ")")
  
  let repositioned_bar = set_health_bar_position(updated_player_bar, 100.0, 450.0)
  let (new_x, new_y) = get_health_bar_position(repositioned_bar)
  println("é‡æ–°å®šä½åä½ç½®: (" + new_x.to_string() + ", " + new_y.to_string() + ")")
  
  println("=== è¡€æ¡ç»„ä»¶æµ‹è¯•å®Œæˆ ===")
}

///|
// ===== è¡€æ¡ç®¡ç†å™¨åŠŸèƒ½ =====

///|
// åˆå§‹åŒ–è¡€æ¡ç®¡ç†å™¨
fn init_health_bar_manager() -> Unit {
  health_bar_manager.is_active = true
  health_bar_manager.health_bars.clear()
  health_bar_manager.total_bars = 0
  println("ğŸ“Š è¡€æ¡ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")
}

///|
// åˆ›å»ºç®€åŒ–çš„Pokemon
fn create_simple_pokemon(name: String, level: Int, hp: Int, max_hp: Int) -> SimplePokemon {
  {
    name: name,
    hp: hp,
    max_hp: max_hp,
    level: level
  }
}

///|
// åˆ›å»ºPokemonè¡€æ¡
fn create_pokemon_health_bar(
  pokemon_id: String,
  pokemon: SimplePokemon,
  x: Double,
  y: Double,
  is_player: Bool
) -> Unit {
  if !health_bar_manager.is_active {
    println("âŒ è¡€æ¡ç®¡ç†å™¨æœªæ¿€æ´»")
    return
  }
  
  let health_bar = create_health_bar(
    x,
    y,
    health_bar_manager.default_width,
    health_bar_manager.default_height,
    pokemon.max_hp,
    is_player
  )
  
  // è®¾ç½®å½“å‰HP
  health_bar.current_hp = pokemon.hp
  
  // æ·»åŠ åˆ°ç®¡ç†å™¨
  health_bar_manager.health_bars.set(pokemon_id, health_bar)
  health_bar_manager.total_bars = health_bar_manager.total_bars + 1
  
  println("ğŸ“Š åˆ›å»ºPokemonè¡€æ¡: " + pokemon_id + " (" + pokemon.name + ")")
  println("  ä½ç½®: (" + x.to_string() + ", " + y.to_string() + ")")
  println("  HP: " + pokemon.hp.to_string() + "/" + pokemon.max_hp.to_string())
}

///|
// æ›´æ–°Pokemonè¡€æ¡
fn update_pokemon_health_bar(pokemon_id: String, pokemon: SimplePokemon) -> Unit {
  if !health_bar_manager.is_active {
    println("âŒ è¡€æ¡ç®¡ç†å™¨æœªæ¿€æ´»")
    return
  }
  
  match health_bar_manager.health_bars.get(pokemon_id) {
    Some(health_bar) => {
      let updated_bar = update_health_bar(health_bar, pokemon.hp, pokemon.max_hp)
      health_bar_manager.health_bars.set(pokemon_id, updated_bar)
      
      let percentage = get_health_bar_percentage(updated_bar)
      println("ğŸ“Š æ›´æ–°Pokemonè¡€æ¡: " + pokemon_id + " (" + pokemon.name + ")")
      println("  HP: " + pokemon.hp.to_string() + "/" + pokemon.max_hp.to_string() + " (" + (percentage * 100.0).to_string() + "%)")
    }
    None => {
      println("âŒ æœªæ‰¾åˆ°Pokemonè¡€æ¡: " + pokemon_id)
    }
  }
}

///|
// ç§»é™¤Pokemonè¡€æ¡
fn remove_pokemon_health_bar(pokemon_id: String) -> Unit {
  if !health_bar_manager.is_active {
    println("âŒ è¡€æ¡ç®¡ç†å™¨æœªæ¿€æ´»")
    return
  }
  
  match health_bar_manager.health_bars.get(pokemon_id) {
    Some(_) => {
      health_bar_manager.health_bars.remove(pokemon_id)
      health_bar_manager.total_bars = health_bar_manager.total_bars - 1
      println("ğŸ“Š ç§»é™¤Pokemonè¡€æ¡: " + pokemon_id)
    }
    None => {
      println("âŒ æœªæ‰¾åˆ°Pokemonè¡€æ¡: " + pokemon_id)
    }
  }
}

///|
// è·å–Pokemonè¡€æ¡
fn get_pokemon_health_bar(pokemon_id: String) -> Option[HealthBar] {
  health_bar_manager.health_bars.get(pokemon_id)
}

///|
// æ›´æ–°æ‰€æœ‰è¡€æ¡åŠ¨ç”»
fn update_all_health_bar_animations() -> Unit {
  if !health_bar_manager.is_active {
    return
  }
  
  let updated_bars = Map::new()
  
  let keys = health_bar_manager.health_bars.keys()
  for key in keys {
    match health_bar_manager.health_bars.get(key) {
      Some(health_bar) => {
        let animated_bar = animate_health_bar(health_bar)
        updated_bars.set(key, animated_bar)
      }
      None => { ignore(updated_bars) }
    }
  }
  
  health_bar_manager.health_bars = updated_bars
}

///|
// è·å–è¡€æ¡ç®¡ç†å™¨çŠ¶æ€
fn get_health_bar_manager_status() -> String {
  let status = if health_bar_manager.is_active {
    "æ´»è·ƒ"
  } else {
    "æœªæ¿€æ´»"
  }
  
  "è¡€æ¡ç®¡ç†å™¨çŠ¶æ€: " + status + ", æ€»è¡€æ¡æ•°: " + health_bar_manager.total_bars.to_string()
}

///|
// è·å–æ‰€æœ‰è¡€æ¡ä¿¡æ¯
fn get_all_health_bar_info() -> Array[String] {
  let info_list = Array::new()
  
  let keys = health_bar_manager.health_bars.keys()
  for key in keys {
    match health_bar_manager.health_bars.get(key) {
      Some(health_bar) => {
        let percentage = get_health_bar_percentage(health_bar)
        let text = get_health_bar_text(health_bar)
        let info = key + ": " + text + " (" + (percentage * 100.0).to_string() + "%)"
        info_list.push(info)
      }
      None => { ignore(info_list) }
    }
  }
  
  info_list
}

///|
// æ‰¹é‡æ›´æ–°Pokemonè¡€æ¡
fn batch_update_pokemon_health_bars(pokemon_list: Array[(String, SimplePokemon)]) -> Unit {
  if !health_bar_manager.is_active {
    println("âŒ è¡€æ¡ç®¡ç†å™¨æœªæ¿€æ´»")
    return
  }
  
  let mut update_count = 0
  
  let length = pokemon_list.length()
  let mut i = 0
  while i < length {
    match pokemon_list.get(i) {
      Some((pokemon_id, pokemon)) => {
        match health_bar_manager.health_bars.get(pokemon_id) {
          Some(health_bar) => {
            let updated_bar = update_health_bar(health_bar, pokemon.hp, pokemon.max_hp)
            health_bar_manager.health_bars.set(pokemon_id, updated_bar)
            update_count = update_count + 1
          }
          None => {
            println("âš ï¸ æœªæ‰¾åˆ°Pokemonè¡€æ¡: " + pokemon_id)
          }
        }
      }
      None => { ignore(update_count) }
    }
    i = i + 1
  }
  
  println("ğŸ“Š æ‰¹é‡æ›´æ–°å®Œæˆ: " + update_count.to_string() + " ä¸ªè¡€æ¡å·²æ›´æ–°")
}

///|
// è®¾ç½®è¡€æ¡å¯è§æ€§
fn set_pokemon_health_bar_visibility(pokemon_id: String, is_visible: Bool) -> Unit {
  if !health_bar_manager.is_active {
    println("âŒ è¡€æ¡ç®¡ç†å™¨æœªæ¿€æ´»")
    return
  }
  
  match health_bar_manager.health_bars.get(pokemon_id) {
    Some(health_bar) => {
      let updated_bar = set_health_bar_visibility(health_bar, is_visible)
      health_bar_manager.health_bars.set(pokemon_id, updated_bar)
      println("ğŸ“Š è®¾ç½®è¡€æ¡å¯è§æ€§: " + pokemon_id + " = " + is_visible.to_string())
    }
    None => {
      println("âŒ æœªæ‰¾åˆ°Pokemonè¡€æ¡: " + pokemon_id)
    }
  }
}

///|
// è®¾ç½®è¡€æ¡ä½ç½®
fn set_pokemon_health_bar_position(pokemon_id: String, x: Double, y: Double) -> Unit {
  if !health_bar_manager.is_active {
    println("âŒ è¡€æ¡ç®¡ç†å™¨æœªæ¿€æ´»")
    return
  }
  
  match health_bar_manager.health_bars.get(pokemon_id) {
    Some(health_bar) => {
      let updated_bar = set_health_bar_position(health_bar, x, y)
      health_bar_manager.health_bars.set(pokemon_id, updated_bar)
      println("ğŸ“Š è®¾ç½®è¡€æ¡ä½ç½®: " + pokemon_id + " = (" + x.to_string() + ", " + y.to_string() + ")")
    }
    None => {
      println("âŒ æœªæ‰¾åˆ°Pokemonè¡€æ¡: " + pokemon_id)
    }
  }
}

///|
// æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨ç”»è¿›è¡Œä¸­
fn has_animating_health_bars() -> Bool {
  if !health_bar_manager.is_active {
    return false
  }
  
  let keys = health_bar_manager.health_bars.keys()
  for key in keys {
    match health_bar_manager.health_bars.get(key) {
      Some(health_bar) => {
        if is_health_bar_animating(health_bar) {
          return true
        }
      }
      None => { ignore(health_bar_manager) }
    }
  }
  
  false
}

///|
// æ¸…ç†æ‰€æœ‰è¡€æ¡
fn clear_all_health_bars() -> Unit {
  if !health_bar_manager.is_active {
    println("âŒ è¡€æ¡ç®¡ç†å™¨æœªæ¿€æ´»")
    return
  }
  
  let bar_count = health_bar_manager.total_bars
  health_bar_manager.health_bars.clear()
  health_bar_manager.total_bars = 0
  
  println("ğŸ“Š æ¸…ç†æ‰€æœ‰è¡€æ¡: " + bar_count.to_string() + " ä¸ªè¡€æ¡å·²æ¸…ç†")
}

///|
// æµ‹è¯•è¡€æ¡ç®¡ç†å™¨
fn test_health_bar_manager() -> Unit {
  println("=== è¡€æ¡ç®¡ç†å™¨æµ‹è¯•å¼€å§‹ ===")
  
  // åˆå§‹åŒ–ç®¡ç†å™¨
  init_health_bar_manager()
  println("âœ… è¡€æ¡ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")
  
  // åˆ›å»ºæµ‹è¯•Pokemon
  let player_pokemon = create_simple_pokemon("å°ç«é¾™", 25, 100, 100)
  let enemy_pokemon = create_simple_pokemon("çš®å¡ä¸˜", 23, 80, 80)
  
  // åˆ›å»ºè¡€æ¡
  create_pokemon_health_bar("player", player_pokemon, 50.0, 400.0, true)
  create_pokemon_health_bar("enemy", enemy_pokemon, 550.0, 100.0, false)
  println("âœ… è¡€æ¡åˆ›å»ºå®Œæˆ")
  
  // æµ‹è¯•æ›´æ–°
  let damaged_player = create_simple_pokemon("å°ç«é¾™", 25, 75, 100)
  update_pokemon_health_bar("player", damaged_player)
  
  let damaged_enemy = create_simple_pokemon("çš®å¡ä¸˜", 23, 40, 80)
  update_pokemon_health_bar("enemy", damaged_enemy)
  println("âœ… è¡€æ¡æ›´æ–°å®Œæˆ")
  
  // æµ‹è¯•æ‰¹é‡æ›´æ–°
  let pokemon_list = [
    ("player", damaged_player),
    ("enemy", damaged_enemy)
  ]
  batch_update_pokemon_health_bars(pokemon_list)
  println("âœ… æ‰¹é‡æ›´æ–°å®Œæˆ")
  
  // æµ‹è¯•åŠ¨ç”»
  update_all_health_bar_animations()
  println("âœ… åŠ¨ç”»æ›´æ–°å®Œæˆ")
  
  // è·å–çŠ¶æ€ä¿¡æ¯
  let status = get_health_bar_manager_status()
  println("ğŸ“Š " + status)
  
  let info_list = get_all_health_bar_info()
  for info in info_list {
    println("ğŸ“Š " + info)
  }
  
  // æµ‹è¯•ä½ç½®è®¾ç½®
  set_pokemon_health_bar_position("player", 100.0, 450.0)
  set_pokemon_health_bar_position("enemy", 600.0, 150.0)
  println("âœ… ä½ç½®è®¾ç½®å®Œæˆ")
  
  // æµ‹è¯•å¯è§æ€§è®¾ç½®
  set_pokemon_health_bar_visibility("player", false)
  set_pokemon_health_bar_visibility("enemy", true)
  println("âœ… å¯è§æ€§è®¾ç½®å®Œæˆ")
  
  // æ£€æŸ¥åŠ¨ç”»çŠ¶æ€
  let has_animating = has_animating_health_bars()
  println("ğŸ“Š æ˜¯å¦æœ‰åŠ¨ç”»è¿›è¡Œä¸­: " + has_animating.to_string())
  
  // æ¸…ç†æµ‹è¯•
  clear_all_health_bars()
  println("âœ… æ¸…ç†å®Œæˆ")
  
  println("=== è¡€æ¡ç®¡ç†å™¨æµ‹è¯•å®Œæˆ ===")
} 