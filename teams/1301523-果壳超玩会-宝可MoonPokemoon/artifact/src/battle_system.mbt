// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
// Battle System - æ•´åˆæ‰€æœ‰æˆ˜æ–—ç›¸å…³åŠŸèƒ½
// åŒ…å«ï¼šæˆ˜æ–—æ¸²æŸ“ã€è¾“å…¥å¤„ç†ã€çŠ¶æ€ç®¡ç†ã€åœºæ™¯ç”Ÿæˆã€èœå•é…ç½®ã€å¸ƒå±€

///|
// ===== æˆ˜æ–—ç³»ç»Ÿå¸¸é‡ =====
const BATTLE_SCREEN_WIDTH : Double = 800.0
const BATTLE_SCREEN_HEIGHT : Double = 600.0
const POKEMON_SIZE : Double = 200.0
const UI_PANEL_HEIGHT : Double = 150.0

// æ–°å¢å¸¸é‡
const BATTLE_ARENA_HEIGHT : Double = 450.0  // æˆ˜æ–—åŒºåŸŸé«˜åº¦
const PLATFORM_WIDTH : Double = 120.0       // å¹³å°å®½åº¦
const PLATFORM_HEIGHT : Double = 60.0       // å¹³å°é«˜åº¦

// è¾“å…¥é˜²æŠ–å¸¸é‡
const SKILL_INPUT_COOLDOWN : Double = 0.3  // 300msé˜²æŠ–
const SKILL_INPUT_COOLDOWN_FRAMES : Int = 18  // çº¦300msé˜²æŠ– (60fps * 0.3s = 18å¸§)

///|
// ===== æˆ˜æ–—çŠ¶æ€ç»“æ„ =====

///|
// æˆ˜æ–—æ¸²æŸ“çŠ¶æ€
pub struct BattleRenderState {
  player_pokemon_entity : @system.Entity
  enemy_pokemon_entity : @system.Entity
  background_entity : @system.Entity
  ui_panel_entity : @system.Entity
  text_box_entity : @system.Entity
  text_entity : @system.Entity
  menu_entity : @system.Entity
  mut selected_option : MenuOption
  is_active : Bool
  current_selection_entity : @system.Entity
  mut skill_menu_visible : Bool
  mut skill_menu_selected : Int
  mut current_player_pokemon : Option[Pokemon]
  mut current_enemy_pokemon : Option[Pokemon]
  mut battle_state : Option[BattleState]
  mut player_pokemon_info : Option[PokemonInfoEntities]
  mut enemy_pokemon_info : Option[PokemonInfoEntities]
  // æ·»åŠ è®¡æ•°å™¨å­—æ®µ
  mut current_frame_count: Int
  mut last_skill_input_frame: Int
} derive(Show)

///|
// æˆ˜æ–—èœå•é…ç½®
struct BattleMenuConfig {
  // ä¸»æˆ˜æ–—èœå•é…ç½®
  main_menu : MainMenuConfig
  
  // æŠ€èƒ½èœå•é…ç½®
  skill_menu : SkillMenuConfig
  
  // å±å¹•å°ºå¯¸é…ç½®
  screen : ScreenConfig
  
  // å¸ƒå±€é…ç½®
  layout : LayoutConfig
}

///|
// ä¸»æˆ˜æ–—èœå•é…ç½®
struct MainMenuConfig {
  // åŸºç¡€å±æ€§
  visible : Bool
  selected_index : Int
  selected_option : MenuOption
  
  // å‡ ä½•å±æ€§
  mut position : @math.Vec2D
  mut width : Double
  mut height : Double
  
  // æ ·å¼é…ç½®
  background_color : String
  border_color : String
  text_color : String
  indicator_color : String
  
  // æŒ‰é’®é…ç½®
  button_spacing : Double
  button_height : Double
  button_padding : Double
}

///|
// æŠ€èƒ½èœå•é…ç½®
struct SkillMenuConfig {
  // åŸºç¡€å±æ€§
  visible : Bool
  selected_index : Int
  
  // å‡ ä½•å±æ€§
  mut position : @math.Vec2D
  mut width : Double
  mut height : Double
  
  // æ ·å¼é…ç½®
  background_color : String
  border_color : String
  text_color : String
  indicator_color : String
  title_color : String
  
  // æŠ€èƒ½é¡¹é…ç½®
  skill_spacing : Double
  skill_height : Double
  skill_padding : Double
  title_height : Double
}

///|
// å±å¹•é…ç½®
struct ScreenConfig {
  width : Double
  height : Double
  title_height : Double
  prompt_height : Double
}

///|
// å¸ƒå±€é…ç½®
struct LayoutConfig {
  // è¾¹è·å’Œé—´è·
  margin : Double
  padding : Double
  
  // åŒºåŸŸå°ºå¯¸
  enemy_area_width : Double
  enemy_area_height : Double
  player_area_width : Double
  player_area_height : Double
  menu_area_width : Double
  menu_area_height : Double
  status_area_width : Double
  status_area_height : Double
  
  // ä½ç½®åç§»
  title_offset_y : Double
  enemy_offset_y : Double
  player_offset_y : Double
  menu_offset_y : Double
  status_offset_y : Double
}

///|
// èœå•é€‰é¡¹æšä¸¾
pub enum MenuOption {
  Fight
  Bag
  Pokemon
  Run
} derive(Show, Eq)

///|
// è¾“å…¥ç±»å‹æšä¸¾
enum InputType {
  Keyboard
  Mouse
  Touch
  Gamepad
} derive(Show)

///|
// æŒ‰é”®çŠ¶æ€
enum KeyState {
  Pressed
  Released
  Held
  None
} derive(Eq)

///|
// é¼ æ ‡æŒ‰é’®
enum MouseButton {
  Left
  Right
  Middle
} derive(Eq, Hash, Show)

///|
// è§¦æ‘¸æ‰‹åŠ¿
enum TouchGesture {
  Tap
  DoubleTap
  LongPress
  Swipe
  Pinch
} derive(Show)

///|
// è¾“å…¥äº‹ä»¶ç»“æ„
struct InputEvent {
  input_type: InputType
  key: String
  position: @math.Vec2D
  timestamp: Double
  data: Map[String, String]
}

///|
// è¾“å…¥å¤„ç†å™¨
struct BattleInputHandler {
  mut is_enabled: Bool
  key_states: Map[String, KeyState]
  mut mouse_position: @math.Vec2D
  mouse_buttons: Map[MouseButton, Bool]
  
  // äº‹ä»¶é˜Ÿåˆ—
  event_queue: Array[InputEvent]
  
  // å›è°ƒå‡½æ•°
  mut on_key_press: Option[(String) -> Unit]
  on_key_release: Option[(String) -> Unit]
  mut on_mouse_click: Option[(String) -> Unit]
  on_mouse_move: Option[(String) -> Unit]
  on_touch_gesture: Option[(String) -> Unit]
}

///|
// ===== å…¨å±€å®ä¾‹ =====

///|
// å…¨å±€æˆ˜æ–—æ¸²æŸ“çŠ¶æ€
let battle_render_state : BattleRenderState = BattleRenderState::{
  player_pokemon_entity: @system.Entity::new(),
  enemy_pokemon_entity: @system.Entity::new(),
  background_entity: @system.Entity::new(),
  ui_panel_entity: @system.Entity::new(),
  text_box_entity: @system.Entity::new(),
  text_entity: @system.Entity::new(),
  menu_entity: @system.Entity::new(),
  selected_option: MenuOption::Fight,
  is_active: false,
  current_selection_entity: @system.Entity::new(),
  skill_menu_visible: false,
  skill_menu_selected: 0,
  current_player_pokemon: None,
  current_enemy_pokemon: None,
  battle_state: None,
  player_pokemon_info: None,
  enemy_pokemon_info: None,
  current_frame_count: 0,
  last_skill_input_frame: 0
}

///|
// å…¨å±€æŒ‡ç¤ºå™¨å®ä½“
let global_indicator_entity : @system.Entity = @system.Entity::new()
///|
// å…¨å±€æˆ˜æ–—èœå•é…ç½®å®ä¾‹
let battle_menu_config : BattleMenuConfig = {
  // ä¸»èœå•é…ç½®
  main_menu: MainMenuConfig::{
    visible: false,
    selected_index: 0,
    selected_option: Fight,
    position: @math.Vec2D(50.0, 450.0),
    width: 170.0,
    height: 115.0,
    background_color: "#1a1a1a",
    border_color: "#4ECDC4",
    text_color: "#FFFFFF",
    indicator_color: "#4ECDC4",
    button_spacing: 25.0,
    button_height: 20.0,
    button_padding: 10.0
  },
  
  // æŠ€èƒ½èœå•é…ç½®
  skill_menu: SkillMenuConfig::{
    visible: false,
    selected_index: 0,
    position: @math.Vec2D(250.0, 450.0),
    width: 220.0,
    height: 200.0,
    background_color: "#1a1a1a",
    border_color: "#4ECDC4",
    text_color: "#FFFFFF",
    indicator_color: "#4ECDC4",
    title_color: "#FFFFFF",
    skill_spacing: 30.0,
    skill_height: 25.0,
    skill_padding: 25.0,
    title_height: 20.0
  },
  
  // å±å¹•é…ç½®
  screen: ScreenConfig::{
    width: 800.0,
    height: 600.0,
    title_height: 32.0,
    prompt_height: 18.0
  },
  
  // å¸ƒå±€é…ç½®
  layout: LayoutConfig::{
    margin: 20.0,
    padding: 15.0,
    enemy_area_width: 120.0,
    enemy_area_height: 100.0,
    player_area_width: 120.0,
    player_area_height: 100.0,
    menu_area_width: 200.0,
    menu_area_height: 120.0,
    status_area_width: 100.0,
    status_area_height: 80.0,
    title_offset_y: 20.0,
    enemy_offset_y: 50.0,
    player_offset_y: 50.0,
    menu_offset_y: 170.0,
    status_offset_y: 170.0
  }
}

///|
// å…¨å±€è¾“å…¥å¤„ç†å™¨å®ä¾‹
let input_handler: BattleInputHandler = {
  is_enabled: true,
  key_states: Map::new(),
  mouse_position: @math.Vec2D(0.0, 0.0),
  mouse_buttons: Map::new(),
  event_queue: Array::new(),
  on_key_press: None,
  on_key_release: None,
  on_mouse_click: None,
  on_mouse_move: None,
  on_touch_gesture: None,
}

///|
// ===== æˆ˜æ–—æ¸²æŸ“åŠŸèƒ½ =====

///|
// è·å–å½“å‰é€‰æ‹©
fn get_current_selection() -> MenuOption {
  battle_render_state.selected_option
}

///|
// æ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®
fn update_indicator_position(selection : MenuOption) -> Unit {
  // æŒ‰é’®ä½ç½®ï¼ˆåŸºäºbattle_render.mbtä¸­çš„å®é™…ä½ç½®ï¼‰ï¼š
  // æˆ˜æ–—: (550, 485) - å·¦ä¸Š
  // èƒŒåŒ…: (670, 485) - å³ä¸Š  
  // å®å¯æ¢¦: (550, 520) - å·¦ä¸‹
  // é€ƒè·‘: (670, 520) - å³ä¸‹
  
  // ç®­å¤´åº”è¯¥æ”¾åœ¨æŒ‰é’®å·¦ä¾§ï¼Œç¨å¾®åå·¦ä¸€ç‚¹
  let indicator_pos = match selection {
    MenuOption::Fight => @math.Vec2D(530.0, 485.0)    // æˆ˜æ–—æŒ‰é’®å·¦ä¾§
    MenuOption::Bag => @math.Vec2D(650.0, 485.0)     // èƒŒåŒ…æŒ‰é’®å·¦ä¾§
    MenuOption::Pokemon => @math.Vec2D(530.0, 520.0)  // å®å¯æ¢¦æŒ‰é’®å·¦ä¾§
    MenuOption::Run => @math.Vec2D(650.0, 520.0)      // é€ƒè·‘æŒ‰é’®å·¦ä¾§
  }
  
  // æ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®
  @position.positions.set(global_indicator_entity, indicator_pos)
  
  // å¦‚æœæŒ‡ç¤ºå™¨è¿˜æ²¡æœ‰ç²¾çµï¼Œåˆ›å»ºä¸€ä¸ª
  if @sprite.sprites.get(global_indicator_entity) is None {
    let indicator_sprite = @sprite.Sprite::from_text(
      @sprite.Text::new(
        "â–¶",
        color="#FFFF00",
        font="16px Arial"
      ),
      13
    )
    @sprite.sprites.set(global_indicator_entity, indicator_sprite)
  }
  
  // æ›´æ–°å…¨å±€çŠ¶æ€
  battle_render_state.selected_option = selection
  
  println("ğŸ¯ ç®­å¤´ä½ç½®æ›´æ–°: (" + indicator_pos.0.to_string() + ", " + indicator_pos.1.to_string() + ") - " + selection.to_string())
}

///|
// åˆå§‹åŒ–å…¨å±€çŠ¶æ€
fn init_global_state() -> Unit {
  println("ğŸŒ åˆå§‹åŒ–å…¨å±€çŠ¶æ€...")
  
  // åˆ›å»ºåˆå§‹æŒ‡ç¤ºå™¨
  let indicator_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(
      "â–¶",
      color="#FFFF00",
      font="16px Arial"
    ),
    13
  )
  @sprite.sprites.set(global_indicator_entity, indicator_sprite)
  @position.positions.set(global_indicator_entity, @math.Vec2D(530.0, 485.0))
  
  // è®¾ç½®åˆå§‹é€‰æ‹©
  battle_render_state.selected_option = MenuOption::Fight
  
  println("âœ… å…¨å±€çŠ¶æ€åˆå§‹åŒ–å®Œæˆ")
  println("ğŸ¯ åˆå§‹ç®­å¤´ä½ç½®: (530, 485) - æˆ˜æ–—æŒ‰é’®å·¦ä¾§")
}

///|
// åˆå§‹åŒ–æˆ˜æ–—æ¸²æŸ“ç³»ç»Ÿ
pub fn init_battle_render_system() -> Unit {
  println("ğŸ¨ åˆå§‹åŒ–æˆ˜æ–—æ¸²æŸ“ç³»ç»Ÿ...")
  
  // é¢„åŠ è½½æ‰€æœ‰å®å¯æ¢¦å›¾ç‰‡
  // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä¼ å…¥backendå‚æ•°ï¼Œå¯èƒ½éœ€è¦ä¿®æ”¹å‡½æ•°ç­¾å
  // preload_all_pokemon_sprites(backend)
  
  // åˆå§‹åŒ–å…¨å±€çŠ¶æ€
  init_global_state()
  
  // åˆ›å»ºèƒŒæ™¯
  create_battle_background()
  
  // åˆ›å»ºUIé¢æ¿
  create_ui_panel()
  
  // åˆ›å»ºæ–‡æœ¬æ¡†
  create_text_box()
  
  // åˆ›å»ºèœå•
  create_battle_menu()
  
  println("âœ… æˆ˜æ–—æ¸²æŸ“ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
}

///|
// åˆ›å»ºæˆ˜æ–—èƒŒæ™¯
fn create_battle_background() -> Unit {
  let entity = battle_render_state.background_entity
  
  // åˆ›å»ºæµ…ç»¿è‰²ç½‘æ ¼èƒŒæ™¯
  let background_sprite = @sprite.Sprite::from_color_rect(
    @sprite.ColorRect::new(
      @math.Vec2D(BATTLE_SCREEN_WIDTH, BATTLE_ARENA_HEIGHT),
      "#90EE90"  // æµ…ç»¿è‰²
    ),
    0  // æœ€åº•å±‚
  )
  @sprite.sprites.set(entity, background_sprite)
  @position.positions.set(entity, @math.Vec2D(0.0, 0.0))
  
  // æ·»åŠ ç½‘æ ¼å›¾æ¡ˆ
  add_grid_pattern()
  
  // æ·»åŠ æ·±ç»¿è‰²å¹³å°
  add_battle_platforms()
}

///|
// æ·»åŠ ç½‘æ ¼å›¾æ¡ˆ
fn add_grid_pattern() -> Unit {
  // åˆ›å»ºç½‘æ ¼çº¿
  let grid_size = 20.0
  let mut x = 0.0
  while x < BATTLE_SCREEN_WIDTH {
    let grid_line = @system.Entity::new()
    let line_sprite = @sprite.Sprite::from_color_rect(
      @sprite.ColorRect::new(
        @math.Vec2D(1.0, BATTLE_ARENA_HEIGHT),
        "#7FCC7F"  // ç¨æ·±çš„ç»¿è‰²
      ),
      1
    )
    @sprite.sprites.set(grid_line, line_sprite)
    @position.positions.set(grid_line, @math.Vec2D(x, 0.0))
    x = x + grid_size
  }
  
  let mut y = 0.0
  while y < BATTLE_ARENA_HEIGHT {
    let grid_line = @system.Entity::new()
    let line_sprite = @sprite.Sprite::from_color_rect(
      @sprite.ColorRect::new(
        @math.Vec2D(BATTLE_SCREEN_WIDTH, 1.0),
        "#7FCC7F"  // ç¨æ·±çš„ç»¿è‰²
      ),
      1
    )
    @sprite.sprites.set(grid_line, line_sprite)
    @position.positions.set(grid_line, @math.Vec2D(0.0, y))
    y = y + grid_size
  }
}

///|
// æ·»åŠ æˆ˜æ–—å¹³å°
fn add_battle_platforms() -> Unit {
  // // ç©å®¶å¹³å°ï¼ˆå·¦ä¸‹è§’ï¼‰
  // let player_platform = @system.Entity::new()
  // let player_platform_sprite = @sprite.Sprite::from_color_rect(
  //   @sprite.ColorRect::new(
  //     @math.Vec2D(PLATFORM_WIDTH, PLATFORM_HEIGHT),
  //     "#228B22"  // æ·±ç»¿è‰²
  //   ),
  //   2
  // )
  // @sprite.sprites.set(player_platform, player_platform_sprite)
  // @position.positions.set(player_platform, @math.Vec2D(50.0, BATTLE_ARENA_HEIGHT - PLATFORM_HEIGHT - 50.0))
  
  // // å¯¹æ‰‹å¹³å°ï¼ˆå³ä¸Šè§’ï¼‰
  // let enemy_platform = @system.Entity::new()
  // let enemy_platform_sprite = @sprite.Sprite::from_color_rect(
  //   @sprite.ColorRect::new(
  //     @math.Vec2D(PLATFORM_WIDTH, PLATFORM_HEIGHT),
  //     "#228B22"  // æ·±ç»¿è‰²
  //   ),
  //   2
  // )
  // @sprite.sprites.set(enemy_platform, enemy_platform_sprite)
  // @position.positions.set(enemy_platform, @math.Vec2D(BATTLE_SCREEN_WIDTH - PLATFORM_WIDTH - 50.0, 50.0))

//todo: currently, the enemy and player are not rendered. we need to fix this in the future.
}

///|
// åˆ›å»ºUIé¢æ¿
fn create_ui_panel() -> Unit {
  let entity = battle_render_state.ui_panel_entity
  
  // åˆ›å»ºåº•éƒ¨UIé¢æ¿
  let panel_sprite = @sprite.Sprite::from_color_rect(
    @sprite.ColorRect::new(
      @math.Vec2D(BATTLE_SCREEN_WIDTH, UI_PANEL_HEIGHT),
      "#2E2E2E"  // æ·±ç°è‰²
    ),
    10  // UIå±‚
  )
  @sprite.sprites.set(entity, panel_sprite)
  @position.positions.set(entity, @math.Vec2D(0.0, BATTLE_ARENA_HEIGHT))
  
  // æ·»åŠ è¾¹æ¡†
  add_ui_border()
}

///|
// æ·»åŠ UIè¾¹æ¡†
fn add_ui_border() -> Unit {
  // é¡¶éƒ¨è¾¹æ¡†
  let top_border = @system.Entity::new()
  let top_border_sprite = @sprite.Sprite::from_color_rect(
    @sprite.ColorRect::new(
      @math.Vec2D(BATTLE_SCREEN_WIDTH, 3.0),
      "#FFFFFF"  // ç™½è‰²è¾¹æ¡†
    ),
    11
  )
  @sprite.sprites.set(top_border, top_border_sprite)
  @position.positions.set(top_border, @math.Vec2D(0.0, BATTLE_ARENA_HEIGHT))
}

///|
// åˆ›å»ºæ–‡æœ¬æ¡†
fn create_text_box() -> Unit {
  let entity = battle_render_state.text_box_entity
  
  // åˆ›å»ºæ·±è“è‰²æ–‡æœ¬æ¡†èƒŒæ™¯
  let text_bg_sprite = @sprite.Sprite::from_color_rect(
    @sprite.ColorRect::new(
      @math.Vec2D(400.0, 80.0),
      "#1E3A8A"  // æ·±è“è‰²
    ),
    11  // æ–‡æœ¬å±‚
  )
  @sprite.sprites.set(entity, text_bg_sprite)
  @position.positions.set(entity, @math.Vec2D(20.0, BATTLE_ARENA_HEIGHT + 20.0))
  
  // æ·»åŠ æ–‡æœ¬ - ä½¿ç”¨é»˜è®¤æ–‡æœ¬ï¼Œç¨åæ›´æ–°
  let text_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(
      "æƒ³è¦å®å¯æ¢¦åšä»€ä¹ˆ?",
      color="#FFFFFF",
      font="18px Arial"
    ),
    12
  )
  let text_entity = battle_render_state.text_entity
  @sprite.sprites.set(text_entity, text_sprite)
  @position.positions.set(text_entity, @math.Vec2D(30.0, BATTLE_ARENA_HEIGHT + 35.0))
}

///|
// åˆ›å»ºæˆ˜æ–—èœå•
fn create_battle_menu() -> Unit {
  let entity = battle_render_state.menu_entity
  
  // åˆ›å»ºæµ…è“è‰²èœå•èƒŒæ™¯
  let menu_bg_sprite = @sprite.Sprite::from_color_rect(
    @sprite.ColorRect::new(
      @math.Vec2D(240.0, 100.0),
      "#3B82F6"  // æµ…è“è‰²
    ),
    11
  )
  @sprite.sprites.set(entity, menu_bg_sprite)
  @position.positions.set(entity, @math.Vec2D(BATTLE_SCREEN_WIDTH - 260.0, BATTLE_ARENA_HEIGHT + 20.0))
  
  // æ·»åŠ èœå•é€‰é¡¹
  create_menu_options()
}

///|
// åˆ›å»ºèœå•é€‰é¡¹
fn create_menu_options() -> Unit {
  // åˆ›å»ºæˆ˜æ–—é€‰é¡¹
  let battle_entity = @system.Entity::new()
  let battle_text = @sprite.Sprite::from_text(
    @sprite.Text::new(
      "æˆ˜æ–—",
      color="#FFFFFF",
      font="16px Arial"
    ),
    12
  )
  @sprite.sprites.set(battle_entity, battle_text)
  let battle_pos = @math.Vec2D(BATTLE_SCREEN_WIDTH - 250.0, BATTLE_ARENA_HEIGHT + 35.0)
  @position.positions.set(battle_entity, battle_pos)
  
  // åˆ›å»ºèƒŒåŒ…é€‰é¡¹
  let bag_entity = @system.Entity::new()
  let bag_text = @sprite.Sprite::from_text(
    @sprite.Text::new(
      "èƒŒåŒ…",
      color="#FFFFFF",
      font="16px Arial"
    ),
    12
  )
  @sprite.sprites.set(bag_entity, bag_text)
  let bag_pos = @math.Vec2D(BATTLE_SCREEN_WIDTH - 130.0, BATTLE_ARENA_HEIGHT + 35.0)
  @position.positions.set(bag_entity, bag_pos)
  
  // åˆ›å»ºå®å¯æ¢¦é€‰é¡¹
  let pokemon_entity = @system.Entity::new()
  let pokemon_text = @sprite.Sprite::from_text(
    @sprite.Text::new(
      "å®å¯æ¢¦",
      color="#FFFFFF",
      font="16px Arial"
    ),
    12
  )
  @sprite.sprites.set(pokemon_entity, pokemon_text)
  let pokemon_pos = @math.Vec2D(BATTLE_SCREEN_WIDTH - 250.0, BATTLE_ARENA_HEIGHT + 70.0)
  @position.positions.set(pokemon_entity, pokemon_pos)
  
  // åˆ›å»ºé€ƒè·‘é€‰é¡¹
  let run_entity = @system.Entity::new()
  let run_text = @sprite.Sprite::from_text(
    @sprite.Text::new(
      "é€ƒè·‘",
      color="#FFFFFF",
      font="16px Arial"
    ),
    12
  )
  @sprite.sprites.set(run_entity, run_text)
  let run_pos = @math.Vec2D(BATTLE_SCREEN_WIDTH - 130.0, BATTLE_ARENA_HEIGHT + 70.0)
  @position.positions.set(run_entity, run_pos)
  
  // åˆ›å»ºé€‰ä¸­æŒ‡ç¤ºå™¨ï¼ˆé»‘è‰²ç®­å¤´ï¼‰
  create_menu_selector()
}

///|
// åˆ›å»ºèœå•é€‰ä¸­æŒ‡ç¤ºå™¨
fn create_menu_selector() -> Unit {
  let selector_entity = @system.Entity::new()
  let selector_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(
      "â–¶",
      color="#000000",  // é»‘è‰²ç®­å¤´
      font="16px Arial"
    ),
    13
  )
  @sprite.sprites.set(selector_entity, selector_sprite)
  // é»˜è®¤æŒ‡å‘ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼ˆæˆ˜æ–—ï¼‰
  @position.positions.set(selector_entity, @math.Vec2D(BATTLE_SCREEN_WIDTH - 270.0, BATTLE_ARENA_HEIGHT + 35.0))
}

///|
// ===== æˆ˜æ–—è¾“å…¥å¤„ç†åŠŸèƒ½ =====

///|
// æ›´æ–°å¸§è®¡æ•°å™¨
fn update_frame_counter() -> Unit {
  battle_render_state.current_frame_count = battle_render_state.current_frame_count + 1
}

///|
// è·å–å½“å‰å¸§æ•°
fn get_current_frame_count() -> Int {
  battle_render_state.current_frame_count
}

///|
// å¤„ç†é”®ç›˜è¾“å…¥
pub fn handle_battle_input() -> Unit {
  // å¦‚æœæŠ€èƒ½èœå•å¯è§ï¼Œå¤„ç†æŠ€èƒ½èœå•çš„è¾“å…¥
  if battle_render_state.skill_menu_visible {
    handle_skill_menu_input()
  } else {
    // å¦åˆ™å¤„ç†ä¸»èœå•çš„è¾“å…¥
    if @system.is_pressed(@system.ArrowUp) {
      move_selection_up()
    }
    
    if @system.is_pressed(@system.ArrowDown) {
      move_selection_down()
    }
    
    if @system.is_pressed(@system.ArrowLeft) {
      move_selection_left()
    }
    
    if @system.is_pressed(@system.ArrowRight) {
      move_selection_right()
    }
    
    if @system.is_pressed(@system.Enter) {
      select_current_option()
    }
  }
}

///|
// å‘å·¦ç§»åŠ¨é€‰æ‹© (Fight â† Bag, Pokemon â† Run)
fn move_selection_left() -> Unit {
  let new_option = match get_current_selection() {
    MenuOption::Fight => MenuOption::Fight    // å·¦è¾¹ç•Œï¼Œä¸èƒ½å‘å·¦
    MenuOption::Bag => MenuOption::Fight      // Bag â†’ Fight
    MenuOption::Pokemon => MenuOption::Pokemon // å·¦è¾¹ç•Œï¼Œä¸èƒ½å‘å·¦
    MenuOption::Run => MenuOption::Pokemon    // Run â†’ Pokemon
  }
  
  // æ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®
  update_indicator_position(new_option)
  println("â¬…ï¸ é€‰æ‹©: å‘å·¦ç§»åŠ¨")
}

///|
// å‘å³ç§»åŠ¨é€‰æ‹© (Fight â†’ Bag, Pokemon â†’ Run)
fn move_selection_right() -> Unit {
  let new_option = match get_current_selection() {
    MenuOption::Fight => MenuOption::Bag      // Fight â†’ Bag
    MenuOption::Bag => MenuOption::Bag        // å³è¾¹ç•Œï¼Œä¸èƒ½å‘å³
    MenuOption::Pokemon => MenuOption::Run    // Pokemon â†’ Run
    MenuOption::Run => MenuOption::Run        // å³è¾¹ç•Œï¼Œä¸èƒ½å‘å³
  }
  
  // æ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®
  update_indicator_position(new_option)
  println("â¡ï¸ é€‰æ‹©: å‘å³ç§»åŠ¨")
}

///|
// å‘ä¸Šç§»åŠ¨é€‰æ‹© (Fight â†â†’ Pokemon, Bag â†â†’ Run)
fn move_selection_up() -> Unit {
  let new_option = match get_current_selection() {
    MenuOption::Fight => MenuOption::Fight    // ä¸Šè¾¹ç•Œï¼Œä¸èƒ½å‘ä¸Š
    MenuOption::Bag => MenuOption::Bag        // ä¸Šè¾¹ç•Œï¼Œä¸èƒ½å‘ä¸Š
    MenuOption::Pokemon => MenuOption::Fight   // Pokemon â†’ Fight
    MenuOption::Run => MenuOption::Bag        // Run â†’ Bag
  }
  
  // æ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®
  update_indicator_position(new_option)
  println("â¬†ï¸ é€‰æ‹©: å‘ä¸Šç§»åŠ¨")
}

///|
// å‘ä¸‹ç§»åŠ¨é€‰æ‹© (Fight â†â†’ Pokemon, Bag â†â†’ Run)
fn move_selection_down() -> Unit {
  let new_option = match get_current_selection() {
    MenuOption::Fight => MenuOption::Pokemon  // Fight â†’ Pokemon
    MenuOption::Bag => MenuOption::Run         // Bag â†’ Run
    MenuOption::Pokemon => MenuOption::Pokemon // ä¸‹è¾¹ç•Œï¼Œä¸èƒ½å‘ä¸‹
    MenuOption::Run => MenuOption::Run         // ä¸‹è¾¹ç•Œï¼Œä¸èƒ½å‘ä¸‹
  }
  
  // æ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®
  update_indicator_position(new_option)
  println("â¬‡ï¸ é€‰æ‹©: å‘ä¸‹ç§»åŠ¨")
}

///|
// é€‰æ‹©å½“å‰é€‰é¡¹
fn select_current_option() -> Unit {
  let action = match get_current_selection() {
    MenuOption::Fight => {
      // é€‰æ‹©æˆ˜æ–—æ—¶ï¼Œæ‰“å¼€æŠ€èƒ½èœå•
      if !battle_render_state.skill_menu_visible {
        battle_render_state.skill_menu_visible = true
        battle_render_state.skill_menu_selected = 0
        show_skill_menu_ui()
        "é€‰æ‹©æŠ€èƒ½"
      } else {
        "æŠ€èƒ½èœå•å·²æ‰“å¼€"
      }
    }
    MenuOption::Bag => "æ‰“å¼€èƒŒåŒ…"
    MenuOption::Pokemon => "æŸ¥çœ‹å®å¯æ¢¦"
    MenuOption::Run => "å°è¯•é€ƒè·‘"
  }
  println("âœ… " + action)
  
  // æ›´æ–°æ–‡æœ¬æ¡†
  update_text_box(action)
}

///|
// æ›´æ–°æ–‡æœ¬æ¡†
fn update_text_box(text : String) -> Unit {
  let text_entity = battle_render_state.text_entity
  let text_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(
      text,
      color="#FFFFFF",
      font="18px Arial"
    ),
    12
  )
  @sprite.sprites.set(text_entity, text_sprite)
  @position.positions.set(text_entity, @math.Vec2D(30.0, BATTLE_ARENA_HEIGHT + 35.0))
}

///|
// ===== æˆ˜æ–—çŠ¶æ€ç®¡ç†åŠŸèƒ½ =====

///|
// è·å–å®å¯æ¢¦çŠ¶æ€æ‘˜è¦
pub fn get_pokemon_status_summary(pokemon : Pokemon) -> String {
  let hp_percent = (pokemon.hp.to_double() / pokemon.max_hp.to_double()) * 100.0
  let status = if pokemon.hp <= 0 {
    "FAINTED"
  } else if hp_percent <= 25.0 {
    "CRITICAL"
  } else if hp_percent <= 50.0 {
    "LOW"
  } else if hp_percent <= 75.0 {
    "MODERATE"
  } else {
    "GOOD"
  }
  
  pokemon.name + " (Lv." + pokemon.level.to_string() + ") - " + 
  pokemon.hp.to_string() + "/" + pokemon.max_hp.to_string() + " HP (" + 
  hp_percent.to_string() + "%) - " + status
}

///|
// è·å–æˆ˜æ–—æ—¥å¿—
pub fn get_formatted_battle_log(battle_state : BattleState) -> String {
  let mut formatted_log = ""
  let mut turn_count = 0
  
  for entry in battle_state.battle_log {
    if entry.contains("Turn") && entry.contains("completed") {
      turn_count = turn_count + 1
      formatted_log = formatted_log + "--- Turn " + turn_count.to_string() + " ---\n"
    } else {
      formatted_log = formatted_log + entry + "\n"
    }
  }
  
  formatted_log
}

///|
// æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦å¯ä»¥ä½¿ç”¨ç‰¹å®šæŠ€èƒ½
pub fn can_use_move(pokemon : Pokemon, move_name : String) -> Bool {
  // æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦æœ‰è¯¥æŠ€èƒ½
  let mut has_move = false
  for move_name_check in pokemon.moves {
    if move_name_check == move_name {
      has_move = true
      break
    }
  }
  
  // æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦æ²¡æœ‰æ™•å€’
  let not_fainted = pokemon.hp > 0
  
  has_move && not_fainted
}

///|
// è·å–æˆ˜æ–—ç»Ÿè®¡
pub fn get_battle_statistics(battle_state : BattleState) -> String {
  match (battle_state.player_pokemon, battle_state.enemy_pokemon) {
    (Some(player), Some(enemy)) => {
      let player_hp_percent = (player.hp.to_double() / player.max_hp.to_double()) * 100.0
      let enemy_hp_percent = (enemy.hp.to_double() / enemy.max_hp.to_double()) * 100.0
      
      "Battle Statistics:\n" +
  "Turn: " + battle_state.turn.to_string() + "\n" +
      "Player: " + player.name + " (HP: " + player_hp_percent.to_string() + "%)\n" +
      "Enemy: " + enemy.name + " (HP: " + enemy_hp_percent.to_string() + "%)\n" +
  "Log entries: " + battle_state.battle_log.length().to_string() + "\n" +
  "Status: " + (if battle_state.is_active { "Active" } else { "Ended" })
    }
    _ => "Battle not properly initialized"
  }
}

///|
// è®¡ç®—ä¼¤å®³ - ä½¿ç”¨æ ‡å‡†å®å¯æ¢¦ä¼¤å®³å…¬å¼
pub fn calculate_damage(attacker : Pokemon, defender : Pokemon, skill : Move) -> Int {
  // æ ‡å‡†å®å¯æ¢¦ä¼¤å®³å…¬å¼ï¼š
  // Damage = (((((2 * Level) / 5 + 2) * Power * Attack / Defense) / 50) + 2) * Modifier
  
  let level = attacker.level
  let power = skill.power
  let attack = attacker.attack
  let defense = defender.defense
  
  // è®¡ç®—åŸºç¡€ä¼¤å®³éƒ¨åˆ†ï¼š((2 * Level) / 5 + 2) * Power * Attack / Defense
  let level_factor = (2 * level) / 5 + 2
  let base_damage = (level_factor * power * attack) / defense
  
  // é™¤ä»¥50å¹¶åŠ 2
  let damage_before_modifier = base_damage / 50 + 2
  
  // åº”ç”¨ç±»å‹å…‹åˆ¶ä¿®æ­£å™¨
  let modifier = get_type_effectiveness_multiplier(skill.element_type, defender.types)
  let final_damage = (damage_before_modifier.to_double() * modifier).to_int()
  
  // ç¡®ä¿ä¼¤å®³è‡³å°‘ä¸º1
  if final_damage < 1 { 1 } else { final_damage }
}

///|
// åº”ç”¨æŠ€èƒ½æ•ˆæœï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
pub fn apply_move_effect_simple(base_damage : Int, move_type : String) -> Int {
  // ç®€åŒ–çš„ä¼¤å®³è®¡ç®—ï¼Œåªè€ƒè™‘åŸºç¡€ä¼¤å®³å’Œç±»å‹
  let type_multiplier = match move_type {
    "Fire" => 1.5
    "Water" => 1.3
    "Electric" => 1.4
    "Grass" => 1.2
    "Ice" => 1.3
    "Fighting" => 1.4
    "Poison" => 1.2
    "Ground" => 1.3
    "Flying" => 1.3
    "Psychic" => 1.4
    "Bug" => 1.1
    "Rock" => 1.3
    "Ghost" => 1.4
    "Dragon" => 1.5
    "Dark" => 1.3
    "Steel" => 1.2
    "Fairy" => 1.3
    _ => 1.0
  }
  
  (base_damage.to_double() * type_multiplier).to_int()
}



///|
// çŠ¶æ€è½¬å­—ç¬¦ä¸²
pub fn status_to_string(status_name : String) -> String {
  match status_name {
    "normal" => "æ­£å¸¸"
    "poison" => "ä¸­æ¯’"
    "burn" => "ç¼çƒ§"
    "freeze" => "å†°å†»"
    "paralysis" => "éº»ç—¹"
    "sleep" => "ç¡çœ "
    "fainted" => "æ¿’æ­»"
    _ => "æœªçŸ¥çŠ¶æ€"
  }
}

///|
// æ•ˆæœç±»å‹è½¬å­—ç¬¦ä¸²
pub fn effect_type_to_string(effect_type : String) -> String {
  match effect_type {
    "Ability" => "ç‰¹æ€§"
    "Item" => "é“å…·"
    "Move" => "æŠ€èƒ½"
    "Status" => "çŠ¶æ€"
    "Weather" => "å¤©æ°”"
    "Terrain" => "åœºåœ°"
    "Field" => "åœºåœ°æ•ˆæœ"
    _ => "æœªçŸ¥æ•ˆæœ"
  }
}

///|
// ä¼¤å®³ç±»å‹è½¬å­—ç¬¦ä¸²
pub fn damage_type_to_string(damage_type : String) -> String {
  match damage_type {
    "Physical" => "ç‰©ç†"
    "Special" => "ç‰¹æ®Š"
    "Status" => "å˜åŒ–"
    "True" => "çœŸå®"
    _ => "æœªçŸ¥ç±»å‹"
  }
}

///|
// ä½¿ç”¨æŠ€èƒ½
pub fn use_move(move_name : String, is_player : Bool, battle_state : BattleState) -> String {
  match (battle_state.player_pokemon, battle_state.enemy_pokemon) {
    (Some(player), Some(enemy)) => {
      let attacker = if is_player { player } else { enemy }
      let defender = if is_player { enemy } else { player }
  
  let move_obj = create_move_from_name(move_name)
  let damage = calculate_damage(attacker, defender, move_obj)
  attacker.name + " used " + move_name + "! It dealt " + damage.to_string() + " damage!"
    }
    _ => "Battle not properly initialized"
  }
}

///|
// å¼€å§‹æˆ˜æ–—
pub fn start_battle(player_pokemon : Pokemon, enemy_pokemon : Pokemon) -> String {
  "Battle started! " + player_pokemon.name + " VS " + enemy_pokemon.name
}

///|
// é‡ç½®æˆ˜æ–—
pub fn reset_battle() -> Unit {
  println("Battle has been reset")
}

///|
// åˆ›å»ºæˆ˜æ–—çŠ¶æ€
pub fn create_battle_state(player_pokemon : Pokemon, enemy_pokemon : Pokemon) -> BattleState {
  BattleState::{
    is_active: true,
    turn: 1,
    current_turn_type: TurnType::PlayerTurn,
    player_pokemon: Some(player_pokemon),
    enemy_pokemon: Some(enemy_pokemon),
    battle_log: [],
    actions_this_turn: 0,
    max_actions_per_turn: 1
  }
}

///|
// æ›´æ–°æˆ˜æ–—çŠ¶æ€
pub fn update_battle_state_after_move(
  battle_state : BattleState, 
  move_name : String, 
  _is_player : Bool, 
  damage : Int, 
  _hit : Bool
) -> BattleState {
  let new_log = battle_state.battle_log + [move_name + " dealt " + damage.to_string() + " damage"]
  
  BattleState::{
    is_active: battle_state.is_active,
    turn: battle_state.turn,
    current_turn_type: battle_state.current_turn_type,
    player_pokemon: battle_state.player_pokemon,
    enemy_pokemon: battle_state.enemy_pokemon,
    battle_log: new_log,
    actions_this_turn: battle_state.actions_this_turn,
    max_actions_per_turn: battle_state.max_actions_per_turn
  }
}

///|
// ç»“æŸå›åˆ
pub fn end_turn(battle_state : BattleState) -> BattleState {
  BattleState::{
    is_active: battle_state.is_active,
    turn: battle_state.turn + 1,
    current_turn_type: battle_state.current_turn_type,
    player_pokemon: battle_state.player_pokemon,
    enemy_pokemon: battle_state.enemy_pokemon,
    battle_log: battle_state.battle_log,
    actions_this_turn: 0,
    max_actions_per_turn: battle_state.max_actions_per_turn
  }
}

///|
// é‡ç½®æˆ˜æ–—çŠ¶æ€
pub fn reset_battle_state(battle_state : BattleState) -> BattleState {
  BattleState::{
    is_active: true,
    turn: 1,
    current_turn_type: TurnType::PlayerTurn,
    player_pokemon: battle_state.player_pokemon,
    enemy_pokemon: battle_state.enemy_pokemon,
    battle_log: [],
    actions_this_turn: 0,
    max_actions_per_turn: 1
  }
}

///|
// è·å–æˆ˜æ–—çŠ¶æ€
pub fn get_battle_status(battle_state : BattleState) -> String {
  "Battle Status: Turn " + battle_state.turn.to_string() + ", Active: " + battle_state.is_active.to_string()
}

///|
// æ£€æŸ¥æˆ˜æ–—æ˜¯å¦ç»“æŸ
pub fn is_battle_finished(battle_state : BattleState) -> Bool {
  match (battle_state.player_pokemon, battle_state.enemy_pokemon) {
    (Some(player), Some(enemy)) => player.hp <= 0 || enemy.hp <= 0
    _ => false
  }
}

///|
// è·å–è·èƒœè€…
pub fn get_winner(battle_state : BattleState) -> String {
  match (battle_state.player_pokemon, battle_state.enemy_pokemon) {
    (Some(player), Some(enemy)) => {
      if player.hp <= 0 {
    "Enemy wins!"
      } else if enemy.hp <= 0 {
    "Player wins!"
  } else {
    "Battle still in progress"
      }
    }
    _ => "Battle not properly initialized"
  }
}

///|
// è·å–å¯ç”¨æŠ€èƒ½
pub fn get_available_moves(pokemon : Pokemon) -> Array[String] {
  pokemon.moves
}

///|
// æ›´æ–°å®å¯æ¢¦HP
pub fn update_pokemon_hp(pokemon : Pokemon, new_hp : Int) -> Pokemon {
  let clamped_hp = if new_hp < 0 { 0 } else if new_hp > pokemon.max_hp { pokemon.max_hp } else { new_hp }
  
  Pokemon::{
    id: pokemon.id,
    name: pokemon.name,
    level: pokemon.level,
    hp: clamped_hp,
    max_hp: pokemon.max_hp,
    attack: pokemon.attack,
    defense: pokemon.defense,
    speed: pokemon.speed,
    types: pokemon.types,
    moves: pokemon.moves
  }
}

///|
// ===== æˆ˜æ–—åœºæ™¯åŠŸèƒ½ =====


///|
// å¼€å§‹æˆ˜æ–—æ¸²æŸ“ï¼ˆç§»é™¤è¡€æ¡åˆå§‹åŒ–ï¼Œåªä¿ç•™å®å¯æ¢¦æ¸²æŸ“ï¼‰
pub fn start_battle_render(player_pokemon : Pokemon, enemy_pokemon : Pokemon) -> Unit {
  println("ğŸ® å¼€å§‹æˆ˜æ–—æ¸²æŸ“...")
  
  // ç¡®ä¿ç²¾çµé…ç½®å·²åˆå§‹åŒ–
  if pokemon_sprite_cache.size() == 0 {
    init_pokemon_sprite_configs()
  }
  
  // è®¾ç½®å½“å‰å®å¯æ¢¦æ•°æ®
  battle_render_state.current_player_pokemon = Some(player_pokemon)
  battle_render_state.current_enemy_pokemon = Some(enemy_pokemon)
  
  // åˆå§‹åŒ–æˆ˜æ–—çŠ¶æ€
  let initial_battle_state = BattleState::{
    is_active: true,
    turn: 1,
    current_turn_type: TurnType::PlayerTurn,
    player_pokemon: Some(player_pokemon),
    enemy_pokemon: Some(enemy_pokemon),
    battle_log: [],
    actions_this_turn: 0,
    max_actions_per_turn: 1
  }
  battle_render_state.battle_state = Some(initial_battle_state)
  
  // åˆå§‹åŒ–å›åˆæ˜¾ç¤º
  if turn_display_state.turn_display.is_none() {
    init_turn_display_system()
  }
  update_turn_display(1, "PlayerTurn")
  
  // æ¸²æŸ“å®å¯æ¢¦
  render_pokemon(player_pokemon, enemy_pokemon)
  
  println("âœ… æˆ˜æ–—æ¸²æŸ“å¼€å§‹ï¼Œæˆ˜æ–—çŠ¶æ€å·²åˆå§‹åŒ–")
  
  // åœ¨ start_battle_render å‡½æ•°ä¸­ï¼Œè®¾ç½®å®å¯æ¢¦æ•°æ®åæ·»åŠ ï¼š
  // æ›´æ–°æ–‡æœ¬æ¡†æ˜¾ç¤ºæ­£ç¡®çš„å®å¯æ¢¦åç§°
  update_text_box("æƒ³è¦" + player_pokemon.name + "åšä»€ä¹ˆ?")
}

///|
// æ¸²æŸ“å®å¯æ¢¦
fn render_pokemon(player_pokemon : Pokemon, enemy_pokemon : Pokemon) -> Unit {
  // åªæ¸²æŸ“å®å¯æ¢¦ç²¾çµï¼Œä¸é‡æ–°åˆ›å»ºè¡€æ¡
  render_player_pokemon(player_pokemon)
  render_enemy_pokemon(enemy_pokemon)
  
  // åªæ›´æ–°ç°æœ‰è¡€æ¡ï¼Œä¸é‡æ–°åˆ›å»º
  update_pokemon_status_display(player_pokemon, false)
  update_pokemon_status_display(enemy_pokemon, true)
}

///|
fn render_player_pokemon(pokemon : Pokemon) -> Unit {
  let entity = battle_render_state.player_pokemon_entity
  
  println("ğŸ¨ æ­£åœ¨æ¸²æŸ“ç©å®¶å®å¯æ¢¦: " + pokemon.name)
  
  // ä½¿ç”¨é¢„åŠ è½½çš„ç²¾çµ
  let pokemon_sprite = create_pokemon_sprite(pokemon, false) // false = èƒŒé¢
  
  @sprite.sprites.set(entity, pokemon_sprite)
  @position.positions.set(entity, @math.Vec2D(70.0, BATTLE_ARENA_HEIGHT - 64.0 - 70.0))
  
  println("âœ… ç©å®¶å®å¯æ¢¦ " + pokemon.name + " æ¸²æŸ“å®Œæˆ")
}

fn render_enemy_pokemon(pokemon : Pokemon) -> Unit {
  let entity = battle_render_state.enemy_pokemon_entity
  
  println("ğŸ¨ æ­£åœ¨æ¸²æŸ“æ•Œæ–¹å®å¯æ¢¦: " + pokemon.name)
  
  // ä½¿ç”¨é¢„åŠ è½½çš„ç²¾çµ
  let pokemon_sprite = create_pokemon_sprite(pokemon, true) // true = æ­£é¢
  
  @sprite.sprites.set(entity, pokemon_sprite)
  @position.positions.set(entity, @math.Vec2D(BATTLE_SCREEN_WIDTH - 64.0 - 70.0, 70.0))
  
  println("âœ… æ•Œæ–¹å®å¯æ¢¦ " + pokemon.name + " æ¸²æŸ“å®Œæˆ")
}

///|
// æ¸²æŸ“å®å¯æ¢¦çŠ¶æ€ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºæ¨¡ç‰ˆï¼‰
fn render_pokemon_status(pokemon : Pokemon, position : @math.Vec2D, is_enemy : Bool) -> Unit {
  // åˆ›å»ºå®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºé…ç½®
  let config = if is_enemy {
    {
      base_position: position,
      width: 200.0,
      height: 20.0,
      background_color: "#333333",
      fill_color: "#FF0000",  // çº¢è‰²
      text_color: "#FFFFFF",
      bar_type: HealthBarType::Enemy
    }
  } else {
    {
      base_position: position,
      width: 200.0,
      height: 20.0,
      background_color: "#333333",
      fill_color: "#00FF00",  // ç»¿è‰²
      text_color: "#FFFFFF",
      bar_type: HealthBarType::Player
    }
  }
  
  // åˆ›å»ºå®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºæ¨¡ç‰ˆ
  let pokemon_info = create_pokemon_info_template(config, pokemon.name, pokemon.level, pokemon.max_hp)
  
  // æ›´æ–°å…¨å±€çŠ¶æ€
  if is_enemy {
    battle_render_state.enemy_pokemon_info = Some(pokemon_info)
  } else {
    battle_render_state.player_pokemon_info = Some(pokemon_info)
  }
  
  println(" å®å¯æ¢¦çŠ¶æ€æ¸²æŸ“å®Œæˆ: " + pokemon.name + " Lv." + pokemon.level.to_string())
}

///|
// æ›´æ–°å®å¯æ¢¦çŠ¶æ€æ˜¾ç¤º
fn update_pokemon_status_display(pokemon : Pokemon, is_enemy : Bool) -> Unit {
  let pokemon_info_opt = if is_enemy {
    battle_render_state.enemy_pokemon_info
  } else {
    battle_render_state.player_pokemon_info
  }
  
  match pokemon_info_opt {
    Some(pokemon_info) => {
      // åªæ›´æ–°ç°æœ‰è¡€æ¡ï¼Œä¸é‡æ–°åˆ›å»º
      update_pokemon_info_display(pokemon_info, pokemon.name, pokemon.level, pokemon.hp, pokemon.max_hp)
    }
    None => {
      // åªæœ‰åœ¨è¡€æ¡ä¸å­˜åœ¨æ—¶æ‰åˆ›å»º
      let position = if is_enemy { @math.Vec2D(350.0, 50.0) } else { @math.Vec2D(450.0, 350.0) }
      render_pokemon_status(pokemon, position, is_enemy)
    }
  }
}

///|
// è¿›å…¥æŠ€èƒ½UIæ¨¡å¼
fn enter_skill_ui_mode() -> Unit {
  println("ğŸ¯ è¿›å…¥æŠ€èƒ½UIæ¨¡å¼")
  
  // ä»å½“å‰å®å¯æ¢¦è·å–æŠ€èƒ½åˆ—è¡¨
  let current_moves = get_current_player_moves()
  
  // è·å–å½“å‰é€‰ä¸­çš„æŠ€èƒ½
  if battle_render_state.skill_menu_selected >= 0 && battle_render_state.skill_menu_selected < current_moves.length() {
    let selected_skill = current_moves[battle_render_state.skill_menu_selected]
    println("âš”ï¸ å‡†å¤‡ä½¿ç”¨æŠ€èƒ½: " + selected_skill.name)
    
    // æ˜¾ç¤ºæŠ€èƒ½UIç•Œé¢
    show_skill_ui_interface(selected_skill)
    
    // æ‰§è¡ŒæŠ€èƒ½ - ç©å®¶æ”»å‡»
    execute_battle_skill(selected_skill, true)
  } else {
    println("âŒ æ— æ•ˆçš„æŠ€èƒ½é€‰æ‹©")
  }
}

///|
// åˆ‡æ¢æŠ€èƒ½èœå•
fn toggle_skill_menu() -> Unit {
  println("ğŸ”„ åˆ‡æ¢æŠ€èƒ½èœå•")
  
  if battle_render_state.skill_menu_visible {
    // å¦‚æœæŠ€èƒ½èœå•å·²ç»å¯è§ï¼Œéšè—å®ƒ
    battle_render_state.skill_menu_visible = false
    hide_skill_menu_ui()
  } else {
    // å¦‚æœæŠ€èƒ½èœå•ä¸å¯è§ï¼Œæ˜¾ç¤ºå®ƒ
    battle_render_state.skill_menu_visible = true
  battle_render_state.skill_menu_selected = 0
    show_skill_menu_ui()
  }
}

///|
// å…¨å±€æŠ€èƒ½èœå•å®ä½“ç®¡ç† - ä½¿ç”¨ç»“æ„ä½“æ¥ç®¡ç†æ‰€æœ‰å®ä½“
pub struct SkillMenuEntities {
  background_entity: @system.Entity
  title_entity: @system.Entity
  skill_entities: Array[@system.Entity]
  selector_entity: @system.Entity
}

///|
// å…¨å±€æŠ€èƒ½èœå•å®ä½“ - ç§»é™¤mutï¼Œä½¿ç”¨ç»“æ„ä½“åŒ…è£…
pub struct SkillMenuState {
  mut entities: Option[SkillMenuEntities]
}

let skill_menu_state: SkillMenuState = {
  entities: None
}

///|
// å…¨å±€æŠ€èƒ½é€‰æ‹©æŒ‡ç¤ºå™¨å®ä½“
let skill_selector_entity : @system.Entity = @system.Entity::new()

///|
// æ˜¾ç¤ºæŠ€èƒ½èœå•UI
fn show_skill_menu_ui() -> Unit {
  println("ğŸ¯ æ˜¾ç¤ºæŠ€èƒ½èœå•UI")
  
  // å…ˆæ¸…ç†ä¹‹å‰çš„æŠ€èƒ½èœå•å®ä½“
  clear_skill_menu_entities()
  
  // è·å–å½“å‰ç©å®¶å®å¯æ¢¦çš„æŠ€èƒ½
  let current_moves = get_current_player_moves()
  
  if current_moves.length() > 0 {
    // åˆ›å»ºæŠ€èƒ½èœå•èƒŒæ™¯
    let menu_bg_entity = @system.Entity::new()
    let menu_bg_sprite = @sprite.Sprite::from_color_rect(
      @sprite.ColorRect::new(
        @math.Vec2D(300.0, 200.0),
        "#2C3E50"
      ),
      14
    )
    @sprite.sprites.set(menu_bg_entity, menu_bg_sprite)
    @position.positions.set(menu_bg_entity, @math.Vec2D(250.0, 200.0))
    
    // åˆ›å»ºæŠ€èƒ½åˆ—è¡¨æ ‡é¢˜
    let title_entity = @system.Entity::new()
    let title_sprite = @sprite.Sprite::from_text(
      @sprite.Text::new(
        "é€‰æ‹©æŠ€èƒ½",
        color="#FFFFFF",
        font="18px Arial"
      ),
      15
    )
    @sprite.sprites.set(title_entity, title_sprite)
    @position.positions.set(title_entity, @math.Vec2D(270.0, 220.0))
    
    // åˆ›å»ºæŠ€èƒ½é€‰æ‹©æŒ‡ç¤ºå™¨
    let selector_entity = @system.Entity::new()
    let selector_sprite = @sprite.Sprite::from_text(
      @sprite.Text::new(
        "â–¶",
        color="#F39C12",
        font="16px Arial"
      ),
      16
    )
    @sprite.sprites.set(selector_entity, selector_sprite)
    @position.positions.set(selector_entity, @math.Vec2D(270.0, 250.0))
    
    // åˆ›å»ºæŠ€èƒ½åˆ—è¡¨å®ä½“
    let skill_entities = create_skill_list_entities(current_moves)
    
    // ä¿å­˜æ‰€æœ‰å®ä½“
    skill_menu_state.entities = Some(SkillMenuEntities::{
      background_entity: menu_bg_entity,
      title_entity: title_entity,
      skill_entities: skill_entities,
      selector_entity: selector_entity
    })
  } else {
    println("âŒ å½“å‰å®å¯æ¢¦æ²¡æœ‰æŠ€èƒ½")
  }
}

///|
// åˆ›å»ºæŠ€èƒ½åˆ—è¡¨å®ä½“
fn create_skill_list_entities(moves: Array[Move]) -> Array[@system.Entity] {
  let skill_entities: Array[@system.Entity] = []
  
  for i = 0; i < moves.length(); i = i + 1 {
    let move = moves[i]
    let skill_entity = @system.Entity::new()
    let skill_sprite = @sprite.Sprite::from_text(
      @sprite.Text::new(
        move.name + " (å¨åŠ›:" + move.power.to_string() + " " + move.element_type + ")",
        color="#FFFFFF",
        font="14px Arial"
      ),
      17 + i
    )
    @sprite.sprites.set(skill_entity, skill_sprite)
    @position.positions.set(skill_entity, @math.Vec2D(290.0, 250.0 + i.to_double() * 25.0))
    skill_entities.push(skill_entity)
  }
  
  skill_entities
}

///|
// æ¸…ç†æŠ€èƒ½èœå•å®ä½“
fn clear_skill_menu_entities() -> Unit {
  match skill_menu_state.entities {
    Some(entities) => {
      // æ¸…ç†èƒŒæ™¯
      @sprite.sprites.remove(entities.background_entity)
      @position.positions.remove(entities.background_entity)
      
      // æ¸…ç†æ ‡é¢˜
      @sprite.sprites.remove(entities.title_entity)
      @position.positions.remove(entities.title_entity)
      
      // æ¸…ç†æ‰€æœ‰æŠ€èƒ½å®ä½“
      for skill_entity in entities.skill_entities {
        @sprite.sprites.remove(skill_entity)
        @position.positions.remove(skill_entity)
      }
      
      // æ¸…ç†é€‰æ‹©æŒ‡ç¤ºå™¨
      @sprite.sprites.remove(entities.selector_entity)
      @position.positions.remove(entities.selector_entity)
      
      // æ¸…ç©ºå®ä½“
      skill_menu_state.entities = None
    }
    None => {
      // æ¸…ç†æ—§çš„æŠ€èƒ½é€‰æ‹©æŒ‡ç¤ºå™¨
      @sprite.sprites.remove(skill_selector_entity)
      @position.positions.remove(skill_selector_entity)
    }
  }
  
  println("ğŸ§¹ æŠ€èƒ½èœå•å®ä½“æ¸…ç†å®Œæˆ")
}

///|
// åˆ›å»ºæŠ€èƒ½é€‰æ‹©æŒ‡ç¤ºå™¨
fn create_skill_selector() -> Unit {
  let selector_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(
      "â–¶",
      color="#F39C12",
      font="16px Arial"
    ),
    16
  )
  @sprite.sprites.set(skill_selector_entity, selector_sprite)
  // é»˜è®¤æŒ‡å‘ç¬¬ä¸€ä¸ªæŠ€èƒ½
  @position.positions.set(skill_selector_entity, @math.Vec2D(270.0, 250.0))
}

///|
// æ˜¾ç¤ºæŠ€èƒ½åˆ—è¡¨
fn show_skill_list(moves: Array[Move]) -> Unit {
  println("ğŸ¯ æ˜¾ç¤ºæŠ€èƒ½åˆ—è¡¨ï¼Œå…± " + moves.length().to_string() + " ä¸ªæŠ€èƒ½")
  
  for i = 0; i < moves.length(); i = i + 1 {
    let move = moves[i]
    let skill_entity = @system.Entity::new()
    let skill_sprite = @sprite.Sprite::from_text(
      @sprite.Text::new(
        move.name + " (å¨åŠ›:" + move.power.to_string() + " " + move.element_type + ")",
        color="#FFFFFF",
        font="14px Arial"
      ),
      17 + i
    )
    @sprite.sprites.set(skill_entity, skill_sprite)
    @position.positions.set(skill_entity, @math.Vec2D(290.0, 250.0 + i.to_double() * 25.0))
  }
}

///|
// å¤„ç†æŠ€èƒ½èœå•è¾“å…¥ï¼ˆå¸¦é˜²æŠ–ï¼‰
fn handle_skill_menu_input() -> Unit {
  let current_frame = get_current_frame_count()
  
  // æ£€æŸ¥æ˜¯å¦åœ¨é˜²æŠ–æœŸå†…
  if current_frame - battle_render_state.last_skill_input_frame < SKILL_INPUT_COOLDOWN_FRAMES {
    return
  }
  
  // å¤„ç†ä¸Šä¸‹ç®­å¤´é”®é€‰æ‹©æŠ€èƒ½
  if @system.is_pressed(@system.ArrowUp) {
    move_skill_selection_up()
    battle_render_state.last_skill_input_frame = current_frame
  }
  
  if @system.is_pressed(@system.ArrowDown) {
    move_skill_selection_down()
    battle_render_state.last_skill_input_frame = current_frame
  }
  
  // å¤„ç†ç¡®è®¤é€‰æ‹© - Zé”®é€‰æ‹©æŠ€èƒ½
  if @system.is_pressed(@system.KeyZ) {
    select_current_skill()
    battle_render_state.last_skill_input_frame = current_frame
  }
  
  // å¤„ç†å–æ¶ˆé€‰æ‹© - Xé”®è¿”å›ä¸»èœå•
  if @system.is_pressed(@system.KeyX) {
    cancel_skill_selection()
    battle_render_state.last_skill_input_frame = current_frame
  }
}

///|
// å‘ä¸Šç§»åŠ¨æŠ€èƒ½é€‰æ‹©
fn move_skill_selection_up() -> Unit {
  let current_moves = get_current_player_moves()
  if current_moves.length() > 0 {
    battle_render_state.skill_menu_selected = if battle_render_state.skill_menu_selected > 0 {
      battle_render_state.skill_menu_selected - 1
    } else {
      current_moves.length() - 1
    }
    update_skill_selector_position()
    println("â¬†ï¸ é€‰æ‹©æŠ€èƒ½: " + current_moves[battle_render_state.skill_menu_selected].name)
  }
}

///|
// å‘ä¸‹ç§»åŠ¨æŠ€èƒ½é€‰æ‹©
fn move_skill_selection_down() -> Unit {
  let current_moves = get_current_player_moves()
  if current_moves.length() > 0 {
    battle_render_state.skill_menu_selected = if battle_render_state.skill_menu_selected < current_moves.length() - 1 {
      battle_render_state.skill_menu_selected + 1
    } else {
      0
    }
    update_skill_selector_position()
    println("â¬‡ï¸ é€‰æ‹©æŠ€èƒ½: " + current_moves[battle_render_state.skill_menu_selected].name)
  }
}

///|
// æ›´æ–°æŠ€èƒ½é€‰æ‹©æŒ‡ç¤ºå™¨ä½ç½®
fn update_skill_selector_position() -> Unit {
  match skill_menu_state.entities {
    Some(entities) => {
      // è®¡ç®—æŒ‡ç¤ºå™¨ä½ç½®
      let y_position = 250.0 + battle_render_state.skill_menu_selected.to_double() * 25.0
      
      // æ›´æ–°é€‰æ‹©æŒ‡ç¤ºå™¨ä½ç½®
      @position.positions.set(entities.selector_entity, @math.Vec2D(270.0, y_position))
      println("ğŸ¯ æ›´æ–°æŠ€èƒ½é€‰æ‹©æŒ‡ç¤ºå™¨ä½ç½®: " + y_position.to_string())
    }
    None => {
      println("âŒ æŠ€èƒ½èœå•å®ä½“æœªåˆ›å»º")
    }
  }
}

///|
// é€‰æ‹©å½“å‰æŠ€èƒ½
fn select_current_skill() -> Unit {
  let current_moves = get_current_player_moves()
  if battle_render_state.skill_menu_selected >= 0 && battle_render_state.skill_menu_selected < current_moves.length() {
    let selected_skill = current_moves[battle_render_state.skill_menu_selected]
    println("âœ… é€‰æ‹©äº†æŠ€èƒ½: " + selected_skill.name)
    
    // éšè—æŠ€èƒ½èœå•
    battle_render_state.skill_menu_visible = false
    hide_skill_menu_ui()
    
    // æ‰§è¡ŒæŠ€èƒ½
    execute_battle_skill(selected_skill, true)
  } else {
    println("âŒ æ— æ•ˆçš„æŠ€èƒ½é€‰æ‹©")
  }
}

///|
// å–æ¶ˆæŠ€èƒ½é€‰æ‹©
fn cancel_skill_selection() -> Unit {
  println("âŒ å–æ¶ˆæŠ€èƒ½é€‰æ‹©")
  battle_render_state.skill_menu_visible = false
  battle_render_state.skill_menu_selected = 0
  hide_skill_menu_ui()
}

// æ·»åŠ ç¼ºå°‘çš„å˜é‡å’Œå‡½æ•°
let battle_skills : Array[Move] = []
///|
// æ˜¾ç¤ºæŠ€èƒ½UIç•Œé¢
fn show_skill_ui_interface(skill: Move) -> Unit {
  println("ğŸ¨ æ˜¾ç¤ºæŠ€èƒ½UIç•Œé¢: " + skill.name)
  
  // åˆ›å»ºæŠ€èƒ½ä½¿ç”¨åŠ¨ç”» - æ˜¾ç¤ºåœ¨å±å¹•é¡¶éƒ¨ä¸­å¤®ï¼Œé¿å…ä¸èœå•é‡å 
  let skill_animation_entity = @system.Entity::new()
  let animation_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(
      " " + skill.name + " ",
      color="#FF6B6B",
      font="20px Arial"
    ),
    16
  )
  @sprite.sprites.set(skill_animation_entity, animation_sprite)
  @position.positions.set(skill_animation_entity, @math.Vec2D(400.0, 100.0))
  
  // åˆ›å»ºæŠ€èƒ½æ•ˆæœæ–‡æœ¬ - æ˜¾ç¤ºåœ¨æŠ€èƒ½åç§°ä¸‹æ–¹
  let effect_entity = @system.Entity::new()
  let effect_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(
      "æ•ˆæœ: " + skill.name,
      color="#FFFFFF",
      font="14px Arial"
    ),
    16
  )
  @sprite.sprites.set(effect_entity, effect_sprite)
  @position.positions.set(effect_entity, @math.Vec2D(400.0, 130.0))
}

///|
// æ‰§è¡Œæˆ˜æ–—æŠ€èƒ½
fn execute_battle_skill(skill: Move, is_player_attacking: Bool) -> Unit {
  println("âš”ï¸ æ‰§è¡ŒæŠ€èƒ½: " + skill.name)
  
  // è·å–å½“å‰æˆ˜æ–—ä¸­çš„å®å¯æ¢¦
  match battle_render_state.current_player_pokemon {
    Some(player_pokemon) => {
      match battle_render_state.current_enemy_pokemon {
        Some(enemy_pokemon) => {
          // æ ¹æ®æ”»å‡»è€…ç¡®å®šæ”»å‡»è€…å’Œé˜²å¾¡è€…
          let (attacker, defender) = if is_player_attacking {
            (player_pokemon, enemy_pokemon)
          } else {
            (enemy_pokemon, player_pokemon)
          }
          
          // è®¡ç®—ä¼¤å®³
          let damage = calculate_damage(attacker, defender, skill)
          
          // æ›´æ–°è¢«æ”»å‡»æ–¹çš„HP
          let new_defender_hp = if defender.hp > damage { 
            defender.hp - damage 
          } else { 
            0 
          }
          
          let updated_defender = update_pokemon_hp(defender, new_defender_hp)
          
          // æ ¹æ®æ”»å‡»è€…æ›´æ–°å¯¹åº”çš„å…¨å±€çŠ¶æ€
          if is_player_attacking {
            // ç©å®¶æ”»å‡»ï¼Œæ›´æ–°æ•Œæ–¹å®å¯æ¢¦
            battle_render_state.current_enemy_pokemon = Some(updated_defender)
            // åŒæ­¥æ›´æ–°æˆ˜æ–—çŠ¶æ€ä¸­çš„æ•Œæ–¹å®å¯æ¢¦
            match battle_render_state.battle_state {
              Some(state) => {
                let updated_battle_state = BattleState::{
                  is_active: state.is_active,
                  turn: state.turn,
                  current_turn_type: state.current_turn_type,
                  player_pokemon: state.player_pokemon,
                  enemy_pokemon: Some(updated_defender), // æ›´æ–°æ•Œæ–¹å®å¯æ¢¦
                  battle_log: state.battle_log,
                  actions_this_turn: state.actions_this_turn,
                  max_actions_per_turn: state.max_actions_per_turn
                }
                battle_render_state.battle_state = Some(updated_battle_state)
              }
              None => ()
            }
            // æ›´æ–°æ•Œæ–¹è¡€æ¡ - ä½¿ç”¨æ–°çš„ç»Ÿä¸€æ›´æ–°å‡½æ•°
            match battle_render_state.enemy_pokemon_info {
              Some(pokemon_info) => {
                update_pokemon_info_display(pokemon_info, updated_defender.name, updated_defender.level, updated_defender.hp, updated_defender.max_hp)
              }
              None => {
                println("âŒ æ•Œæ–¹å®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºæœªåˆ›å»º")
              }
            }
          } else {
            // æ•Œæ–¹æ”»å‡»ï¼Œæ›´æ–°ç©å®¶å®å¯æ¢¦
            battle_render_state.current_player_pokemon = Some(updated_defender)
            // åŒæ­¥æ›´æ–°æˆ˜æ–—çŠ¶æ€ä¸­çš„ç©å®¶å®å¯æ¢¦
            match battle_render_state.battle_state {
              Some(state) => {
                let updated_battle_state = BattleState::{
                  is_active: state.is_active,
                  turn: state.turn,
                  current_turn_type: state.current_turn_type,
                  player_pokemon: Some(updated_defender), // æ›´æ–°ç©å®¶å®å¯æ¢¦
                  enemy_pokemon: state.enemy_pokemon,
                  battle_log: state.battle_log,
                  actions_this_turn: state.actions_this_turn,
                  max_actions_per_turn: state.max_actions_per_turn
                }
                battle_render_state.battle_state = Some(updated_battle_state)
              }
              None => ()
            }
            // æ›´æ–°ç©å®¶è¡€æ¡ - ä½¿ç”¨æ–°çš„ç»Ÿä¸€æ›´æ–°å‡½æ•°
            match battle_render_state.player_pokemon_info {
              Some(pokemon_info) => {
                update_pokemon_info_display(pokemon_info, updated_defender.name, updated_defender.level, updated_defender.hp, updated_defender.max_hp)
              }
              None => {
                println("âŒ ç©å®¶å®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºæœªåˆ›å»º")
              }
            }
          }
          
          // æ˜¾ç¤ºä¼¤å®³ä¿¡æ¯
          let damage_message = attacker.name + " ä½¿ç”¨äº† " + skill.name + "! å¯¹ " + 
                              defender.name + " é€ æˆäº† " + damage.to_string() + " ç‚¹ä¼¤å®³!"
          println(" " + damage_message)
          
          // æ›´æ–°æ–‡æœ¬æ¡†æ˜¾ç¤ºä¼¤å®³ä¿¡æ¯
          update_text_box(damage_message)
          
          // æ£€æŸ¥è¢«æ”»å‡»æ–¹æ˜¯å¦è¢«å‡»è´¥
          if new_defender_hp <= 0 {
            let victory_message = defender.name + " è¢«å‡»è´¥äº†! " + attacker.name + " è·èƒœ!"
            println("ğŸ‰ " + victory_message)
            update_text_box(victory_message)
          }
          
          // é‡æ–°æ¸²æŸ“å®å¯æ¢¦çŠ¶æ€
          let (updated_player, updated_enemy) = if is_player_attacking {
            (player_pokemon, updated_defender)
          } else {
            (updated_defender, enemy_pokemon)
          }
          
          render_pokemon(updated_player, updated_enemy)
          
          // å¢åŠ è¡ŒåŠ¨æ¬¡æ•°
          increment_actions_this_turn()
          
          // æ·»åŠ ï¼šç©å®¶æ”»å‡»åç»“æŸå›åˆï¼Œè§¦å‘æ•Œäººå›åˆ
          if is_player_attacking {
            end_current_turn()
          }
        }
        None => {
          println("âŒ æ²¡æœ‰æ‰¾åˆ°æ•Œæ–¹å®å¯æ¢¦")
        }
      }
    }
    None => {
      println("âŒ æ²¡æœ‰æ‰¾åˆ°ç©å®¶å®å¯æ¢¦")
    }
  }
}

///|
// å¢åŠ å½“å‰å›åˆçš„è¡ŒåŠ¨æ¬¡æ•°
fn increment_actions_this_turn() -> Unit {
  match battle_render_state.battle_state {
    Some(state) => {
      let new_actions = state.actions_this_turn + 1
      let updated_state = BattleState::{
        is_active: state.is_active,
        turn: state.turn,
        current_turn_type: state.current_turn_type,
        player_pokemon: state.player_pokemon,
        enemy_pokemon: state.enemy_pokemon,
        battle_log: state.battle_log,
        actions_this_turn: new_actions,
        max_actions_per_turn: state.max_actions_per_turn
      }
      battle_render_state.battle_state = Some(updated_state)
      println("ğŸ“Š è¡ŒåŠ¨æ¬¡æ•°: " + new_actions.to_string() + "/" + state.max_actions_per_turn.to_string())
    }
    None => {
      println("âŒ æˆ˜æ–—çŠ¶æ€æœªåˆå§‹åŒ–")
    }
  }
}

///|
// å›åˆç±»å‹æšä¸¾
pub enum TurnType {
  PlayerTurn
  EnemyTurn
} derive(Show, Eq)

///|
// æˆ˜æ–—çŠ¶æ€ï¼ˆå¢å¼ºç‰ˆï¼‰
pub struct BattleState {
  is_active: Bool
  turn: Int
  current_turn_type: TurnType
  player_pokemon: Option[Pokemon]
  enemy_pokemon: Option[Pokemon]
  battle_log: Array[String]
  actions_this_turn: Int
  max_actions_per_turn: Int
} derive(Show)

///|
// å¼€å§‹æ–°å›åˆ
pub fn start_new_turn() -> Unit {
  match battle_render_state.battle_state {
    Some(state) => {
      let new_turn = state.turn + 1
      let new_turn_type = if state.current_turn_type == TurnType::PlayerTurn {
        TurnType::EnemyTurn
      } else {
        TurnType::PlayerTurn
      }
      
      let updated_state = BattleState::{
        is_active: state.is_active,
        turn: new_turn,
        current_turn_type: new_turn_type,
        player_pokemon: state.player_pokemon,
        enemy_pokemon: state.enemy_pokemon,
        battle_log: state.battle_log,
        actions_this_turn: 0,
        max_actions_per_turn: state.max_actions_per_turn
      }
      
      battle_render_state.battle_state = Some(updated_state)
      
      let turn_name = match new_turn_type {
        TurnType::PlayerTurn => "æƒ³è¦" + get_current_player_pokemon_name() + "åšä»€ä¹ˆ?"
        TurnType::EnemyTurn => "ç¬¬ " + new_turn.to_string() + " å›åˆ - " + "æ•Œäºº" + " çš„å›åˆ"
      }
      
      let turn_type_string = match new_turn_type {
        TurnType::PlayerTurn => "PlayerTurn"
        TurnType::EnemyTurn => "EnemyTurn"
      }
      
      println("ğŸ”„ å¼€å§‹ç¬¬ " + new_turn.to_string() + " å›åˆ - " + turn_name)
      update_text_box(turn_name)
      
      // æ›´æ–°å›åˆæ˜¾ç¤º
      update_turn_display(new_turn, turn_type_string)
    }
    None => {
      println("âŒ æˆ˜æ–—çŠ¶æ€æœªåˆå§‹åŒ–")
    }
  }
}

///|
// æ£€æŸ¥æ˜¯å¦å¯ä»¥è¡ŒåŠ¨
pub fn can_act() -> Bool {
  match battle_render_state.battle_state {
    Some(state) => {
      state.actions_this_turn < state.max_actions_per_turn
    }
    None => false
  }
}

///|
// æ£€æŸ¥æ˜¯å¦æ˜¯ç©å®¶å›åˆ
pub fn is_player_turn() -> Bool {
  match battle_render_state.battle_state {
    Some(state) => {
      state.current_turn_type == TurnType::PlayerTurn
    }
    None => false
  }
}

///|
// æ£€æŸ¥æ˜¯å¦æ˜¯æ•Œäººå›åˆ
pub fn is_enemy_turn() -> Bool {
  match battle_render_state.battle_state {
    Some(state) => {
      state.current_turn_type == TurnType::EnemyTurn
    }
    None => false
  }
}

///|
// æ‰§è¡Œè¡ŒåŠ¨ï¼ˆå¢åŠ å›åˆæ£€æŸ¥ï¼‰
pub fn execute_action() -> Unit {
  if !can_act() {
    println("âŒ æœ¬å›åˆå·²æ— æ³•è¡ŒåŠ¨")
    return
  }
  
  if is_player_turn() {
    println(" ç©å®¶å›åˆ - ç­‰å¾…ç©å®¶é€‰æ‹©æŠ€èƒ½")
    // ç©å®¶å›åˆé€»è¾‘
  } else if is_enemy_turn() {
    println("ğŸ¤– æ•Œäººå›åˆ - è‡ªåŠ¨é€‰æ‹©æŠ€èƒ½")
    // æ•Œäººå›åˆé€»è¾‘
    execute_enemy_turn()
  }
}

///|
// æ‰§è¡Œæ•Œäººå›åˆ
fn execute_enemy_turn() -> Unit {
  match battle_render_state.current_enemy_pokemon {
    Some(enemy_pokemon) => {
      // æ•Œäººéšæœºé€‰æ‹©ä¸€ä¸ªæŠ€èƒ½
      let moves = get_pokemon_moves(enemy_pokemon)
      if moves.length() > 0 {
        // åˆ›å»ºéšæœºæ•°ç”Ÿæˆå™¨å¹¶ç”Ÿæˆéšæœºç´¢å¼•
        let rng = @random.Rand::chacha8()
        let random_index = rng.int(limit=moves.length())
        match moves.get(random_index) {
          Some(skill) => {
            println(" æ•Œäººé€‰æ‹©äº†æŠ€èƒ½: " + skill.name)
            execute_battle_skill(skill, false) // false è¡¨ç¤ºæ•Œäººæ”»å‡»
            end_current_turn()
          }
          None => {
            println("âŒ æ•Œäººæ²¡æœ‰å¯ç”¨æŠ€èƒ½")
            end_current_turn()
          }
        }
      } else {
        println("âŒ æ•Œäººæ²¡æœ‰æŠ€èƒ½")
        end_current_turn()
      }
    }
    None => {
      println("âŒ æ²¡æœ‰æ‰¾åˆ°æ•Œäººå®å¯æ¢¦")
      end_current_turn()
    }
  }
}

///|
// ç»“æŸå½“å‰å›åˆ
pub fn end_current_turn() -> Unit {
  match battle_render_state.battle_state {
    Some(state) => {
      // é¦–å…ˆæ£€æŸ¥æˆ˜æ–—æ˜¯å¦å·²ç»ç»“æŸ
      if is_battle_finished(state) {
        let winner = get_winner(state)
        println(" æˆ˜æ–—ç»“æŸ! " + winner)
        update_text_box("æˆ˜æ–—ç»“æŸ! " + winner)
        
        // è®¾ç½®æˆ˜æ–—çŠ¶æ€ä¸ºä¸æ´»è·ƒ
        let ended_state = BattleState::{
          is_active: false,
          turn: state.turn,
          current_turn_type: state.current_turn_type,
          player_pokemon: state.player_pokemon,
          enemy_pokemon: state.enemy_pokemon,
          battle_log: state.battle_log,
          actions_this_turn: state.actions_this_turn,
          max_actions_per_turn: state.max_actions_per_turn
        }
        battle_render_state.battle_state = Some(ended_state)
        return
      }
      
      if state.actions_this_turn >= state.max_actions_per_turn {
        println("ğŸ”„ å›åˆç»“æŸï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå›åˆ")
        start_new_turn()
        // æ·»åŠ ï¼šå¦‚æœåˆ‡æ¢åˆ°æ•Œäººå›åˆï¼Œç«‹å³æ‰§è¡Œ
        if is_enemy_turn() {
          execute_enemy_turn()
        }
      } else {
        println("âš ï¸ æœ¬å›åˆè¿˜æœ‰è¡ŒåŠ¨æ¬¡æ•°å‰©ä½™: " + state.actions_this_turn.to_string() + "/" + state.max_actions_per_turn.to_string())
      }
    }
    None => {
      println("âŒ æˆ˜æ–—çŠ¶æ€æœªåˆå§‹åŒ–")
    }
  }
}
///|
// éšè—æŠ€èƒ½èœå•UI
fn hide_skill_menu_ui() -> Unit {
  println("âŒ éšè—æŠ€èƒ½èœå•UI")
  
  // æ¸…ç†æŠ€èƒ½èœå•å®ä½“
  clear_skill_menu_entities()
  
  // é‡ç½®æŠ€èƒ½èœå•çŠ¶æ€
  battle_render_state.skill_menu_visible = false
  battle_render_state.skill_menu_selected = 0
  
  println("æŠ€èƒ½èœå•çŠ¶æ€å·²é‡ç½®")
}

///|
// è·å–å½“å‰ç©å®¶å®å¯æ¢¦çš„æŠ€èƒ½
fn get_current_player_moves() -> Array[Move] {
  match battle_render_state.current_player_pokemon {
    Some(pokemon) => get_pokemon_moves(pokemon)
    None => []
  }
}

///|
// è·å–å½“å‰ç©å®¶å®å¯æ¢¦åç§°
fn get_current_player_pokemon_name() -> String {
  match battle_render_state.current_player_pokemon {
    Some(pokemon) => pokemon.name
    None => "å®å¯æ¢¦"
  }
}

///|
// è·å–ç±»å‹å…‹åˆ¶ä¿®æ­£å™¨
fn get_type_effectiveness_multiplier(move_type : String, defender_types : Array[PokemonType]) -> Double {
  let mut total_multiplier = 1.0
  
  for defender_type in defender_types {
    let type_multiplier = get_single_type_effectiveness(move_type, defender_type)
    total_multiplier = total_multiplier * type_multiplier
  }
  
  total_multiplier
}

///|
// è·å–å•ä¸ªç±»å‹çš„å…‹åˆ¶å…³ç³»
fn get_single_type_effectiveness(move_type : String, defender_type : PokemonType) -> Double {
  match move_type {
    "Normal" => match defender_type {
      PokemonType::Rock => 0.5
      PokemonType::Steel => 0.5
      PokemonType::Ghost => 0.0
      _ => 1.0
    }
    "Fire" => match defender_type {
      PokemonType::Fire => 0.5
      PokemonType::Water => 0.5
      PokemonType::Grass => 2.0
      PokemonType::Ice => 2.0
      PokemonType::Bug => 2.0
      PokemonType::Steel => 2.0
      PokemonType::Rock => 0.5
      PokemonType::Dragon => 0.5
      _ => 1.0
    }
    "Water" => match defender_type {
      PokemonType::Fire => 2.0
      PokemonType::Water => 0.5
      PokemonType::Grass => 0.5
      PokemonType::Ground => 2.0
      PokemonType::Rock => 2.0
      PokemonType::Dragon => 0.5
      _ => 1.0
    }
    "Electric" => match defender_type {
      PokemonType::Water => 2.0
      PokemonType::Electric => 0.5
      PokemonType::Grass => 0.5
      PokemonType::Ground => 0.0
      PokemonType::Flying => 2.0
      PokemonType::Dragon => 0.5
      _ => 1.0
    }
    "Grass" => match defender_type {
      PokemonType::Fire => 0.5
      PokemonType::Water => 2.0
      PokemonType::Grass => 0.5
      PokemonType::Poison => 0.5
      PokemonType::Ground => 2.0
      PokemonType::Flying => 0.5
      PokemonType::Bug => 0.5
      PokemonType::Rock => 2.0
      PokemonType::Dragon => 0.5
      PokemonType::Steel => 0.5
      _ => 1.0
    }
    "Ice" => match defender_type {
      PokemonType::Fire => 0.5
      PokemonType::Water => 0.5
      PokemonType::Grass => 2.0
      PokemonType::Ice => 0.5
      PokemonType::Ground => 2.0
      PokemonType::Flying => 2.0
      PokemonType::Dragon => 2.0
      PokemonType::Steel => 0.5
      _ => 1.0
    }
    "Fighting" => match defender_type {
      PokemonType::Normal => 2.0
      PokemonType::Ice => 2.0
      PokemonType::Poison => 0.5
      PokemonType::Flying => 0.5
      PokemonType::Psychic => 0.5
      PokemonType::Bug => 0.5
      PokemonType::Rock => 2.0
      PokemonType::Ghost => 0.0
      PokemonType::Dark => 2.0
      PokemonType::Steel => 2.0
      PokemonType::Fairy => 0.5
      _ => 1.0
    }
    "Poison" => match defender_type {
      PokemonType::Grass => 2.0
      PokemonType::Poison => 0.5
      PokemonType::Ground => 0.5
      PokemonType::Rock => 0.5
      PokemonType::Ghost => 0.5
      PokemonType::Steel => 0.0
      PokemonType::Fairy => 2.0
      _ => 1.0
    }
    "Ground" => match defender_type {
      PokemonType::Fire => 2.0
      PokemonType::Electric => 2.0
      PokemonType::Grass => 0.5
      PokemonType::Poison => 2.0
      PokemonType::Flying => 0.0
      PokemonType::Bug => 0.5
      PokemonType::Rock => 2.0
      PokemonType::Steel => 2.0
      _ => 1.0
    }
    "Flying" => match defender_type {
      PokemonType::Electric => 0.5
      PokemonType::Grass => 2.0
      PokemonType::Fighting => 2.0
      PokemonType::Bug => 2.0
      PokemonType::Rock => 0.5
      _ => 1.0
    }
    "Psychic" => match defender_type {
      PokemonType::Fighting => 2.0
      PokemonType::Poison => 2.0
      PokemonType::Psychic => 0.5
      PokemonType::Dark => 0.0
      PokemonType::Steel => 0.5
      _ => 1.0
    }
    "Bug" => match defender_type {
      PokemonType::Fire => 0.5
      PokemonType::Grass => 2.0
      PokemonType::Fighting => 0.5
      PokemonType::Poison => 0.5
      PokemonType::Flying => 0.5
      PokemonType::Psychic => 2.0
      PokemonType::Ghost => 0.5
      PokemonType::Dark => 2.0
      PokemonType::Steel => 0.5
      PokemonType::Fairy => 0.5
      _ => 1.0
    }
    "Rock" => match defender_type {
      PokemonType::Fire => 2.0
      PokemonType::Ice => 2.0
      PokemonType::Fighting => 0.5
      PokemonType::Ground => 0.5
      PokemonType::Flying => 2.0
      PokemonType::Bug => 2.0
      PokemonType::Steel => 0.5
      _ => 1.0
    }
    "Ghost" => match defender_type {
      PokemonType::Normal => 0.0
      PokemonType::Psychic => 2.0
      PokemonType::Ghost => 2.0
      PokemonType::Dark => 0.5
      _ => 1.0
    }
    "Dragon" => match defender_type {
      PokemonType::Dragon => 2.0
      PokemonType::Steel => 0.5
      PokemonType::Fairy => 0.0
      _ => 1.0
    }
    "Dark" => match defender_type {
      PokemonType::Fighting => 0.5
      PokemonType::Psychic => 2.0
      PokemonType::Ghost => 2.0
      PokemonType::Dark => 0.5
      PokemonType::Fairy => 0.5
      _ => 1.0
    }
    "Steel" => match defender_type {
      PokemonType::Fire => 0.5
      PokemonType::Water => 0.5
      PokemonType::Electric => 0.5
      PokemonType::Ice => 2.0
      PokemonType::Rock => 2.0
      PokemonType::Steel => 0.5
      PokemonType::Fairy => 2.0
      _ => 1.0
    }
    "Fairy" => match defender_type {
      PokemonType::Fire => 0.5
      PokemonType::Fighting => 2.0
      PokemonType::Poison => 0.5
      PokemonType::Dragon => 2.0
      PokemonType::Dark => 2.0
      PokemonType::Steel => 0.5
      _ => 1.0
    }
    _ => 1.0  // Default case for unknown move types
  }
}

///|
// ===== å®å¯æ¢¦ç²¾çµç®¡ç†ç³»ç»Ÿ =====

/// å®å¯æ¢¦ç²¾çµé…ç½®
struct PokemonSpriteConfig {
  front_sprite: String
  back_sprite: String
  size: @math.Vec2D
}

/// å®å¯æ¢¦ç²¾çµç¼“å­˜
let pokemon_sprite_cache: Map[Int, PokemonSpriteConfig] = Map::new()

/// é¢„åŠ è½½çš„å›¾ç‰‡å…ƒç´ ç¼“å­˜
let pokemon_image_cache: Map[String, String] = Map::new()

///|
// åˆå§‹åŒ–å®å¯æ¢¦ç²¾çµé…ç½®
fn init_pokemon_sprite_configs() -> Unit {
  println("ğŸ–¼ï¸ åˆå§‹åŒ–å®å¯æ¢¦ç²¾çµé…ç½®...")
  
  // ä½¿ç”¨ç°æœ‰çš„å›¾ç‰‡
  let default_front = "pic/mega_moonbit_front.png"
  let default_back = "pic/mega_moonbit_back.png"
  let moonrabbit_back = "pic/mega_moonbit_back.png"
  
  // PythonèŸ’è›‡ - è‰+é¾™ç³»
  pokemon_sprite_cache.set(1, PokemonSpriteConfig::{
    front_sprite: "pic/python_front.png",
    back_sprite: default_back, 
    size: @math.Vec2D(128.0, 128.0)
  })
  
  // Javaå’–å•¡æ¯ - ç«+é’¢ç³»
  pokemon_sprite_cache.set(2, PokemonSpriteConfig::{
    front_sprite: "pic/java_front.png",
    back_sprite: default_back,
    size: @math.Vec2D(128.0, 128.0)
  })
  
  // C++é½¿è½®å…½ - é’¢+æ¶ç³»
  pokemon_sprite_cache.set(3, PokemonSpriteConfig::{
    front_sprite: "pic/cpp_front.png",
    back_sprite: default_back,
    size: @math.Vec2D(128.0, 128.0)
  })
  
  // JavaScriptç”µç²¾çµ - ç”µ+å¦–ç²¾ç³»
  pokemon_sprite_cache.set(4, PokemonSpriteConfig::{
    front_sprite: "pic/javascript_front.png",
    back_sprite: default_back,
    size: @math.Vec2D(128.0, 128.0)
  })
  
  // C#éŸ³ç¬¦éª‘å£« - é’¢+ç”µç³»
  pokemon_sprite_cache.set(5, PokemonSpriteConfig::{
    front_sprite: "pic/csharp_front.png",
    back_sprite: default_back,
    size: @math.Vec2D(128.0, 128.0)
  })
  
  // Goåœ°é¼  - æ™®é€š+åœ°é¢ç³»
  pokemon_sprite_cache.set(6, PokemonSpriteConfig::{
    front_sprite: "pic/go_front.png",
    back_sprite: default_back,
    size: @math.Vec2D(128.0, 128.0)
  })
  
  // RustèƒèŸ¹ - æ°´+é’¢ç³»
  pokemon_sprite_cache.set(7, PokemonSpriteConfig::{
    front_sprite: "pic/rust_front.png",
    back_sprite: default_back,
    size: @math.Vec2D(128.0, 128.0)
  })
  
  // Rubyçº¢å®çŸ³é¾™ - ç«+å¦–ç²¾ç³»
  pokemon_sprite_cache.set(8, PokemonSpriteConfig::{
    front_sprite: "pic/ruby_front.png",
    back_sprite: default_back,
    size: @math.Vec2D(128.0, 128.0)
  })
  
  // PHPå¤§è±¡ - æ°´+å†°ç³»
  pokemon_sprite_cache.set(9, PokemonSpriteConfig::{
    front_sprite: "pic/php_front.png",
    back_sprite: default_back,
    size: @math.Vec2D(128.0, 128.0)
  })
  
  // æœˆå…” - è¶…èƒ½+å¦–ç²¾ç³»
  pokemon_sprite_cache.set(10, PokemonSpriteConfig::{
    front_sprite: "pic/moonbit_front.png",
    back_sprite: "pic/moonbit_back.png",
    size: @math.Vec2D(128.0, 128.0)
  })
  
  println("âœ… å®å¯æ¢¦ç²¾çµé…ç½®åˆå§‹åŒ–å®Œæˆ")
}

///|
// é¢„åŠ è½½æ‰€æœ‰å®å¯æ¢¦å›¾ç‰‡
pub fn preload_all_pokemon_sprites(backend: &@system.Backend) -> Unit {
  println(" å¼€å§‹é¢„åŠ è½½æ‰€æœ‰å®å¯æ¢¦å›¾ç‰‡...")
  
  // åˆå§‹åŒ–ç²¾çµé…ç½®
  init_pokemon_sprite_configs()
  
  // é¢„åŠ è½½æ‰€æœ‰å®å¯æ¢¦å›¾ç‰‡
  let mut pokemon_id = 1
  while pokemon_id <= 10 {
    match pokemon_sprite_cache.get(pokemon_id) {
      Some(config) => {
        // é¢„åŠ è½½æ­£é¢å›¾ç‰‡
        backend.preload_img(config.front_sprite)
        pokemon_image_cache.set(config.front_sprite, config.front_sprite)
        
        // é¢„åŠ è½½èƒŒé¢å›¾ç‰‡
        backend.preload_img(config.back_sprite)
        pokemon_image_cache.set(config.back_sprite, config.back_sprite)
        
        println(" é¢„åŠ è½½å®å¯æ¢¦ " + pokemon_id.to_string() + " å›¾ç‰‡å®Œæˆ")
      }
      None => {
        println("âš ï¸ æœªæ‰¾åˆ°å®å¯æ¢¦ " + pokemon_id.to_string() + " çš„é…ç½®")
      }
    }
    pokemon_id = pokemon_id + 1
  }
  
  println("âœ… æ‰€æœ‰å®å¯æ¢¦å›¾ç‰‡é¢„åŠ è½½å®Œæˆ")
}

///|
// è·å–å®å¯æ¢¦ç²¾çµé…ç½®
fn get_pokemon_sprite_config(pokemon_id: Int) -> Option[PokemonSpriteConfig] {
  pokemon_sprite_cache.get(pokemon_id)
}

///|
// åˆ›å»ºå®å¯æ¢¦ç²¾çµï¼ˆä½¿ç”¨é¢„åŠ è½½çš„å›¾ç‰‡ï¼‰
fn create_pokemon_sprite(pokemon: Pokemon, is_front: Bool) -> @sprite.Sprite {
  match get_pokemon_sprite_config(pokemon.id) {
    Some(config) => {
      let sprite_path = if is_front { config.front_sprite } else { config.back_sprite }
      
      @sprite.Sprite::from_picture(
        @sprite.Picture::new(
          config.size,
          sprite_path,
          transform=@math.Transform::new(),
          repeat=@system.RepeatMode::NoRepeat
        ),
        15
      )
    }
    None => {
      // å¦‚æœæ‰¾ä¸åˆ°é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡
      println("âš ï¸ æœªæ‰¾åˆ°å®å¯æ¢¦ " + pokemon.id.to_string() + " çš„ç²¾çµé…ç½®ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡")
      @sprite.Sprite::from_picture(
        @sprite.Picture::new(
          @math.Vec2D(64.0, 64.0),
          "pic/moonbit_back.png", // é»˜è®¤å›¾ç‰‡
          transform=@math.Transform::new(),
          repeat=@system.RepeatMode::NoRepeat
        ),
        15
      )
    }
  }
}

///|
// ===== ç¼“å­˜ç®¡ç†å‡½æ•° =====

/// æ¸…ç†å®å¯æ¢¦å›¾ç‰‡ç¼“å­˜
pub fn clear_pokemon_image_cache() -> Unit {
  pokemon_image_cache.clear()
  println("ğŸ§¹ å®å¯æ¢¦å›¾ç‰‡ç¼“å­˜å·²æ¸…ç†")
}

/// è·å–ç¼“å­˜çŠ¶æ€
pub fn get_pokemon_cache_status() -> String {
  "å®å¯æ¢¦ç²¾çµé…ç½®: " + pokemon_sprite_cache.size().to_string() + " ä¸ª, " +
  "å›¾ç‰‡ç¼“å­˜: " + pokemon_image_cache.size().to_string() + " ä¸ª"
}

/// æµ‹è¯•å®å¯æ¢¦ç²¾çµç³»ç»Ÿ
pub fn test_pokemon_sprite_system() -> Unit {
  println(" æµ‹è¯•å®å¯æ¢¦ç²¾çµç³»ç»Ÿ...")
  
  // åˆå§‹åŒ–é…ç½®
  init_pokemon_sprite_configs()
  
  // æµ‹è¯•è·å–é…ç½®
  match get_pokemon_sprite_config(1) {
    Some(config) => {
      println("âœ… PythonèŸ’è›‡é…ç½®: " + config.front_sprite + " / " + config.back_sprite)
    }
    None => println("âŒ æœªæ‰¾åˆ°PythonèŸ’è›‡é…ç½®")
  }
  
  println("ğŸ‰ å®å¯æ¢¦ç²¾çµç³»ç»Ÿæµ‹è¯•å®Œæˆ")
}

// æˆ˜æ–—ç³»ç»Ÿ
fn battle_system_fn(_backend : &@system.Backend) -> Unit {
  // æ›´æ–°å¸§è®¡æ•°å™¨
  update_frame_counter()
  
  // å¤„ç†æˆ˜æ–—é€»è¾‘ - æ·»åŠ æ•ŒäººAIå’Œå›åˆç®¡ç†
  if is_enemy_turn() {
    execute_enemy_turn()
  }
}
