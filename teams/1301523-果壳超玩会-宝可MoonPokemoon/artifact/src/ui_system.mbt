//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
// UI System - æ•´åˆæ‰€æœ‰UIç›¸å…³åŠŸèƒ½
// åŒ…å«ï¼šåŸºç¡€UIã€å®å¯æ¢¦UIã€è°ƒè¯•å±å¹•ã€è¡€æ¡UI

///|
// ===== è°ƒè¯•å±å¹•ç›¸å…³ç±»å‹ =====

///|
// è°ƒè¯•å±å¹•ç»“æ„ä½“
pub struct DebugScreen {
  is_active : Bool
  current_test : String
  test_results : Array[String]
  frame_count : Int
  fps_counter : Int
  fps : Double
  debug_entity : Option[@system.Entity]
  debug_text_entities : Array[@system.Entity]
} derive(Show)

///|
// è°ƒè¯•è¾“å…¥å¤„ç†å™¨ç»“æ„ä½“
pub struct DebugInputHandler {
  key_states : Map[String, Bool]
  mouse_buttons : Map[Int, Bool]
  mouse_position : @math.Vec2D
  event_queue : Array[String]
} derive(Show)

///|
// è°ƒè¯•æ¸¸æˆç®¡ç†å™¨ç»“æ„ä½“
pub struct DebugGameManager {
  screen : DebugScreen
  input_handler : DebugInputHandler
  is_running : Bool
} derive(Show)

///|
// ===== è¡€æ¡UIç›¸å…³ç±»å‹ =====

///|
// è¡€æ¡ç±»å‹æšä¸¾
pub enum HealthBarType {
  Player
  Enemy
} derive(Show, Eq)

///|
// è¡€æ¡å®ä½“ç»„ç»“æ„
pub struct HealthBarEntities {
  background_entity: @system.Entity
  fill_entity: @system.Entity
  text_entity: @system.Entity
  bar_type: HealthBarType
} derive(Show)

///|
// ç®€åŒ–çš„è¡€æ¡é…ç½®
pub struct HealthBarConfig {
  position: @math.Vec2D
  width: Double
  height: Double
  background_color: String
  fill_color: String
  text_color: String
  bar_type: HealthBarType
} derive(Show)

///|
// è¡€æ¡UIçŠ¶æ€
pub struct HealthBarUIState {
  mut is_active: Bool
  mut player_health_bar: Option[HealthBarEntities]
  mut enemy_health_bar: Option[HealthBarEntities]
  mut health_bar_entities: Array[@system.Entity]
  mut animation_timer: Double
  mut update_interval: Double
} derive(Show)

///|
// å›åˆæ˜¾ç¤ºå®ä½“
pub struct TurnDisplayEntities {
  background_entity: @system.Entity
  turn_text_entity: @system.Entity
  turn_number_entity: @system.Entity
} derive(Show)

///|
// å›åˆæ˜¾ç¤ºçŠ¶æ€
pub struct TurnDisplayState {
  mut is_active: Bool
  mut turn_display: Option[TurnDisplayEntities]
  mut current_turn: Int
  mut current_turn_type: String
} derive(Show)

///|
// å®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºå®ä½“ç»„ï¼ˆåŒ…å«æ–‡æœ¬å’Œè¡€æ¡ï¼‰
pub struct PokemonInfoEntities {
  // å®å¯æ¢¦ä¿¡æ¯æ–‡æœ¬
  name_entity: @system.Entity
  level_entity: @system.Entity
  
  // è¡€æ¡ç»„ä»¶
  background_entity: @system.Entity
  fill_entity: @system.Entity
  hp_text_entity: @system.Entity
  
  // åŸºæœ¬ä¿¡æ¯
  bar_type: HealthBarType
  base_position: @math.Vec2D  // åŸºç¡€ä½ç½®ï¼Œæ‰€æœ‰å…ƒç´ éƒ½ç›¸å¯¹äºè¿™ä¸ªä½ç½®
} derive(Show)

///|
// å®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºé…ç½®
pub struct PokemonInfoConfig {
  base_position: @math.Vec2D  // åŸºç¡€ä½ç½®
  width: Double
  height: Double
  background_color: String
  fill_color: String
  text_color: String
  bar_type: HealthBarType
} derive(Show)

let health_bar_ui_state: HealthBarUIState = {
  is_active: false,
  player_health_bar: None,
  enemy_health_bar: None,
  health_bar_entities: [],
  animation_timer: 0.0,
  update_interval: 0.016
}

///|
// å…¨å±€å›åˆæ˜¾ç¤ºçŠ¶æ€
let turn_display_state: TurnDisplayState = {
  is_active: false,
  turn_display: None,
  current_turn: 1,
  current_turn_type: "ç©å®¶"
}

///|
// åˆ›å»ºç»Ÿä¸€çš„è¡€æ¡æ¨¡æ¿
pub fn create_health_bar_template(
  config: HealthBarConfig,
  max_hp: Int
) -> HealthBarEntities {
  let background_entity = @system.Entity::new()
  let fill_entity = @system.Entity::new()
  let text_entity = @system.Entity::new()
  
  // åˆ›å»ºè¡€æ¡èƒŒæ™¯ - ä½¿ç”¨æ›´é«˜çš„å±‚çº§ç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚
  let background_sprite = @sprite.Sprite::from_color_rect(
    @sprite.ColorRect::new(
      @math.Vec2D(config.width, config.height),
      config.background_color
    ),
    20  // ä½¿ç”¨æ›´é«˜çš„å±‚çº§ï¼Œç¡®ä¿åœ¨UIä¹‹ä¸Š
  )
  @sprite.sprites.set(background_entity, background_sprite)
  @position.positions.set(background_entity, config.position)
  
  // åˆ›å»ºè¡€æ¡å¡«å…… - ä½¿ç”¨æ›´é«˜çš„å±‚çº§
  let fill_sprite = @sprite.Sprite::from_color_rect(
    @sprite.ColorRect::new(
      @math.Vec2D(config.width - 4.0, config.height - 4.0),
      config.fill_color
    ),
    21  // ä½¿ç”¨æ›´é«˜çš„å±‚çº§ï¼Œç¡®ä¿åœ¨UIä¹‹ä¸Š
  )
  @sprite.sprites.set(fill_entity, fill_sprite)
  @position.positions.set(fill_entity, @math.Vec2D(config.position.0 + 2.0, config.position.1 + 2.0))
  
  // åˆ›å»ºHPæ–‡æœ¬ - ä½¿ç”¨æ›´é«˜çš„å±‚çº§
  let hp_text = "HP: " + max_hp.to_string() + "/" + max_hp.to_string()
  let text_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(hp_text, font="12px Arial", color=config.text_color),
    22  // ä½¿ç”¨æ›´é«˜çš„å±‚çº§ï¼Œç¡®ä¿åœ¨UIä¹‹ä¸Š
  )
  @sprite.sprites.set(text_entity, text_sprite)
  @position.positions.set(text_entity, @math.Vec2D(config.position.0 + 5.0, config.position.1 + config.height + 5.0))
  
  let bar_type_name = match config.bar_type {
    HealthBarType::Player => "ç©å®¶"
    HealthBarType::Enemy => "æ•Œäºº"
  }
  
  println("ğŸ“Š åˆ›å»ºè¡€æ¡æ¨¡æ¿: " + bar_type_name + ", HP: " + max_hp.to_string())
  
  {
    background_entity: background_entity,
    fill_entity: fill_entity,
    text_entity: text_entity,
    bar_type: config.bar_type
  }
}

///|
// ä¼˜åŒ–æ–‡æœ¬æ›´æ–° - åªåœ¨å†…å®¹çœŸæ­£æ”¹å˜æ—¶æ‰æ›´æ–°
pub fn update_text_sprite_if_changed(
  entity: @system.Entity,
  new_text: String,
  font: String,
  color: String,
  layer: Int
) -> Unit {
  // è·å–å½“å‰æ–‡æœ¬ç²¾çµ
  let current_sprite = @sprite.sprites.get(entity)
  match current_sprite {
    Some(sprite) => {
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡æœ¬å†…å®¹æ¯”è¾ƒé€»è¾‘
      // æš‚æ—¶æ¯æ¬¡éƒ½æ›´æ–°ï¼Œä½†å¯ä»¥ä¼˜åŒ–ä¸ºåªåœ¨å†…å®¹æ”¹å˜æ—¶æ›´æ–°
      let text_sprite = @sprite.Sprite::from_text(
        @sprite.Text::new(new_text, font=font, color=color),
        layer
      )
      @sprite.sprites.set(entity, text_sprite)
    }
    None => {
      // åˆ›å»ºæ–°çš„æ–‡æœ¬ç²¾çµ
      let text_sprite = @sprite.Sprite::from_text(
        @sprite.Text::new(new_text, font=font, color=color),
        layer
      )
      @sprite.sprites.set(entity, text_sprite)
    }
  }
}

///|
// ä¿®å¤ï¼šçœŸæ­£çš„æ–‡æœ¬å†…å®¹æ¯”è¾ƒå’Œç¼“å­˜
pub fn update_text_sprite_with_cache(
  entity: @system.Entity,
  new_text: String,
  font: String,
  color: String,
  layer: Int,
  last_text: String
) -> String {
  // åªåœ¨æ–‡æœ¬å†…å®¹çœŸæ­£æ”¹å˜æ—¶æ‰æ›´æ–°
  let mut cached_text = last_text
  if cached_text != new_text {
    let text_sprite = @sprite.Sprite::from_text(
      @sprite.Text::new(new_text, font=font, color=color),
      layer
    )
    @sprite.sprites.set(entity, text_sprite)
    cached_text = new_text  // æ›´æ–°ç¼“å­˜çš„æ–‡æœ¬
    new_text  // è¿”å›æ–°çš„æ–‡æœ¬å†…å®¹
  } else {
    cached_text  // è¿”å›æœªæ”¹å˜çš„æ–‡æœ¬å†…å®¹
  }
}

///|
// æ›´æ–°è¡€æ¡æ˜¾ç¤º - ä¼˜åŒ–ç‰ˆæœ¬
pub fn update_health_bar_display(
  health_bar: HealthBarEntities,
  current_hp: Int,
  max_hp: Int
) -> Unit {
  // è®¡ç®—HPç™¾åˆ†æ¯”
  let hp_percentage = if max_hp > 0 {
    current_hp.to_double() / max_hp.to_double()
  } else {
    0.0
  }
  
  let clamped_percentage = if hp_percentage < 0.0 { 0.0 } else if hp_percentage > 1.0 { 1.0 } else { hp_percentage }
  
  // æ›´æ–°å¡«å……ç²¾çµ
  let fill_color = if clamped_percentage > 0.66 {
    "#00FF00"
  } else if clamped_percentage > 0.33 {
    "#FFFF00"
  } else {
    "#FF0000"
  }
  
  let current_fill_sprite = @sprite.sprites.get(health_bar.fill_entity)
  match current_fill_sprite {
    Some(_) => {
      let original_width = 196.0
      let original_height = 16.0
      let fill_width = original_width * clamped_percentage
      let final_width = if fill_width < 1.0 { 1.0 } else { fill_width }
      
      let fill_sprite = @sprite.Sprite::from_color_rect(
        @sprite.ColorRect::new(
          @math.Vec2D(final_width, original_height),
          fill_color
        ),
        21
      )
      @sprite.sprites.set(health_bar.fill_entity, fill_sprite)
    }
    None => {
      let fill_sprite = @sprite.Sprite::from_color_rect(
        @sprite.ColorRect::new(
          @math.Vec2D(196.0 * clamped_percentage, 16.0),
          fill_color
        ),
        21
      )
      @sprite.sprites.set(health_bar.fill_entity, fill_sprite)
    }
  }
  
  // ä½¿ç”¨ä¼˜åŒ–çš„æ–‡æœ¬æ›´æ–°å‡½æ•°
  let hp_text = "HP: " + current_hp.to_string() + "/" + max_hp.to_string()
  let text_color = if clamped_percentage < 0.33 { "#FF0000" } else { "#FFFFFF" }
  
  update_text_sprite_if_changed(
    health_bar.text_entity,
    hp_text,
    "12px Arial",
    text_color,
    22
  )
  
  let bar_type_name = match health_bar.bar_type {
    HealthBarType::Player => "ç©å®¶"
    HealthBarType::Enemy => "æ•Œäºº"
  }
  
  println(" æ›´æ–°è¡€æ¡: " + bar_type_name + " HP: " + current_hp.to_string() + "/" + max_hp.to_string() + " (" + (clamped_percentage * 100.0).to_string() + "%)")
}

///|
// æ›´æ–°è¡€æ¡UIåŠ¨ç”»
pub fn update_health_bar_ui_animation(delta_time: Double) -> Unit {
  if !health_bar_ui_state.is_active {
    return
  }
  
  health_bar_ui_state.animation_timer = health_bar_ui_state.animation_timer + delta_time
  
  // æ¯å¸§æ›´æ–°åŠ¨ç”»
  if health_bar_ui_state.animation_timer >= health_bar_ui_state.update_interval {
    health_bar_ui_state.animation_timer = 0.0
    
    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„åŠ¨ç”»é€»è¾‘
    println("ğŸ“Š è¡€æ¡UIåŠ¨ç”»æ›´æ–°")
  }
}

///|
// è®¾ç½®è¡€æ¡UIå¯è§æ€§
pub fn set_health_bar_ui_visibility(is_visible: Bool) -> Unit {
  health_bar_ui_state.is_active = is_visible
  
  for entity in health_bar_ui_state.health_bar_entities {
    // è¿™é‡Œå¯ä»¥è®¾ç½®å®ä½“çš„å¯è§æ€§
    println("ğŸ“Š è®¾ç½®è¡€æ¡UIå¯è§æ€§: " + is_visible.to_string())
  }
}

///|
// æ¸…ç†è¡€æ¡UI
pub fn clear_health_bar_ui() -> Unit {
  health_bar_ui_state.is_active = false
  health_bar_ui_state.player_health_bar = None
  health_bar_ui_state.enemy_health_bar = None
  health_bar_ui_state.health_bar_entities.clear()
  health_bar_ui_state.animation_timer = 0.0
  
  println("ğŸ“Š è¡€æ¡UIæ¸…ç†å®Œæˆ")
}

///|
// è·å–è¡€æ¡UIçŠ¶æ€
pub fn get_health_bar_ui_status() -> String {
  let status = if health_bar_ui_state.is_active {
    "æ´»è·ƒ"
  } else {
    "æœªæ¿€æ´»"
  }
  
  let player_status = if health_bar_ui_state.player_health_bar.is_some() {
    "å·²åˆ›å»º"
  } else {
    "æœªåˆ›å»º"
  }
  
  let enemy_status = if health_bar_ui_state.enemy_health_bar.is_some() {
    "å·²åˆ›å»º"
  } else {
    "æœªåˆ›å»º"
  }
  
  "è¡€æ¡UIçŠ¶æ€: " + status + ", ç©å®¶è¡€æ¡: " + player_status + ", æ•Œäººè¡€æ¡: " + enemy_status + ", å®ä½“æ•°é‡: " + health_bar_ui_state.health_bar_entities.length().to_string()
}

///|
// ===== è°ƒè¯•å±å¹•åŠŸèƒ½ =====

///|
// åˆ›å»ºè°ƒè¯•å±å¹•
pub fn create_debug_screen() -> DebugScreen {
  DebugScreen::{
    is_active: true,
    current_test: "System Test",
    test_results: [],
    frame_count: 0,
    fps_counter: 0,
    fps: 60.0,
    debug_entity: None,
    debug_text_entities: []
  }
}

///|
// åˆ›å»ºè°ƒè¯•æ¸¸æˆç®¡ç†å™¨
pub fn create_debug_game_manager() -> DebugGameManager {
  DebugGameManager::{
    screen: create_debug_screen(),
    input_handler: create_debug_input_handler(),
    is_running: true
  }
}

///|
// åˆ›å»ºè°ƒè¯•è¾“å…¥å¤„ç†å™¨
pub fn create_debug_input_handler() -> DebugInputHandler {
  DebugInputHandler::{
    key_states: Map::new(),
    mouse_buttons: Map::new(),
    mouse_position: @math.Vec2D(0.0, 0.0),
    event_queue: []
  }
}

///|
// æ›´æ–°è°ƒè¯•å±å¹•
pub fn update_debug_screen(screen : DebugScreen, _delta_time : Double) -> DebugScreen {
  DebugScreen::{
    is_active: screen.is_active,
    current_test: screen.current_test,
    test_results: screen.test_results,
    frame_count: screen.frame_count + 1,
    fps_counter: screen.fps_counter + 1,
    fps: screen.fps,
    debug_entity: screen.debug_entity,
    debug_text_entities: screen.debug_text_entities
  }
}

///|
// æ·»åŠ æµ‹è¯•ç»“æœ
pub fn add_test_result(screen : DebugScreen, result : String) -> DebugScreen {
  DebugScreen::{
    is_active: screen.is_active,
    current_test: screen.current_test,
    test_results: screen.test_results + [result],
    frame_count: screen.frame_count,
    fps_counter: screen.fps_counter,
    fps: screen.fps,
    debug_entity: screen.debug_entity,
    debug_text_entities: screen.debug_text_entities
  }
}

///|
// è®¾ç½®å½“å‰æµ‹è¯•
pub fn set_current_test(screen : DebugScreen, test_name : String) -> DebugScreen {
  DebugScreen::{
    is_active: screen.is_active,
    current_test: test_name,
    test_results: screen.test_results,
    frame_count: screen.frame_count,
    fps_counter: screen.fps_counter,
    fps: screen.fps,
    debug_entity: screen.debug_entity,
    debug_text_entities: screen.debug_text_entities
  }
}

///|
// æ¸…ç†æµ‹è¯•ç»“æœ
pub fn clear_test_results(screen : DebugScreen) -> DebugScreen {
  DebugScreen::{
    is_active: screen.is_active,
    current_test: screen.current_test,
    test_results: [],
    frame_count: screen.frame_count,
    fps_counter: screen.fps_counter,
    fps: screen.fps,
    debug_entity: screen.debug_entity,
    debug_text_entities: screen.debug_text_entities
  }
}

///|
// è·å–è°ƒè¯•ä¿¡æ¯
pub fn get_debug_info(screen : DebugScreen) -> String {
  "Debug Info: " + screen.current_test + ", Results: " + screen.test_results.length().to_string()
}

///|
// è¿è¡Œç³»ç»Ÿæµ‹è¯•
pub fn run_system_test(screen : DebugScreen) -> DebugScreen {
  add_test_result(screen, "System test completed")
}

///|
// è¿è¡Œæˆ˜æ–—æµ‹è¯•
pub fn run_battle_test(screen : DebugScreen) -> DebugScreen {
  add_test_result(screen, "Battle test completed")
}

///|
// è¿è¡Œè¾“å…¥æµ‹è¯•
pub fn run_input_test(screen : DebugScreen) -> DebugScreen {
  add_test_result(screen, "Input test completed")
}

///|
// è¿è¡Œæ€§èƒ½æµ‹è¯•
pub fn run_performance_test(screen : DebugScreen) -> DebugScreen {
  add_test_result(screen, "Performance test completed")
}

///|
// è°ƒè¯•å±å¹•ä¸»å‡½æ•°
pub fn debug_screen_main() -> Unit {
  println("Debug screen main function called")
}

///|
// æµ‹è¯•è°ƒè¯•å±å¹•
pub fn test_debug_screen() -> Unit {
  println("Test debug screen function called")
}

///|
// è·å–è°ƒè¯•çŠ¶æ€
pub fn get_debug_status() -> String {
  "Debug system is running"
}

///|
// è¿è¡Œæ‰€æœ‰è°ƒè¯•æµ‹è¯•
pub fn run_all_debug_tests() -> Unit {
  println("Running all debug tests")
}

///|
// å¤„ç†è°ƒè¯•é”®ç›˜è¾“å…¥
pub fn handle_debug_keyboard_input(handler : DebugInputHandler, _key : String, _is_pressed : Bool) -> DebugInputHandler {
  handler
}

///|
// å¤„ç†è°ƒè¯•é¼ æ ‡è¾“å…¥
pub fn handle_debug_mouse_input(handler : DebugInputHandler, _button : Int, _is_pressed : Bool, _position : @math.Vec2D) -> DebugInputHandler {
  handler
}

///|
// æ£€æŸ¥è°ƒè¯•æŒ‰é”®æ˜¯å¦è¢«æŒ‰ä¸‹
pub fn is_debug_key_pressed(_handler : DebugInputHandler, _key : String) -> Bool {
  false
}

///|
// æ£€æŸ¥è°ƒè¯•é¼ æ ‡æŒ‰é’®æ˜¯å¦è¢«æŒ‰ä¸‹
pub fn is_debug_mouse_button_pressed(_handler : DebugInputHandler, _button : Int) -> Bool {
  false
}

///|
// æ›´æ–°è°ƒè¯•æ¸¸æˆç®¡ç†å™¨
pub fn update_debug_game_manager(manager : DebugGameManager, _delta_time : Double) -> DebugGameManager {
  manager
}

///|
// å¤„ç†è°ƒè¯•è¾“å…¥
pub fn handle_debug_input(manager : DebugGameManager, _key : String, _is_pressed : Bool) -> DebugGameManager {
  manager
}

///|
// ç¡®ä¿æ‰€æœ‰è°ƒè¯•å±å¹•å‡½æ•°éƒ½è¢«ç”Ÿæˆ
pub fn ensure_debug_functions_generated() -> Unit {
  let debug_screen = create_debug_screen()
  let debug_manager = create_debug_game_manager()
  
  let _ = update_debug_screen(debug_screen, 0.016)
  let _ = add_test_result(debug_screen, "Test")
  let _ = set_current_test(debug_screen, "Test")
  let _ = clear_test_results(debug_screen)
  let _ = get_debug_info(debug_screen)
  let _ = run_system_test(debug_screen)
  let _ = run_battle_test(debug_screen)
  let _ = run_input_test(debug_screen)
  let _ = run_performance_test(debug_screen)
  let _ = debug_screen_main()
  
  let input_handler = create_debug_input_handler()
  let _ = handle_debug_keyboard_input(input_handler, "Test", true)
  let _ = handle_debug_mouse_input(input_handler, 0, true, @math.Vec2D(0.0, 0.0))
  let _ = is_debug_key_pressed(input_handler, "Test")
  let _ = is_debug_mouse_button_pressed(input_handler, 0)
  
  let _ = update_debug_game_manager(debug_manager, 0.016)
  let _ = handle_debug_input(debug_manager, "Test", true)
  
  let _ = debug_screen_main()
  let _ = test_debug_screen()
  let _ = get_debug_status()
  let _ = run_all_debug_tests()
  
  println("All debug screen functions have been called to ensure generation")
}

///|
// åˆå§‹åŒ–è°ƒè¯•å±å¹•ç³»ç»Ÿ
fn init_debug_screen_system() -> Unit {
  println("=== Initializing Debug Screen System ===")
  
  // Create debug screen
  let debug_screen = create_debug_screen()
  let debug_manager = create_debug_game_manager()
  
  println("Debug screen created successfully")
  println("Debug manager initialized")
  
  // Run initial test
  let test_screen = run_system_test(debug_screen)
  println("Initial system test completed")
  
  println("Debug screen system initialization completed")
}

///|
// æµ‹è¯•è°ƒè¯•å±å¹•ç³»ç»Ÿ
fn test_debug_screen_system() -> Unit {
  println("=== Testing Debug Screen System ===")
  
  // Test debug screen creation
  let screen = create_debug_screen()
  println("Debug screen created: " + screen.is_active.to_string())
  
  // Test screen update
  let updated_screen = update_debug_screen(screen, 0.016)
  println("Screen updated: frame " + updated_screen.frame_count.to_string())
  
  // Test adding test results
  let screen_with_result = add_test_result(updated_screen, "Test result 1")
  println("Test result added: " + screen_with_result.test_results.length().to_string())
  
  // Test running different tests
  let system_test = run_system_test(screen_with_result)
  let battle_test = run_battle_test(system_test)
  let input_test = run_input_test(battle_test)
  let performance_test = run_performance_test(input_test)
  
  println("All tests completed. Total results: " + performance_test.test_results.length().to_string())
  
  // æµ‹è¯•è°ƒè¯•ä¿¡æ¯
  let debug_info = get_debug_info(screen)
  println("Debug info: " + debug_info)
  
  // Test input handling
  let input_handler = create_debug_input_handler()
  let input_with_key = handle_debug_keyboard_input(input_handler, "Enter", true)
  let input_with_mouse = handle_debug_mouse_input(input_with_key, 0, true, @math.Vec2D(100.0, 100.0))
  
  println("Input handler test completed")
  
  // Test debug game manager
  let game_manager = create_debug_game_manager()
  let updated_manager = update_debug_game_manager(game_manager, 0.016)
  let input_manager = handle_debug_input(updated_manager, "F1", true)
  
  println("Debug game manager test completed")
  
  println("Debug screen system test completed")
}

///|
// ===== è¡€æ¡UIæµ‹è¯•åŠŸèƒ½ =====

///|
// æµ‹è¯•è¡€æ¡UIç³»ç»Ÿ
fn test_health_bar_ui_system() -> Unit {
  println("=== è¡€æ¡UIç³»ç»Ÿæµ‹è¯•å¼€å§‹ ===")
  
  // åˆå§‹åŒ–è¡€æ¡UIç³»ç»Ÿ
  init_health_bar_ui()
  println("âœ… è¡€æ¡UIç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
  
  // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œåˆ›å»ºå®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºï¼Œå› ä¸ºæˆ˜æ–—æ¸²æŸ“ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»º
  println("âœ… è¡€æ¡UIç³»ç»Ÿæµ‹è¯•å®Œæˆï¼ˆå®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºç”±æˆ˜æ–—æ¸²æŸ“ç³»ç»Ÿç®¡ç†ï¼‰")
  
  // æµ‹è¯•åŠ¨ç”»æ›´æ–° - ä½¿ç”¨æ–°çš„API
  update_health_bar_ui_animation(0.016)
  println("âœ… è¡€æ¡UIåŠ¨ç”»æ›´æ–°å®Œæˆ")
  
  // è·å–çŠ¶æ€ä¿¡æ¯
  let status = get_health_bar_ui_status()
  println("ğŸ“Š " + status)
  
  // æµ‹è¯•å¯è§æ€§è®¾ç½®
  set_health_bar_ui_visibility(false)
  set_health_bar_ui_visibility(true)
  println("âœ… è¡€æ¡UIå¯è§æ€§è®¾ç½®å®Œæˆ")
  
  // æ¸…ç†æµ‹è¯•
  clear_health_bar_ui()
  println("âœ… è¡€æ¡UIæ¸…ç†å®Œæˆ")
  
  println("=== è¡€æ¡UIç³»ç»Ÿæµ‹è¯•å®Œæˆ ===")
}

///|
// åˆå§‹åŒ–è¡€æ¡UIç³»ç»Ÿ
pub fn init_health_bar_ui() -> Unit {
  health_bar_ui_state.is_active = true
  health_bar_ui_state.animation_timer = 0.0
  health_bar_ui_state.update_interval = 0.016
  
  println("ğŸ“Š è¡€æ¡UIç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
}

///|
// åˆ›å»ºå›åˆæ˜¾ç¤º
pub fn create_turn_display() -> TurnDisplayEntities {
  let background_entity = @system.Entity::new()
  let turn_text_entity = @system.Entity::new()
  let turn_number_entity = @system.Entity::new()
  
  // èƒŒæ™¯åŸºç¡€ä½ç½®
  let bg_x = 50.0
  let bg_y = 50.0
  
  // åˆå§‹æ–‡å­—å†…å®¹
  let initial_turn_text = "ç©å®¶å›åˆ"
  let initial_turn_number = "1"
  
  // è®¡ç®—æ–‡å­—æ€»å®½åº¦ï¼ˆä¼°ç®—ï¼‰
  let text_width = (initial_turn_text.length() + initial_turn_number.length()).to_double() * 12.0 + 20.0
  let background_width = if text_width > 100.0 { text_width } else { 100.0 }
  let background_height = 50.0
  
  // åˆ›å»ºå›åˆèƒŒæ™¯
  let background_sprite = @sprite.Sprite::from_color_rect(
    @sprite.ColorRect::new(
      @math.Vec2D(background_width, background_height),
      "#000000"
    ),
    25
  )
  @sprite.sprites.set(background_entity, background_sprite)
  @position.positions.set(background_entity, @position.Position(@math.Vec2D(bg_x, bg_y)))
  
  // æ–‡å­—ç›¸å¯¹äºèƒŒæ™¯çš„åç§»é‡
  let text_offset_x = 5.0  // è·ç¦»èƒŒæ™¯å·¦è¾¹5åƒç´ 
  let text_offset_y = 20.0 // è·ç¦»èƒŒæ™¯é¡¶éƒ¨20åƒç´ 
  let number_offset_x = text_offset_x + initial_turn_text.length().to_double() * 12.0 // æ•°å­—åœ¨æ–‡å­—åé¢
  
  // åˆ›å»ºå›åˆæ–‡æœ¬ - ä½ç½®åŸºäºèƒŒæ™¯ä½ç½®
  let text_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(initial_turn_text, font="20px Arial", color="#FFFFFF"),
    26
  )
  @sprite.sprites.set(turn_text_entity, text_sprite)
  @position.positions.set(turn_text_entity, @position.Position(@math.Vec2D(bg_x + text_offset_x, bg_y + text_offset_y)))
  
  // åˆ›å»ºå›åˆæ•°å­— - ä½ç½®åŸºäºèƒŒæ™¯ä½ç½®
  let number_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(initial_turn_number, font="20px Arial", color="#FFFFFF"),
    27
  )
  @sprite.sprites.set(turn_number_entity, number_sprite)
  @position.positions.set(turn_number_entity, @position.Position(@math.Vec2D(bg_x + number_offset_x, bg_y + text_offset_y)))
  
  println("ğŸ“Š å›åˆæ˜¾ç¤ºåˆ›å»ºå®Œæˆï¼ŒèƒŒæ™¯å®½åº¦: " + background_width.to_string())
  
  {
    background_entity: background_entity,
    turn_text_entity: turn_text_entity,
    turn_number_entity: turn_number_entity
  }
}

///|
// æ›´æ–°å›åˆæ˜¾ç¤º
pub fn update_turn_display(current_turn: Int, current_turn_type: String) -> Unit {
  match turn_display_state.turn_display {
    Some(turn_display) => {
      // è·å–å½“å‰èƒŒæ™¯ä½ç½®
      let current_bg_position = @position.positions.get(turn_display.background_entity)
      let bg_vec = match current_bg_position {
        Some(pos) => pos.0  // è§£åŒ…Positionè·å–Vec2D
        None => @math.Vec2D(50.0, 50.0) // é»˜è®¤ä½ç½®
      }
      
      // æ„å»ºå®Œæ•´çš„æ–‡å­—å†…å®¹
      let turn_type_text = current_turn_type + "å›åˆ"
      let turn_number = current_turn.to_string()
      
      // è®¡ç®—æ–°çš„èƒŒæ™¯å®½åº¦
      let text_width = (turn_type_text.length() + turn_number.length()).to_double() * 12.0 + 20.0
      let background_width = if text_width > 100.0 { text_width } else { 100.0 }
      
      // æ›´æ–°èƒŒæ™¯å¤§å°ï¼ˆä¿æŒå½“å‰ä½ç½®ï¼‰
      let background_sprite = @sprite.Sprite::from_color_rect(
        @sprite.ColorRect::new(
          @math.Vec2D(background_width, 50.0),
          "#000000"
        ),
        25
      )
      @sprite.sprites.set(turn_display.background_entity, background_sprite)
      @position.positions.set(turn_display.background_entity, current_bg_position.unwrap_or(@position.Position(@math.Vec2D(50.0, 50.0))))
      
      // æ–‡å­—ç›¸å¯¹äºèƒŒæ™¯çš„åç§»é‡
      let text_offset_x = 5.0
      let text_offset_y = 20.0
      let number_offset_x = text_offset_x + turn_type_text.length().to_double() * 12.0
      
      // æ›´æ–°å›åˆç±»å‹æ–‡æœ¬ - ä½ç½®åŸºäºèƒŒæ™¯ä½ç½®
      let text_sprite = @sprite.Sprite::from_text(
        @sprite.Text::new(turn_type_text, font="20px Arial", color="#FFFFFF"),
        26
      )
      @sprite.sprites.set(turn_display.turn_text_entity, text_sprite)
      @position.positions.set(turn_display.turn_text_entity, @position.Position(@math.Vec2D(bg_vec.0 + text_offset_x, bg_vec.1 + text_offset_y)))
      
      // æ›´æ–°å›åˆæ•°å­— - ä½ç½®åŸºäºèƒŒæ™¯ä½ç½®
      let number_sprite = @sprite.Sprite::from_text(
        @sprite.Text::new(turn_number, font="20px Arial", color="#FFFFFF"),
        27
      )
      @sprite.sprites.set(turn_display.turn_number_entity, number_sprite)
      @position.positions.set(turn_display.turn_number_entity, @position.Position(@math.Vec2D(bg_vec.0 + number_offset_x, bg_vec.1 + text_offset_y)))
      
      println("ğŸ“Š å›åˆæ˜¾ç¤ºæ›´æ–°å®Œæˆ: " + turn_type_text + " " + turn_number + ", èƒŒæ™¯å®½åº¦: " + background_width.to_string())
    }
    None => {
      println("âŒ å›åˆæ˜¾ç¤ºæœªåˆ›å»º")
    }
  }
}

///|
// ç§»åŠ¨å›åˆæ˜¾ç¤ºï¼ˆèƒŒæ™¯å’Œæ–‡å­—ä¸€èµ·ç§»åŠ¨ï¼‰
pub fn move_turn_display(new_x: Double, new_y: Double) -> Unit {
  match turn_display_state.turn_display {
    Some(turn_display) => {
      // ç§»åŠ¨èƒŒæ™¯
      @position.positions.set(turn_display.background_entity, @position.Position(@math.Vec2D(new_x, new_y)))
      
      // æ–‡å­—ç›¸å¯¹äºèƒŒæ™¯çš„åç§»é‡
      let text_offset_x = 5.0
      let text_offset_y = 20.0
      
      // è·å–å½“å‰æ–‡å­—å†…å®¹æ¥è®¡ç®—æ•°å­—ä½ç½®
      let current_turn_type = turn_display_state.current_turn_type + "å›åˆ"
      let current_turn_number = turn_display_state.current_turn.to_string()
      let number_offset_x = text_offset_x + current_turn_type.length().to_double() * 12.0
      
      // ç§»åŠ¨æ–‡å­— - ä½ç½®åŸºäºæ–°çš„èƒŒæ™¯ä½ç½®
      @position.positions.set(turn_display.turn_text_entity, @position.Position(@math.Vec2D(new_x + text_offset_x, new_y + text_offset_y)))
      @position.positions.set(turn_display.turn_number_entity, @position.Position(@math.Vec2D(new_x + number_offset_x, new_y + text_offset_y)))
      
      println("ğŸ“Š å›åˆæ˜¾ç¤ºç§»åŠ¨åˆ°: (" + new_x.to_string() + ", " + new_y.to_string() + ")")
    }
    None => {
      println("âŒ å›åˆæ˜¾ç¤ºæœªåˆ›å»º")
    }
  }
}

///|
// è®¾ç½®å›åˆæ˜¾ç¤ºå¯è§æ€§
pub fn set_turn_display_visibility(is_visible: Bool) -> Unit {
  turn_display_state.is_active = is_visible
  
  match turn_display_state.turn_display {
    Some(turn_display) => {
      // è¿™é‡Œå¯ä»¥è®¾ç½®å®ä½“çš„å¯è§æ€§
      println("ğŸ“Š å›åˆæ˜¾ç¤ºå¯è§æ€§: " + is_visible.to_string())
    }
    None => {
      println("âŒ å›åˆæ˜¾ç¤ºæœªåˆ›å»º")
    }
  }
}

///|
// æ¸…ç†å›åˆæ˜¾ç¤º
pub fn clear_turn_display() -> Unit {
  turn_display_state.is_active = false
  turn_display_state.turn_display = None
  turn_display_state.current_turn = 1
  turn_display_state.current_turn_type = "ç©å®¶"
  
  println("ğŸ“Š å›åˆæ˜¾ç¤ºæ¸…ç†å®Œæˆ")
}

///|
// è·å–å›åˆæ˜¾ç¤ºçŠ¶æ€
pub fn get_turn_display_status() -> String {
  let status = if turn_display_state.is_active {
    "æ´»è·ƒ"
  } else {
    "æœªæ¿€æ´»"
  }
  
  let turn_display_status = if turn_display_state.turn_display.is_some() {
    "å·²åˆ›å»º"
  } else {
    "æœªåˆ›å»º"
  }
  
  "å›åˆæ˜¾ç¤ºçŠ¶æ€: " + status + ", å›åˆæ˜¾ç¤º: " + turn_display_status + ", å½“å‰å›åˆ: " + turn_display_state.current_turn.to_string() + ", ç±»å‹: " + turn_display_state.current_turn_type
}

///|
// åˆå§‹åŒ–å›åˆæ˜¾ç¤ºç³»ç»Ÿ
pub fn init_turn_display_system() -> Unit {
  println("=== åˆå§‹åŒ–å›åˆæ˜¾ç¤ºç³»ç»Ÿ ===")
  
  // åˆ›å»ºå›åˆæ˜¾ç¤º
  let turn_display = create_turn_display()
  turn_display_state.turn_display = Some(turn_display)
  turn_display_state.is_active = true
  turn_display_state.current_turn = 1
  turn_display_state.current_turn_type = "ç©å®¶"
  
  println("å›åˆæ˜¾ç¤ºåˆ›å»ºæˆåŠŸ")
  println("å›åˆæ˜¾ç¤ºç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
}

///|
// æµ‹è¯•å›åˆæ˜¾ç¤ºç³»ç»Ÿ
pub fn test_turn_display_system() -> Unit {
  println("=== æµ‹è¯•å›åˆæ˜¾ç¤ºç³»ç»Ÿ ===")
  
  // åˆå§‹åŒ–å›åˆæ˜¾ç¤ºç³»ç»Ÿ
  init_turn_display_system()
  println("âœ… å›åˆæ˜¾ç¤ºç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
  
  // æ›´æ–°å›åˆæ˜¾ç¤º
  update_turn_display(1, "ç©å®¶")
  update_turn_display(2, "æ•Œäºº")
  update_turn_display(3, "ç©å®¶")
  println("âœ… å›åˆæ˜¾ç¤ºæ›´æ–°å®Œæˆ")
  
  // è·å–çŠ¶æ€ä¿¡æ¯
  let status = get_turn_display_status()
  println("ğŸ“Š " + status)
  
  // æµ‹è¯•å¯è§æ€§è®¾ç½®
  set_turn_display_visibility(false)
  set_turn_display_visibility(true)
  println("âœ… å›åˆæ˜¾ç¤ºå¯è§æ€§è®¾ç½®å®Œæˆ")
  
  // æ¸…ç†æµ‹è¯•
  clear_turn_display()
  println("âœ… å›åˆæ˜¾ç¤ºæ¸…ç†å®Œæˆ")
  
  println("=== å›åˆæ˜¾ç¤ºç³»ç»Ÿæµ‹è¯•å®Œæˆ ===")
}

///|
// åˆ›å»ºå®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºæ¨¡ç‰ˆï¼ˆåŒ…å«æ–‡æœ¬å’Œè¡€æ¡ï¼‰
pub fn create_pokemon_info_template(
  config: PokemonInfoConfig,
  pokemon_name: String,
  pokemon_level: Int,
  max_hp: Int
) -> PokemonInfoEntities {
  let name_entity = @system.Entity::new()
  let level_entity = @system.Entity::new()
  let background_entity = @system.Entity::new()
  let fill_entity = @system.Entity::new()
  let hp_text_entity = @system.Entity::new()
  
  // è®¡ç®—ç›¸å¯¹ä½ç½® - å¢åŠ æ–‡æœ¬ä¸è¡€æ¡ä¹‹é—´çš„é—´è·
  let name_position = @math.Vec2D(config.base_position.0 + 5.0, config.base_position.1 + 5.0)
  let level_position = @math.Vec2D(config.base_position.0 + 5.0, config.base_position.1 + 25.0)
  let health_bar_position = @math.Vec2D(config.base_position.0, config.base_position.1 + 45.0)
  let hp_text_position = @math.Vec2D(config.base_position.0 + 5.0, config.base_position.1 + config.height + 55.0)  // å¢åŠ 10åƒç´ é—´è·
  
  // åˆ›å»ºå®å¯æ¢¦åç§°æ–‡æœ¬
  let name_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(pokemon_name, font="16px Arial", color="white"),
    20
  )
  @sprite.sprites.set(name_entity, name_sprite)
  @position.positions.set(name_entity, name_position)
  
  // åˆ›å»ºç­‰çº§æ–‡æœ¬
  let level_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new("Lv." + pokemon_level.to_string(), font="14px Arial", color="white"),
    20
  )
  @sprite.sprites.set(level_entity, level_sprite)
  @position.positions.set(level_entity, level_position)
  
  // åˆ›å»ºè¡€æ¡èƒŒæ™¯
  let background_sprite = @sprite.Sprite::from_color_rect(
    @sprite.ColorRect::new(
      @math.Vec2D(config.width, config.height),
      config.background_color
    ),
    20
  )
  @sprite.sprites.set(background_entity, background_sprite)
  @position.positions.set(background_entity, health_bar_position)
  
  // åˆ›å»ºè¡€æ¡å¡«å……
  let fill_sprite = @sprite.Sprite::from_color_rect(
    @sprite.ColorRect::new(
      @math.Vec2D(config.width - 4.0, config.height - 4.0),
      config.fill_color
    ),
    21
  )
  @sprite.sprites.set(fill_entity, fill_sprite)
  @position.positions.set(fill_entity, @math.Vec2D(health_bar_position.0 + 2.0, health_bar_position.1 + 2.0))
  
  // åˆ›å»ºHPæ–‡æœ¬
  let hp_text = "HP: " + max_hp.to_string() + "/" + max_hp.to_string()
  let hp_text_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(hp_text, font="12px Arial", color=config.text_color),
    22
  )
  @sprite.sprites.set(hp_text_entity, hp_text_sprite)
  @position.positions.set(hp_text_entity, hp_text_position)
  
  let bar_type_name = match config.bar_type {
    HealthBarType::Player => "ç©å®¶"
    HealthBarType::Enemy => "æ•Œäºº"
  }
  
  println("ğŸ“Š åˆ›å»ºå®å¯æ¢¦ä¿¡æ¯æ¨¡ç‰ˆ: " + bar_type_name + ", " + pokemon_name + " Lv." + pokemon_level.to_string() + ", HP: " + max_hp.to_string())
  
  {
    name_entity: name_entity,
    level_entity: level_entity,
    background_entity: background_entity,
    fill_entity: fill_entity,
    hp_text_entity: hp_text_entity,
    bar_type: config.bar_type,
    base_position: config.base_position
  }
}

///|
// åˆ›å»ºç©å®¶å®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤º
pub fn create_player_pokemon_info(pokemon_name: String, pokemon_level: Int, max_hp: Int) -> PokemonInfoEntities {
  let player_config = {
    base_position: @math.Vec2D(300.0, 400.0),  // æˆ˜æ–—é¡µé¢ä¸­æˆ‘æ–¹å®å¯æ¢¦çš„å³ä¾§
    width: 200.0,
    height: 20.0,
    background_color: "#333333",
    fill_color: "#00FF00",  // ç»¿è‰²
    text_color: "#FFFFFF",
    bar_type: HealthBarType::Player
  }
  
  let pokemon_info = create_pokemon_info_template(player_config, pokemon_name, pokemon_level, max_hp)
  
  // æ›´æ–°å…¨å±€çŠ¶æ€
  health_bar_ui_state.player_health_bar = Some({
    background_entity: pokemon_info.background_entity,
    fill_entity: pokemon_info.fill_entity,
    text_entity: pokemon_info.hp_text_entity,
    bar_type: pokemon_info.bar_type
  })
  
  health_bar_ui_state.health_bar_entities.push(pokemon_info.background_entity)
  health_bar_ui_state.health_bar_entities.push(pokemon_info.fill_entity)
  health_bar_ui_state.health_bar_entities.push(pokemon_info.hp_text_entity)
  
  println("ğŸ“Š ç©å®¶å®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºåˆ›å»ºå®Œæˆ")
  pokemon_info
}

///|
// åˆ›å»ºæ•Œäººå®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤º
pub fn create_enemy_pokemon_info(pokemon_name: String, pokemon_level: Int, max_hp: Int) -> PokemonInfoEntities {
  let enemy_config = {
    base_position: @math.Vec2D(450.0, 50.0),  // å‘å·¦ç§»åŠ¨ä¸€ç‚¹
    width: 200.0,
    height: 20.0,
    background_color: "#333333",
    fill_color: "#FF0000",  // çº¢è‰²
    text_color: "#FFFFFF",
    bar_type: HealthBarType::Enemy
  }
  
  let pokemon_info = create_pokemon_info_template(enemy_config, pokemon_name, pokemon_level, max_hp)
  
  // æ›´æ–°å…¨å±€çŠ¶æ€
  health_bar_ui_state.enemy_health_bar = Some({
    background_entity: pokemon_info.background_entity,
    fill_entity: pokemon_info.fill_entity,
    text_entity: pokemon_info.hp_text_entity,
    bar_type: pokemon_info.bar_type
  })
  
  health_bar_ui_state.health_bar_entities.push(pokemon_info.background_entity)
  health_bar_ui_state.health_bar_entities.push(pokemon_info.fill_entity)
  health_bar_ui_state.health_bar_entities.push(pokemon_info.hp_text_entity)
  
  println("ğŸ“Š æ•Œäººå®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºåˆ›å»ºå®Œæˆ")
  pokemon_info
}

///|
// æ›´æ–°å®å¯æ¢¦ä¿¡æ¯æ˜¾ç¤ºï¼ˆåŒ…å«æ–‡æœ¬å’Œè¡€æ¡ï¼‰
pub fn update_pokemon_info_display(
  pokemon_info: PokemonInfoEntities,
  pokemon_name: String,
  pokemon_level: Int,
  current_hp: Int,
  max_hp: Int
) -> Unit {
  // æ›´æ–°å®å¯æ¢¦åç§°
  let name_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(pokemon_name, font="16px Arial", color="white"),
    20
  )
  @sprite.sprites.set(pokemon_info.name_entity, name_sprite)
  
  // æ›´æ–°ç­‰çº§æ–‡æœ¬
  let level_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new("Lv." + pokemon_level.to_string(), font="14px Arial", color="white"),
    20
  )
  @sprite.sprites.set(pokemon_info.level_entity, level_sprite)
  
  // æ›´æ–°è¡€æ¡æ˜¾ç¤º
  let hp_percentage = if max_hp > 0 {
    current_hp.to_double() / max_hp.to_double()
  } else {
    0.0
  }
  
  let clamped_percentage = if hp_percentage < 0.0 { 0.0 } else if hp_percentage > 1.0 { 1.0 } else { hp_percentage }
  let new_fill_width = (200.0 - 4.0) * clamped_percentage
  
  // æ›´æ–°è¡€æ¡å¡«å……
  let fill_color = if clamped_percentage > 0.5 {
    if pokemon_info.bar_type == HealthBarType::Player { "#00FF00" } else { "#FF0000" }
  } else if clamped_percentage > 0.25 {
    "#FFFF00"  // é»„è‰²
  } else {
    "#FF0000"  // çº¢è‰²
  }
  
  let fill_sprite = @sprite.Sprite::from_color_rect(
    @sprite.ColorRect::new(
      @math.Vec2D(new_fill_width, 20.0 - 4.0),
      fill_color
    ),
    21
  )
  @sprite.sprites.set(pokemon_info.fill_entity, fill_sprite)
  
  // ä¼˜åŒ–ï¼šåªåœ¨æ–‡æœ¬å†…å®¹çœŸæ­£æ”¹å˜æ—¶æ‰æ›´æ–°
  let hp_text = "HP: " + current_hp.to_string() + "/" + max_hp.to_string()
  let text_color = if clamped_percentage < 0.33 { "#FF0000" } else { "#FFFFFF" }
  
  // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ–‡æœ¬
  let current_hp_text_sprite = @sprite.sprites.get(pokemon_info.hp_text_entity)
  match current_hp_text_sprite {
    Some(_) => {
      // åªæ›´æ–°æ–‡æœ¬å†…å®¹ï¼Œä¸é‡æ–°åˆ›å»ºæ•´ä¸ªç²¾çµ
      let hp_text_sprite = @sprite.Sprite::from_text(
        @sprite.Text::new(hp_text, font="12px Arial", color=text_color),
        22
      )
      @sprite.sprites.set(pokemon_info.hp_text_entity, hp_text_sprite)
    }
    None => {
      // åªæœ‰åœ¨æ–‡æœ¬ç²¾çµä¸å­˜åœ¨æ—¶æ‰é‡æ–°åˆ›å»º
      let hp_text_sprite = @sprite.Sprite::from_text(
        @sprite.Text::new(hp_text, font="12px Arial", color=text_color),
        22
      )
      @sprite.sprites.set(pokemon_info.hp_text_entity, hp_text_sprite)
    }
  }
  
  let bar_type_name = match pokemon_info.bar_type {
    HealthBarType::Player => "ç©å®¶"
    HealthBarType::Enemy => "æ•Œäºº"
  }
  
  println("ğŸ“Š æ›´æ–°å®å¯æ¢¦ä¿¡æ¯: " + bar_type_name + " " + pokemon_name + " Lv." + pokemon_level.to_string() + " HP: " + current_hp.to_string() + "/" + max_hp.to_string() + " (" + (clamped_percentage * 100.0).to_string() + "%)")
}

///|
// åˆå§‹åŒ–UIç³»ç»Ÿ
fn init_ui_system() -> Unit {
  println("=== åˆå§‹åŒ–UIç³»ç»Ÿ ===")
  
  // åˆå§‹åŒ–è°ƒè¯•å±å¹•ç³»ç»Ÿ
  init_debug_screen_system()
  
  // åˆå§‹åŒ–è¡€æ¡UIç³»ç»Ÿ
  init_health_bar_ui()
  
  // åˆå§‹åŒ–å›åˆæ˜¾ç¤ºç³»ç»Ÿ
  init_turn_display_system()
  
  println("UIç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
}

///|
// æµ‹è¯•UIç³»ç»Ÿ
fn test_ui_system() -> Unit {
  println("=== æµ‹è¯•UIç³»ç»Ÿ ===")
  
  // æµ‹è¯•è°ƒè¯•å±å¹•ç³»ç»Ÿ
  test_debug_screen_system()
  
  // æµ‹è¯•è¡€æ¡UIç³»ç»Ÿ
  test_health_bar_ui_system()
  
  // æµ‹è¯•å›åˆæ˜¾ç¤ºç³»ç»Ÿ
  test_turn_display_system()
  
  println("UIç³»ç»Ÿæµ‹è¯•å®Œæˆ")
} 