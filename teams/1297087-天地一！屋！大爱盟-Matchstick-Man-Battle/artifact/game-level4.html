<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ¸¸æˆ - Level 4</title>

    <script type="text/javascript">const min = Math.min;</script>

    <!-- ä¿ç•™æ—§é¡¹ç›®çš„ jQueryï¼ˆè‹¥å…¶å®ƒè„šæœ¬ä¾èµ–ï¼‰ -->
    <script type="text/javascript" src="./lib/jquery-1.4.2.min.js" ></script>
    <script type="text/javascript">
    jQuery.noConflict();
    Object.extend = jQuery.extend;
    </script>
    <script src="lib/jquery.svg.min.js"></script>

    <link rel="stylesheet" href="./shared-ui.css">
    <script src="./assets/navigation.js"></script>
    <!-- ä¸åœ¨ head ä¸­åŠ è½½ p5/box2d/game è„šæœ¬ï¼Œç»Ÿä¸€åœ¨ body åº•éƒ¨åŠ è½½ -->
</head>

<body>
    <div class="top-controls">
        <button id="back-to-menu">è¿”å›èœå•</button>
    </div>

    <div id="game-layout">
        <aside class="side-panel" id="left-panel">
            <section>
                <h3>ğŸµ éŸ³æ•ˆæ§åˆ¶</h3>
                <div class="control-item">
                    <label for="volume-slider">éŸ³é‡</label>
                    <input type="range" id="volume-slider" min="0" max="100" value="50">
                    <div class="volume-display" id="volume-display">50%</div>
                </div>
            </section>
        </aside>

        <div id="game-center">
            <div id="hud" aria-live="polite">
                <div id="player-0" class="player-panel pp-left" role="region" aria-label="Player 0">
                    <div class="avatar" id="p0-avatar">ğŸ‘¤</div>
                    <div class="meta">
                        <div class="name" id="p0-name">ç©å®¶ 0</div>
                        <div class="sub hp"><div class="bar"><div class="fill" id="p0-hp-fill" style="width:100%"></div></div><div class="value" id="p0-hp-text">100/100</div></div>
                    </div>
                    <div style="margin-left:auto; text-align:right; display:flex; flex-direction:column; gap:6px;">
                        <div class="stat">å¼¹è¯: <span id="p0-ammo">â€”</span></div>
                        <div class="stat">åˆ†æ•°: <span id="p0-score">â€”</span></div>
                    </div>
                </div>
                <div id="player-1" class="player-panel pp-right" role="region" aria-label="Player 1">
                    <div style="display:flex; flex-direction:column; gap:6px; text-align:left;">
                        <div class="stat">åˆ†æ•°: <span id="p1-score">â€”</span></div>
                        <div class="stat">å¼¹è¯: <span id="p1-ammo">â€”</span></div>
                    </div>
                    <div style="margin-left:12px; text-align:left;" class="meta">
                        <div class="name" id="p1-name">ç©å®¶ 1</div>
                        <div class="sub hp"><div class="bar"><div class="fill" id="p1-hp-fill" style="width:100%"></div></div><div class="value" id="p1-hp-text">100/100</div></div>
                    </div>
                    <div class="avatar" id="p1-avatar">ğŸ¤–</div>
                </div>
            </div>

            <div id="stage-wrapper">
                <canvas id="fx-canvas" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:0;display:block;"></canvas>
                <div class="scanlines" aria-hidden="true" style="z-index:4;"></div>
                <div id="fx-flash" aria-hidden="true" style="z-index:6;pointer-events:none;position:absolute;inset:0;opacity:0;transition:opacity 220ms ease;mix-blend-mode:screen;"></div>
                <div id="game-container"><canvas id="canvas" style="display:block;" height="32" width="32"></canvas></div>
            </div>
        </div>

        <aside class="side-panel" id="right-panel">
            <section>
                <h3>ğŸ† æ¸¸æˆç»Ÿè®¡</h3>
                <div class="stat-item"><span class="stat-label">æœ€é«˜åˆ†</span><span class="stat-value" id="high-score">â€”</span></div>
            </section>
        </aside>
    </div>

    <!-- å…ˆåŠ è½½è¿è¡Œæ—¶ä¾èµ–ï¼ˆCDNï¼‰ï¼Œå†åŠ è½½æœ¬åœ°æ„å»ºçš„æ¸¸æˆè„šæœ¬ -->
    <script src="./p5.js"></script>

    <!-- ä½¿ç”¨æœ¬åœ° box2d.jsï¼ˆæ›¿ä»£è¢«é˜»æ­¢çš„ CDN ç‰ˆæœ¬ï¼‰ -->
    <script src="./box2d.js"></script>

    <!-- è¿è¡Œæ—¶æ£€æµ‹ï¼ˆå¦‚æœ Box2D æœªå®šä¹‰ï¼Œæ‰“å°è­¦å‘Šï¼‰ -->
    <script>
        (function(){
            function checkBox2D(){
                // æœ¬åœ° box2d.js å¯¼å‡ºçš„æ˜¯ b2* ç¬¦å·ï¼ˆä¾‹å¦‚ b2World / b2Vec2 / b2Settingsï¼‰ï¼Œè€Œä¸æ˜¯å…¨å±€å‘½åç©ºé—´ `Box2D`ã€‚
                // å› æ­¤ç”¨æ›´å¯é çš„æ£€æµ‹æ¥é¿å…è¯¯æŠ¥ã€‚
                if (typeof b2World === 'undefined' && typeof b2Vec2 === 'undefined' && typeof b2Settings === 'undefined') {
                    console.warn('Box2D æœªæ£€æµ‹åˆ°ï¼šæœ¬åœ° ./box2d.js å¯èƒ½æœªæ­£ç¡®åŠ è½½ï¼Œæˆ–å¯¼å‡ºç¬¦å·ä¸åŒ¹é…ã€‚è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„ã€è„šæœ¬åŠ è½½é¡ºåºï¼ˆp5 -> box2d -> gameï¼‰æˆ–æ§åˆ¶å°ä¸­çš„è„šæœ¬é”™è¯¯ã€‚');
                }
            }
            if (document.readyState === 'complete') {
                setTimeout(checkBox2D, 50);
            } else {
                window.addEventListener('load', function(){ setTimeout(checkBox2D, 50); });
            }
        })();
    </script>

    <!-- æ¸¸æˆæ„å»ºè„šæœ¬ï¼ˆå¯èƒ½åŒ…å« p5 ä»£ç ï¼‰ï¼Œç¡®ä¿åœ¨ p5 ä¹‹ååŠ è½½ -->
    <script src="./target/js/release/build/game-level4/game-level4.js"></script>
    <!-- è‡ªåŠ¨ hook è„šæœ¬ï¼šè¿è¡Œæ—¶ä¸ºæ„å»ºäº§ç‰©æ³¨å…¥ getter/health-change æ¢æµ‹ -->
    <script src="./auto_hooks/level2_runtime_hook.js"></script>
    <script src="./shared-ui.js"></script>

    <!-- è„šæœ¬ï¼šè¿”å›èœå•æŒ‰é’®è¡Œä¸º + æŠŠç°æœ‰æˆ–æ–°åˆ›å»ºçš„ canvas å½’ä½åˆ° #game-container -->
    <script>
        document.getElementById('back-to-menu').addEventListener('click', function() {
            window.location.href = 'index.html';
        });

        // åœ¨é¡µé¢å®Œå…¨åŠ è½½åæŠŠ canvas å…ƒç´ ç§»åŠ¨åˆ°å®¹å™¨å†…ï¼Œå¹¶æ ¹æ® canvas å®é™…å°ºå¯¸è°ƒæ•´å®¹å™¨å¤§å°ã€‚
        // å…¼å®¹åœºæ™¯ï¼šé™æ€ <canvas id="canvas"> æˆ– p5 åœ¨å¤–éƒ¨è„šæœ¬ä¸­åˆ›å»ºçš„ canvasã€‚
        (function() {
            var container = document.getElementById('game-container');
            if (!container) return;

            // æŠŠ body ç›´æ¥å­èŠ‚ç‚¹çš„ canvasï¼ˆè‹¥å­˜åœ¨ï¼‰ç§»åŠ¨è¿›å®¹å™¨
            function moveExistingCanvases() {
                var canvases = Array.prototype.slice.call(document.querySelectorAll('body > canvas'));
                canvases.forEach(function(c) {
                    if (c.parentNode !== container) {
                        container.appendChild(c);
                    }
                });
            }

            // é€‰æ‹©åº”ä½œä¸ºä¸»æ˜¾ç¤ºçš„ canvasï¼šä¼˜å…ˆé€‰æ‹© p5 ç”Ÿæˆçš„ï¼ˆclass åŒ…å« p5Canvasï¼‰ï¼Œå¦åˆ™é€‰æ‹©é¢ç§¯æœ€å¤§çš„
            function pickPrimaryCanvas() {
                var list = Array.prototype.slice.call(container.querySelectorAll('canvas'));
                if (list.length === 0) return null;
                var p5c = list.find(function(c){ return (c.classList && c.classList.contains('p5Canvas')); });
                var primary = p5c || list.reduce(function(best, c){
                    var br = c.getBoundingClientRect();
                    var area = Math.floor((br.width||0) * (br.height||0));
                    if (!best) return { c: c, area: area };
                    return (area > best.area) ? { c: c, area: area } : best;
                }, null);
                var chosen = p5c || (primary && primary.c) || list[0];
                // éšè—å…¶å®ƒéä¸» canvasï¼ˆå¦‚é™æ€å ä½ç”¨çš„ 32x32 fallbackï¼‰
                list.forEach(function(c){ if (c !== chosen) { c.style.display = 'none'; } else { c.style.display = 'block'; } });
                return chosen;
            }

            // æ ¹æ® canvas çš„CSSå°ºå¯¸è°ƒæ•´å®¹å™¨å°ºå¯¸ï¼ˆé¿å… DPR é€ æˆçš„ 1~å‡ åƒç´ è¯¯å·®ï¼‰
            function fitContainerToCanvas(canvas) {
                if (!canvas) return;
                // ä½¿ç”¨ getBoundingClientRect è·å–CSSåƒç´ ä¸‹çš„å¯è§å°ºå¯¸
                var rect = canvas.getBoundingClientRect();
                var w = Math.round(rect.width);
                var h = Math.round(rect.height);
                if (!w || !h) {
                    // å›é€€æ–¹æ¡ˆï¼šä½¿ç”¨ clientWidth/Height
                    w = Math.round(canvas.clientWidth || canvas.width || 0);
                    h = Math.round(canvas.clientHeight || canvas.height || 0);
                }
                if (w > 0) container.style.width = w + 'px';
                if (h > 0) container.style.height = h + 'px';
            }

            // Observe additions to the container: å½“ p5 createCanvas æ—¶ï¼Œcanvas ä¼šè¢« parent åˆ° container
            var mo = new MutationObserver(function(mutations) {
                mutations.forEach(function(m) {
                    if (m.type === 'childList' && m.addedNodes.length) {
                        m.addedNodes.forEach(function(node) {
                            if (node.nodeName === 'CANVAS') {
                                // é€‰æ‹©ä¸» canvas å¹¶ç¡®ä¿å®¹å™¨å¤§å°åŒ¹é…
                                var main = pickPrimaryCanvas() || node;
                                // è‹¥å­˜åœ¨é™æ€å ä½ canvasï¼Œéšè—å®ƒ
                                var fallback = container.querySelector('canvas#canvas');
                                if (fallback && fallback !== main) fallback.style.display = 'none';
                                fitContainerToCanvas(main);

                                // å¦‚æœæµè§ˆå™¨æ”¯æŒ ResizeObserverï¼Œç›‘å¬ canvas å¤§å°å˜åŒ–ï¼ˆä¾‹å¦‚ p.resizeCanvasï¼‰
                                if (window.ResizeObserver) {
                                    var ro = new ResizeObserver(function() {
                                        var m = pickPrimaryCanvas() || main;
                                        fitContainerToCanvas(m);
                                    });
                                    ro.observe(main);
                                }
                            }
                        });
                    }
                });
            });
            mo.observe(container, { childList: true, subtree: false });

            // ä¹ŸæŠŠé¡µé¢ä¸Šå·²å­˜åœ¨çš„ canvas ç§»å…¥å¹¶é€‚é…ï¼ˆä¾‹å¦‚é™æ€ fallbackï¼‰
            if (document.readyState === 'complete') {
                moveExistingCanvases();
                var main = pickPrimaryCanvas();
                if (main) fitContainerToCanvas(main);
            } else {
                window.addEventListener('load', function() {
                    moveExistingCanvases();
                    var main = pickPrimaryCanvas();
                    if (main) fitContainerToCanvas(main);
                });
            }
        })();
    
                // HUD æ›´æ–°é€»è¾‘ï¼šå®šæœŸä» window.__mmb_get_state() è¯»å–ï¼ˆè‹¥å­˜åœ¨ï¼‰å¹¶æ›´æ–°æ˜¾ç¤º
                (function() {
                    function safeText(id, v) { var el = document.getElementById(id); if (el) el.textContent = (v===null || v===undefined) ? 'â€”' : v; }
                    function safeIcon(id, icon) { var el = document.getElementById(id); if (el) el.textContent = icon || 'ğŸ‘¤'; }
                    function safeFill(id, pct, textId) { var f = document.getElementById(id); if (f) f.style.width = (pct) + '%'; if (textId) { var t = document.getElementById(textId); if (t) t.textContent = pct + '/100'; } }

                    function updateHUD() {
                        try {
                            var getter = window.__mmb_get_state;
                            var state = undefined;
                            if (typeof getter === 'function') state = getter();
                            else if (window.__mmb_game) {
                                // best-effort fallback
                                var raw = window.__mmb_game;
                                if (raw && raw.particle_list && raw.particle_list.length>0) {
                                    state = { players: [] };
                                    for (var i=0;i<raw.particle_list.length;i++) {
                                        var p = raw.particle_list[i];
                                        var ctrl = p && p.control ? p.control : { health:0 };
                                        state.players.push({ index: p.index, health: ctrl.health, name: (p.name||null) });
                                    }
                                }
                            }

                            if (!state || !state.players) return;

                            // update player 0
                            var p0 = state.players[0] || { health:0, name:'P0', ammo:null, score:null, avatar:null };
                            var hp0 = Math.max(0, Math.min(100, (p0.health===undefined||p0.health===null)?0:p0.health));
                            safeFill('p0-hp-fill', hp0, 'p0-hp-text');
                            safeText('p0-name', p0.name || ('P'+(p0.index===undefined?0:p0.index)));
                            safeText('p0-ammo', (p0.ammo===null||p0.ammo===undefined)?'â€”':p0.ammo);
                            safeText('p0-score', (p0.score===null||p0.score===undefined)?'â€”':p0.score);
                            safeIcon('p0-avatar', 'ğŸ‘¤');

                            // update player 1
                            var p1 = state.players[1] || { health:0, name:'P1', ammo:null, score:null, avatar:null };
                            var hp1 = Math.max(0, Math.min(100, (p1.health===undefined||p1.health===null)?0:p1.health));
                            safeFill('p1-hp-fill', hp1, 'p1-hp-text');
                            safeText('p1-name', p1.name || ('P'+(p1.index===undefined?1:p1.index)));
                            safeText('p1-ammo', (p1.ammo===null||p1.ammo===undefined)?'â€”':p1.ammo);
                            safeText('p1-score', (p1.score===null||p1.score===undefined)?'â€”':p1.score);
                            safeIcon('p1-avatar', 'ğŸ¤–');

                        } catch (e) {
                            // ignore update errors
                        }
                    }

                    // Poll at 10Hz for smooth but light updates
                    setInterval(updateHUD, 100);
                    setTimeout(updateHUD, 250);
                })();

                // FX: ç²’å­åŠ¨ç”»ï¼ˆè½»é‡ï¼‰
                (function(){
                    var canvas = document.getElementById('fx-canvas');
                    if (!canvas) return;
                    var container = document.getElementById('stage-wrapper');
                    var ctx = canvas.getContext('2d');
                    var dpi = window.devicePixelRatio || 1;
                                var particles = [];
                                // queue for external FX triggers (e.g., hits)
                                if (!window.__mmb_fx_queue) window.__mmb_fx_queue = [];
                                window.__mmb_trigger_hit = function(playerIndex, screenX, screenY, damage) {
                                    try {
                                        window.__mmb_fx_queue.push({ type: 'hit', player: playerIndex, x: screenX, y: screenY, damage: damage });
                                    } catch (e) {}
                                };
                    var running = true;

                    function resize() {
                        var w = container.clientWidth;
                        var h = container.clientHeight;
                        canvas.style.width = w + 'px';
                        canvas.style.height = h + 'px';
                        canvas.width = Math.max(1, Math.floor(w * dpi));
                        canvas.height = Math.max(1, Math.floor(h * dpi));
                        ctx.setTransform(dpi,0,0,dpi,0,0);
                    }

                    function spawn(n) {
                        for (var i=0;i<n;i++) {
                            particles.push({
                                x: Math.random()*container.clientWidth,
                                y: Math.random()*container.clientHeight,
                                vx: (Math.random()-0.5)*0.6,
                                vy: (Math.random()-0.5)*0.6,
                                r: 2 + Math.random()*6,
                                life: 200 + Math.floor(Math.random()*400),
                                alpha: 0.08 + Math.random()*0.18
                            });
                        }
                    }

                    function spawnBurst(x,y,count,color) {
                        for (var i=0;i<count;i++) {
                            var ang = Math.random()*Math.PI*2;
                            var speed = 1 + Math.random()*3;
                            particles.push({ x: x + (Math.random()-0.5)*6, y: y + (Math.random()-0.5)*6, vx: Math.cos(ang)*speed, vy: Math.sin(ang)*speed, r: 1+Math.random()*4, life: 40+Math.floor(Math.random()*60), alpha: 0.3, color: color });
                        }
                    }

                        // æ”¹ä¸ºæ™ƒåŠ¨æ•´ä¸ªèˆå°ï¼šæ ¹æ®å¼ºåº¦ï¼ˆdamageï¼‰æ§åˆ¶åƒç´ åç§»ä¸æ—¶é•¿
                        function shakeStage(intensity, duration) {
                            try {
                                var el = document.getElementById('stage-wrapper');
                                if (!el) return;
                                var start = performance.now();
                                var rafId = null;
                                // æ¸…é™¤å·²æœ‰çš„ transform ä¿è¯å åŠ ä¸ä¼šç´¯ç§¯
                                var prev = el.__shake_prev || '';
                                el.__shake_prev = prev;

                                function tick(now) {
                                    var elapsed = now - start;
                                    var t = elapsed / duration;
                                    if (t >= 1) {
                                        el.style.transform = '';
                                        if (rafId) cancelAnimationFrame(rafId);
                                        return;
                                    }
                                    // éšæœºæŠ–åŠ¨ï¼Œéšæ—¶é—´è¡°å‡
                                    var damper = 1 - t;
                                    var max = intensity * damper;
                                    var x = (Math.random() * 2 - 1) * max;
                                    var y = (Math.random() * 2 - 1) * max;
                                    var rot = (Math.random() * 2 - 1) * (max * 0.06);
                                    el.style.transform = 'translate(' + x.toFixed(2) + 'px,' + y.toFixed(2) + 'px) rotate(' + rot.toFixed(2) + 'deg)';
                                    rafId = requestAnimationFrame(tick);
                                }
                                rafId = requestAnimationFrame(tick);
                            } catch (e) { /* ignore */ }
                        }

                    function step() {
                        if (!running) return;
                        ctx.clearRect(0,0,canvas.width, canvas.height);
                        ctx.globalCompositeOperation = 'lighter';
                        for (var i=particles.length-1;i>=0;i--) {
                            var p = particles[i];
                            p.x += p.vx;
                            p.y += p.vy;
                            p.life--;
                            p.alpha *= 0.9997;
                            if (p.x < -20) p.x = container.clientWidth + 20;
                            if (p.x > container.clientWidth + 20) p.x = -20;
                            if (p.y < -20) p.y = container.clientHeight + 20;
                            if (p.y > container.clientHeight + 20) p.y = -20;
                            var grd = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r*2);
                            if (p.color) {
                                grd.addColorStop(0, 'rgba('+p.color.r+','+p.color.g+','+p.color.b+','+ (p.alpha*0.9) +')');
                                grd.addColorStop(1, 'rgba('+p.color.r+','+p.color.g+','+p.color.b+',0)');
                            } else {
                                grd.addColorStop(0, 'rgba(255,255,255,'+ (p.alpha*0.9) +')');
                                grd.addColorStop(1, 'rgba(120,80,255,0)');
                            }
                            ctx.fillStyle = grd;
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                            ctx.fill();
                            if (p.life <= 0) particles.splice(i,1);
                        }
                        // process FX queue
                        if (window.__mmb_fx_queue && window.__mmb_fx_queue.length) {
                            while (window.__mmb_fx_queue.length) {
                                var q = window.__mmb_fx_queue.shift();
                                if (q && q.type === 'hit') {
                                    // q.x/q.y expected to be screen coordinates relative to game container
                                    var sx = q.x, sy = q.y;
                                    // clamp
                                    if (typeof sx !== 'number' || typeof sy !== 'number') { sx = container.clientWidth/2; sy = container.clientHeight/2; }
                                    // æ”¹ä¸ºè§¦å‘æ•´ä½“æ™ƒåŠ¨ï¼ˆåŸºäºä¼¤å®³ï¼‰ï¼Œå¹¶ä¿ç•™çŸ­æš‚é—ªç™½æ•ˆæœï¼›ç§»é™¤åŸå…ˆçš„ç²’å­çˆ†å‘ï¼ˆå› ä¸æ˜æ˜¾ï¼‰
                                    var dmg = q.damage || 10;
                                    // intensity: åƒç´ åç§»ï¼Œduration: æ¯«ç§’
                                    var intensity = Math.min(28, 4 + Math.floor(dmg * 0.6));
                                    var duration = Math.min(700, 120 + Math.floor(dmg * 12));
                                    try { shakeStage(intensity, duration); } catch(e) {}
                                    // flashï¼ˆæ›´çŸ­æ›´æŸ”å’Œï¼‰
                                    try {
                                        var flash = document.getElementById('fx-flash');
                                        if (flash) {
                                            flash.style.background = 'radial-gradient(circle at '+(sx/container.clientWidth*100).toFixed(1)+'% '+(sy/container.clientHeight*100).toFixed(1)+'%, rgba(255,220,200,0.28), rgba(255,60,140,0.06) 36%, rgba(0,0,0,0) 56%)';
                                            flash.style.opacity = 0.72;
                                            setTimeout(function(){ flash.style.opacity = 0; }, Math.min(240, Math.max(120, Math.floor(duration*0.28))));
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                        // keep density constant
                        if (particles.length < 36) spawn(6);
                        requestAnimationFrame(step);
                    }

                    window.addEventListener('resize', function(){ resize(); });
                    // ensure initial layout ready
                    setTimeout(function(){ resize(); spawn(36); requestAnimationFrame(step); }, 200);
                })();

                // ä¾§è¾¹é¢æ¿æ§åˆ¶é€»è¾‘
                (function(){
                    // éŸ³é‡æ§åˆ¶
                    var volumeSlider = document.getElementById('volume-slider');
                    var volumeDisplay = document.getElementById('volume-display');
                    var muteToggle = document.getElementById('mute-toggle');
                    
                    if (volumeSlider && volumeDisplay) {
                        volumeSlider.addEventListener('input', function(){
                            volumeDisplay.textContent = this.value + '%';
                            // TODO: è¿æ¥åˆ°å®é™…éŸ³é¢‘æ§åˆ¶
                            if (window.__mmb_setVolume) window.__mmb_setVolume(this.value / 100);
                        });
                    }
                    
                    if (muteToggle) {
                        muteToggle.addEventListener('change', function(){
                            // TODO: è¿æ¥åˆ°å®é™…é™éŸ³æ§åˆ¶
                            if (window.__mmb_setMute) window.__mmb_setMute(this.checked);
                        });
                    }
                    
                    // æŒ‰é’®äº‹ä»¶
                    var btnInstructions = document.getElementById('btn-instructions');
                    if (btnInstructions) {
                        btnInstructions.addEventListener('click', function(){
                            alert('æ¸¸æˆè¯´æ˜ï¼š\\n- WASD ç§»åŠ¨\\n- é¼ æ ‡ç„å‡†\\n- å·¦é”®å°„å‡»\\n- å‡»è´¥å¯¹æ‰‹è·å¾—åˆ†æ•°ï¼');
                        });
                    }
                    
                    var btnClear = document.getElementById('btn-clear');
                    if (btnClear) {
                        btnClear.addEventListener('click', function(){
                            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¸¸æˆè®°å½•å—ï¼Ÿ')) {
                                localStorage.removeItem('mmb-high-score');
                                localStorage.removeItem('mmb-max-combo');
                                localStorage.removeItem('mmb-total-games');
                                localStorage.removeItem('mmb-wins');
                                document.getElementById('high-score').textContent = '0';
                                document.getElementById('max-combo').textContent = '0';
                                document.getElementById('total-games').textContent = '0';
                                document.getElementById('win-rate').textContent = '0%';
                                alert('è®°å½•å·²æ¸…ç©ºï¼');
                            }
                        });
                    }
                    
                    var btnClose = document.getElementById('btn-close');
                    if (btnClose) {
                        btnClose.addEventListener('click', function(){
                            if (confirm('ç¡®å®šè¦é€€å‡ºæ¸¸æˆå—ï¼Ÿ')) {
                                window.location.href = 'index.html';
                            }
                        });
                    }
                    
                    // åŠ è½½ä¿å­˜çš„ç»Ÿè®¡æ•°æ®
                    function loadStats() {
                        var highScore = localStorage.getItem('mmb-high-score') || '9';
                        var maxCombo = localStorage.getItem('mmb-max-combo') || '6';
                        var totalGames = parseInt(localStorage.getItem('mmb-total-games') || '0');
                        var wins = parseInt(localStorage.getItem('mmb-wins') || '0');
                        var winRate = totalGames > 0 ? Math.round((wins / totalGames) * 100) : 0;
                        
                        document.getElementById('high-score').textContent = highScore;
                        document.getElementById('max-combo').textContent = maxCombo;
                        document.getElementById('total-games').textContent = totalGames;
                        document.getElementById('win-rate').textContent = winRate + '%';
                    }
                    
                    // æ¸¸æˆæ—¶é•¿è®¡æ—¶å™¨
                    var gameStartTime = Date.now();
                    setInterval(function(){
                        var elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
                        var minutes = Math.floor(elapsed / 60);
                        var seconds = elapsed % 60;
                        document.getElementById('game-time').textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                    }, 1000);
                    
                    loadStats();
                })();
    </script>
</body>

</html>
