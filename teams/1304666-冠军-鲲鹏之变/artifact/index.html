<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>é²²é¹ä¹‹å˜ | åŸºäºåº„å­é€é¥æ¸¸çš„å¤§é±¼åƒå°é±¼æ¸¸æˆ</title>
    <meta name="description" content="ä½“éªŒåº„å­ã€Šé€é¥æ¸¸ã€‹ä¸­é²²åŒ–ä¸ºé¹çš„ç¥å¥‡å˜åŒ–ï¼Œä»åŒ—å†¥å°é±¼æˆé•¿ä¸ºç¿±ç¿”ä¹å¤©çš„å¤§é¹é¸Ÿ">
    <meta name="keywords" content="é²²é¹,åº„å­,é€é¥æ¸¸,å¤§é±¼åƒå°é±¼,ä¼ ç»Ÿæ–‡åŒ–,MoonBit">
    <meta name="theme-color" content="#0a1630" />
    <!-- Favicon: é‡‘è‰²é²²é±¼å›¾æ ‡ï¼ˆSVGï¼‰ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,
%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E
%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%23ffd700'/%3E%3Cstop offset='1' stop-color='%23ff8c00'/%3E%3C/linearGradient%3E%3C/defs%3E
%3Crect width='64' height='64' rx='12' fill='%230a1630'/%3E
%3Ccircle cx='34' cy='32' r='16' fill='url(%23g)' stroke='%23ffd700' stroke-width='2'/%3E
%3Cpolygon points='18,32 6,24 6,40' fill='url(%23g)' stroke='%23ffd700' stroke-width='2'/%3E
%3Ccircle cx='40' cy='28' r='3' fill='%23000'/%3E%3Ccircle cx='39' cy='27' r='1.2' fill='%23fff'/%3E
%3Cpath d='M45 32 l10 -6 v12 z' fill='url(%23g)' stroke='%23ffd700' stroke-width='2'/%3E
%3C/svg%3E" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', 'STKaiti', serif;
        }

        body {
            background: linear-gradient(135deg, #0f1419, #1a2332, #2c3e50);
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            text-align: center;
            padding: 20px 0;
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 3px solid #ffd700;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            letter-spacing: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #87ceeb;
            opacity: 0.9;
            font-style: italic;
        }

        .quote {
            font-size: 0.9rem;
            color: #b0c4de;
            margin-top: 8px;
            opacity: 0.8;
        }

        .game-area {
            display: flex;
            gap: 20px;
            flex: 1;
            padding: 20px;
            align-items: flex-start; /* é¡¶ç«¯å¯¹é½ï¼Œé¿å…å³æ ä¸‹æ²‰ */
        }

        .game-canvas-container {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid #ffd700;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #gameCanvas {
            border: 3px solid #ffd700;
            border-radius: 15px;
            background: linear-gradient(180deg, 
                #87ceeb 0%,      /* å¤©è“è‰² - å¤©ç©º */
                #4682b4 50%,     /* é’¢è“è‰² - æµ·æ´‹ */
                #191970 100%     /* åˆå¤œè“ - æ·±æµ· */
            );
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            cursor: none;
            max-width: 100%;
            height: auto;
        }

        .game-info {
            width: 320px;
            min-width: 300px;
            flex: 0 0 320px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 2px solid #ffd700;
            position: sticky;
            top: 16px;
            max-height: calc(100vh - 120px);
            overflow: auto;
        }

        .info-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border-left: 4px solid #ffd700;
        }

        .info-title {
            font-size: 1.4rem;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 12px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .evolution-stage {
            text-align: center;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .stage-name {
            font-size: 1.2rem;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stage-description {
            font-size: 0.9rem;
            color: #b0c4de;
            line-height: 1.4;
        }

        .progress-container {
            margin-bottom: 15px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #87ceeb, #ffd700, #ff4500);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.3rem;
            color: #ffd700;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #b0c4de;
            margin-top: 2px;
        }

        .controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .control-key {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            font-family: monospace;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .game-status {
            text-align: center;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 10px;
        }

        .status-playing {
            color: #87ceeb;
            background: rgba(135, 206, 235, 0.1);
            border: 1px solid rgba(135, 206, 235, 0.3);
        }

        .status-win {
            color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            animation: pulse 2s infinite;
        }

        .status-lose {
            color: #ff4500;
            background: rgba(255, 69, 0, 0.1);
            border: 1px solid rgba(255, 69, 0, 0.3);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .transformation-message, .game-over-message {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(25, 25, 112, 0.95));
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            border: 3px solid #ffd700;
            z-index: 1000;
            max-width: 500px;
        }

        .transformation-title {
            font-size: 2.2rem;
            color: #ffd700;
            margin-bottom: 15px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }

        .transformation-text {
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.6;
            color: #b0c4de;
        }

        .restart-btn {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .restart-btn:hover {
            background: linear-gradient(45deg, #ffed4e, #ffd700);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
        }

        footer {
            text-align: center;
            padding: 15px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #87ceeb;
            border-top: 1px solid rgba(255, 215, 0, 0.3);
        }

        /* åŠ¨ç”»æ•ˆæœ */
        .info-section {
            animation: slideInRight 0.8s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .game-canvas-container {
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* é€šç”¨éšè—å·¥å…·ç±» */
        .hidden { display: none !important; }

        /* é±¼ç±»å½¢æ€æ ·å¼ */
        .fish-stage-xiami { color: #ffb6c1; }
        .fish-stage-kunmiao { color: #87ceeb; }
        .fish-stage-qingyu { color: #2e8b57; }
        .fish-stage-caoyu { color: #4682b4; }
        .fish-stage-liyu { color: #ffd700; }
        .fish-stage-jiaolong { color: #8b008b; }
        .fish-stage-kun { color: #191970; }
        .fish-stage-dapeng { color: #ff4500; }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .game-area {
                flex-direction: column;
            }
            
            .game-info {
                width: 100%;
                min-width: 0;
                position: static;
                max-height: none;
                overflow: visible;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="overlay" id="overlay"></div>
    
    <div class="container">
        <header>
            <h1>é²²é¹ä¹‹å˜</h1>
            <div class="subtitle">åŸºäºåº„å­ã€Šé€é¥æ¸¸ã€‹çš„å¤§é±¼åƒå°é±¼æ¸¸æˆ</div>
            <div class="quote">"åŒ—å†¥æœ‰é±¼ï¼Œå…¶åä¸ºé²²ã€‚é²²ä¹‹å¤§ï¼Œä¸çŸ¥å…¶å‡ åƒé‡Œä¹Ÿã€‚åŒ–è€Œä¸ºé¸Ÿï¼Œå…¶åä¸ºé¹ã€‚"</div>
        </header>

        <div class="game-area">
            <div class="game-canvas-container">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
            </div>

            <div class="game-info">
                <!-- ä»…å±•ç¤ºæ¸¸æˆè§„åˆ™ï¼Œå…¶ä½™ä¿¡æ¯éšè—é¿å…å¹²æ‰°è¯„å®¡ -->
                <div class="info-section">
                    <div class="info-title">æ¸¸æˆè§„åˆ™</div>
                    <div style="font-size: 0.95rem; line-height: 1.6; color: #b0c4de;">
                        <div style="margin-bottom: 8px;">ğŸ›¡ï¸ å¼€å±€æ— æ•Œï¼šæ¸¸æˆå¼€å§‹å <b>5 ç§’</b>å†…å¤„äºæ— æ•ŒçŠ¶æ€ï¼Œå¯å®‰å…¨ç†Ÿæ‚‰ç¯å¢ƒã€‚</div>
                        <div style="margin-bottom: 8px;">ğŸ¨ é¢œè‰²åˆ¤å®šï¼š
                            <div style="margin-top: 6px;">
                                <span style="color:#90EE90; font-weight:bold;">ç»¿è‰²è¾¹æ¡†</span>ï¼šå¯ä»¥åƒï¼›
                                <span style="color:white; font-weight:bold;">ç™½è‰²è¾¹æ¡†</span>ï¼šåŒçº§ï¼Œä¸èƒ½åƒï¼›
                                <span style="color:#FF6B6B; font-weight:bold;">çº¢è‰²è¾¹æ¡†</span>ï¼šå±é™©ï¼Œä¼šè¢«åƒå¯¼è‡´å¤±è´¥ã€‚
                            </div>
                        </div>
                        <div style="margin-bottom: 8px;">â¬†ï¸ è¿›åŒ–ä¸èƒœåˆ©ï¼šåå™¬è¶³é‡çŒç‰©å³å¯è¿›åŒ–ï¼Œæœ€ç»ˆåŒ–ä¸º<b>é²²é¹</b>è·å¾—èƒœåˆ©ã€‚</div>
                    </div>
                </div>
                <div class="info-section hidden">
                    <div class="info-title">æ¸¸æˆçŠ¶æ€</div>
                    <div class="game-status status-playing" id="gameStatus">å‡†å¤‡å¼€å§‹åŒ—å†¥ä¹‹æ—…</div>
                </div>

                <div class="info-section hidden">
                    <div class="info-title">è¿›åŒ–é˜¶æ®µ</div>
                    <div class="evolution-stage" id="evolutionStage">
                        <div class="stage-name" id="stageName">é²²è‹—</div>
                        <div class="stage-description" id="stageDesc">åŒ—å†¥å°é±¼ï¼Œåˆç”Ÿç”Ÿçµ</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>è¿›åŒ–è¿›åº¦</span>
                            <span id="evolutionProgress">0/5</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="evolutionBar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="info-section hidden">
                    <div class="info-title">æ¸¸æˆç»Ÿè®¡</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="scoreValue">0</div>
                            <div class="stat-label">åˆ†æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="levelValue">1</div>
                            <div class="stat-label">ç­‰çº§</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="sizeValue">1</div>
                            <div class="stat-label">å¤§å°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="fishCount">15</div>
                            <div class="stat-label">é±¼ç¾¤</div>
                        </div>
                    </div>
                </div>

                <div class="info-section hidden">
                    <div class="info-title">å½“å‰ç”Ÿæ€</div>
                    <div id="currentEcosystem" style="font-size: 0.9rem; line-height: 1.6; color: #b0c4de;"></div>
                </div>

                <div class="info-section hidden">
                    <div class="info-title">æ“ä½œæŒ‡å—</div>
                    <div class="controls">
                        <div class="control-item">
                            <span>ğŸŸ ç§»åŠ¨</span>
                            <span><span class="control-key">é¼ æ ‡æŒ‡å‘</span></span>
                        </div>
                        <div class="control-item">
                            <span>ğŸ”„ é‡æ–°å¼€å§‹</span>
                            <span><span class="control-key">Ré”®</span></span>
                        </div>
                    </div>
                </div>

                <div class="info-section hidden">
                    <div class="info-title">æ¸¸æˆæç¤º</div>
                    <p style="font-size: 0.9rem; line-height: 1.5; color: #b0c4de;">
                        ğŸ” å¯»æ‰¾æµ…ç²‰è‰²çš„è™¾ç±³ä½œä¸ºé£Ÿç‰©
                        <br>
                        âš ï¸ é¿å¼€æ¯”è‡ªå·±å¤§çš„é±¼ç±»
                        <br>
                        ğŸ¯ åå™¬5æ¡é±¼å®Œæˆè¿›åŒ–
                        <br>
                        ğŸ† æœ€ç»ˆåŒ–ä¸ºå¤§é¹é¸Ÿå®Œæˆé€é¥æ¸¸
                    </p>
                </div>
            </div>
        </div>

        <footer>
            <p>é²²é¹ä¹‹å˜ | MoonBit 2025 å…¨çƒç¼–ç¨‹æŒ‘æˆ˜èµ› | ä¼ æ‰¿ä¸­åæ–‡åŒ–ï¼Œæ¼”ç»åº„å­å“²å­¦</p>
        </footer>
    </div>

    <!-- è¿›åŒ–æ¶ˆæ¯ -->
    <div class="transformation-message" id="transformationMessage">
        <div class="transformation-title" id="transformationTitle">è¿›åŒ–æˆåŠŸï¼</div>
        <div class="transformation-text" id="transformationText">ä½ çš„å½¢æ€å‘ç”Ÿäº†å˜åŒ–</div>
        <button class="restart-btn" onclick="restartGame()">å†æ¥ä¸€ç›˜</button>
    </div>

    <!-- æ¸¸æˆç»“æŸæ¶ˆæ¯ -->
    <div class="game-over-message" id="gameOverMessage">
        <div class="transformation-title" id="gameOverTitle">æ¸¸æˆç»“æŸ</div>
        <div class="transformation-text" id="gameOverText">è¢«æ›´å¤§çš„é±¼ç±»åå™¬äº†</div>
        <button class="restart-btn" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
    </div>

    <script>
        let wasmInstance;
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameRunning = false;
        let animationId;
        
        // è¾“å…¥çŠ¶æ€
        let keys = {};
        
        // é¼ æ ‡æ§åˆ¶
        let mouseX = 400;
        let mouseY = 300;
        let mouseControl = false;
        
        // è¿›åŒ–é˜¶æ®µé…ç½® - æ›´æ–°ä¸º8ä¸ªé˜¶æ®µï¼ˆåŒ…æ‹¬è™¾ç±³ï¼‰
        const evolutionStages = {
            0: { name: 'è™¾ç±³', desc: 'å¾®å°ç”Ÿç‰©ï¼Œé²²è‹—çš„é£Ÿç‰©', class: 'fish-stage-xiami' },
            1: { name: 'é²²è‹—', desc: 'åŒ—å†¥å°é±¼ï¼Œåˆç”Ÿç”Ÿçµ', class: 'fish-stage-kunmiao' },
            2: { name: 'é’é±¼', desc: 'æ™®é€šé±¼ç±»ï¼Œé€æ¸æˆé•¿', class: 'fish-stage-qingyu' },
            3: { name: 'è‰é±¼', desc: 'ä¸­å‹é±¼ç±»ï¼ŒåŠ›é‡å¢å¼º', class: 'fish-stage-caoyu' },
            4: { name: 'é²¤é±¼', desc: 'å¤§å‹é±¼ç±»ï¼Œæ¸¸é€Ÿå‡ç¼“', class: 'fish-stage-liyu' },
            5: { name: 'è›Ÿé¾™', desc: 'ç¨€æœ‰é±¼ç±»ï¼Œè•´å«é¾™æ°”', class: 'fish-stage-jiaolong' },
            6: { name: 'é²²', desc: 'åŠé²²çŠ¶æ€ï¼Œå·¨å¤§æ— æœ‹', class: 'fish-stage-kun' },
            7: { name: 'å¤§é¹', desc: 'åŒ–è€Œä¸ºé¸Ÿï¼Œç¿±ç¿”ä¹å¤©', class: 'fish-stage-dapeng' }
        };

        // WASMåŠ è½½
        async function loadWasm() {
            try {
                const response = await fetch('game.wasm?v=4');
                const wasmBuffer = await response.arrayBuffer();
                
                const wasmModule = await WebAssembly.instantiate(wasmBuffer, {
                    env: {}
                });
                
                wasmInstance = wasmModule.instance;
                console.log('é²²é¹æ¸¸æˆWASMæ¨¡å—åŠ è½½æˆåŠŸ');
                
                // åˆå§‹åŒ–æ¸¸æˆ
                wasmInstance.exports.init_game();
                startGameLoop();
                updateGameStatus('åŒ—å†¥æ¸¸åŠ¨ä¸­...');
                
            } catch (error) {
                console.error('WASMåŠ è½½å¤±è´¥:', error);
                updateGameStatus('åŠ è½½å¤±è´¥: ' + error.message + 'ï¼ˆæ¯”èµ›æ¨¡å¼ï¼šä»…æ”¯æŒ WASMï¼‰');
                // ä¸å†å¯ç”¨ä»»ä½• JS æ¨¡æ‹Ÿæ¨¡å¼ï¼Œéµå®ˆèµ›äº‹ä»… WASM è¦æ±‚
            }
        }

        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            if (!wasmInstance || !gameRunning) return;
            
            handleInput();
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            const gameState = wasmInstance.exports.update_game_wasm();
            
            if (gameState === 2) {
                // èƒœåˆ© - å®Œæˆé²²é¹å˜åŒ–
                gameRunning = false;
                showTransformation('é²²é¹å˜åŒ–å®Œæˆï¼', 'æ­å–œä½ ï¼ä»åŒ—å†¥å°é±¼æˆåŠŸåŒ–ä¸ºç¿±ç¿”ä¹å¤©çš„å¤§é¹é¸Ÿï¼Œå®Œæˆäº†é€é¥æ¸¸çš„ç»ˆæå¢ƒç•Œï¼');
                updateGameStatus('é€é¥æ¸¸å®Œæˆï¼');
            } else if (gameState === 0) {
                // å¤±è´¥
                gameRunning = false;
                showGameOver('æ¸¸æˆç»“æŸ', 'è¢«æ›´å¤§çš„é±¼ç±»åå™¬äº†ï¼Œé‡æ–°å¼€å§‹ä½ çš„åŒ—å†¥ä¹‹æ—…å§ï¼');
                updateGameStatus('åŒ—å†¥ä¹‹æ—…ç»“æŸ');
            }
            
            // æ¸²æŸ“æ¸¸æˆ
            render();
            
            // æ›´æ–°UI
            updateUI();
            
            if (gameRunning) {
                animationId = requestAnimationFrame(gameLoop);
            }
        }

        function startGameLoop() {
            gameRunning = true;
            gameLoop();
        }

        function handleInput() {
            if (!wasmInstance) return;
            
            // ç®€åŒ–çš„é¼ æ ‡æ§åˆ¶ - é¿å…å¤æ‚è®¡ç®—å¯¼è‡´çš„å¡é¡¿
            if (mouseControl) {
                const pos = wasmInstance.exports.get_player_pos_wasm();
                const playerX = (pos >> 16) & 0xFFFF;
                const playerY = pos & 0xFFFF;
                
                const dx = mouseX - playerX;
                const dy = mouseY - playerY;
                
                // ç®€åŒ–çš„æ–¹å‘åˆ¤æ–­ï¼Œé¿å…sqrtè®¡ç®—
                let direction = 4;
                if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {
                    if (Math.abs(dx) > Math.abs(dy)) {
                        direction = dx > 0 ? 1 : 3; // å³æˆ–å·¦
                    } else {
                        direction = dy > 0 ? 2 : 0; // ä¸‹æˆ–ä¸Š
                    }
                    wasmInstance.exports.move_player_wasm(direction);
                }
                return;
            }
            
            // é”®ç›˜æ§åˆ¶
            let direction = 4; // é»˜è®¤åœæ­¢
            
            if (keys['ArrowUp'] || keys['w'] || keys['W']) {
                direction = 0; // ä¸Š
            } else if (keys['ArrowRight'] || keys['d'] || keys['D']) {
                direction = 1; // å³
            } else if (keys['ArrowDown'] || keys['s'] || keys['S']) {
                direction = 2; // ä¸‹
            } else if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
                direction = 3; // å·¦
            }
            
            wasmInstance.exports.move_player_wasm(direction);
            
            // å¤„ç†é‡æ–°å¼€å§‹
            if (keys['r'] || keys['R']) {
                restartGame();
                keys['r'] = keys['R'] = false;
            }
        }

        function render() {
            if (!wasmInstance) return;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æµ·æ´‹èƒŒæ™¯
            drawOceanBackground();
            
            // è·å–å¹¶ç»˜åˆ¶æ¸¸æˆå…ƒç´ 
            drawPlayer();
            drawAIFishes();
            
            // ç»˜åˆ¶ç‰¹æ•ˆ
            drawEffects();
        }

        function drawOceanBackground() {
            // æµ·æ´‹æ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87ceeb');    // å¤©è“è‰² - æµ·é¢
            gradient.addColorStop(0.5, '#4682b4');  // é’¢è“è‰² - ä¸­å±‚
            gradient.addColorStop(1, '#191970');    // åˆå¤œè“ - æ·±æµ·
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æµ·åº•è£…é¥°
            drawSeaweed();
            drawBubbles();
        }

        function drawSeaweed() {
            ctx.strokeStyle = 'rgba(34, 139, 34, 0.6)';
            ctx.lineWidth = 4;
            
            const time = Date.now() * 0.001;
            
            for (let i = 0; i < 12; i++) {
                const x = (i * 70) + 30;
                const baseHeight = 40 + i * 8;
                
                ctx.beginPath();
                ctx.moveTo(x, canvas.height);
                
                for (let j = 0; j < 8; j++) {
                    const y = canvas.height - j * 15;
                    const offsetX = Math.sin(time + i * 0.5 + j * 0.3) * 12;
                    ctx.lineTo(x + offsetX, y);
                }
                
                ctx.stroke();
            }
        }

        function drawBubbles() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            const time = Date.now() * 0.003;
            
            for (let i = 0; i < 20; i++) {
                const x = (Math.sin(time + i * 0.7) * 60 + i * 40) % canvas.width;
                const y = (canvas.height - (time * 20 + i * 30) % canvas.height);
                const size = 2 + Math.sin(time + i) * 2;
                
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawPlayer() {
            const pos = wasmInstance.exports.get_player_pos_wasm();
            if (pos < 0) return;
            
            const x = (pos >> 16) & 0xFFFF;
            const y = pos & 0xFFFF;
            const info = wasmInstance.exports.get_player_info_wasm();
            const size = (info >> 24) & 0xFF;
            const fishType = (info >> 16) & 0xFF;
            const gameStatus = wasmInstance.exports.get_game_status_wasm();
            const invincible = ((gameStatus >> 7) & 0x1) === 1;
            
            // ç»˜åˆ¶æ— æ•Œå…‰ç¯æ•ˆæœ
            if (invincible) {
                const time = Date.now() * 0.01;
                const pulseSize = Math.sin(time) * 5 + 15;
                
                ctx.beginPath();
                ctx.arc(x, y, size * 8 + 8 + pulseSize, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(255, 215, 0, ${0.3 + Math.sin(time * 2) * 0.2})`;
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // å†…å±‚å…‰ç¯
                ctx.beginPath();
                ctx.arc(x, y, size * 8 + 8 + pulseSize * 0.7, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(255, 255, 255, ${0.4 + Math.sin(time * 3) * 0.3})`;
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            drawFish(x, y, size, fishType, true);
        }

        function drawAIFishes() {
            const pInfo = wasmInstance.exports.get_player_info_wasm();
            const playerSize = (pInfo >> 24) & 0xFF;
            for (let i = 0; i < 18; i++) {  // 18æ¡é±¼ï¼Œ3ç§ç±»å‹
                const pos = wasmInstance.exports.get_ai_fish_info_wasm(i);
                if (pos < 0) continue;
                
                const details = wasmInstance.exports.get_ai_fish_details_wasm(i);
                if (details < 0) continue;
                
                const x = (pos >> 16) & 0xFFFF;
                const y = pos & 0xFFFF;
                const size = (details >> 24) & 0xFF;
                const fishType = (details >> 16) & 0xFF;
                const color = details & 0xFFFF;
                const relation = size < playerSize ? 'food' : (size === playerSize ? 'peer' : 'danger');
                drawFish(x, y, size, fishType, false, relation);
            }
        }

        function drawFish(x, y, size, fishType, isPlayer, relation) {
            const radius = size * 8 + 8;
            
            ctx.save();
            ctx.translate(x, y);
            
            // é±¼èº«
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, Math.PI * 2);
            
            // æ ¹æ®é±¼çš„ç±»å‹è®¾ç½®é¢œè‰² - æ›´æ–°ä¸º8ç§é¢œè‰²
            const colors = ['#ffb6c1', '#87ceeb', '#2e8b57', '#4682b4', '#ffd700', '#8b008b', '#191970', '#ff4500'];
            ctx.fillStyle = colors[fishType] || '#87ceeb';
            ctx.fill();
            
            // é±¼èº«è½®å»“ - æ ¹æ®ç­‰çº§ä¸åŒè®¾ç½®ä¸åŒçš„è¾¹æ¡†æ ·å¼
            if (isPlayer) {
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 3;
            } else {
                if (relation === 'food') { ctx.strokeStyle = '#90EE90'; ctx.lineWidth = 2; }
                else if (relation === 'peer') { ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 2; }
                else { ctx.strokeStyle = '#FF6B6B'; ctx.lineWidth = 2; }
            }
            ctx.stroke();
            
            // é±¼å°¾
            const tailSize = radius * 0.8;
            ctx.beginPath();
            ctx.moveTo(-radius, 0);
            ctx.lineTo(-radius - tailSize, -tailSize/2);
            ctx.lineTo(-radius - tailSize, tailSize/2);
            ctx.closePath();
            ctx.fillStyle = colors[fishType] || '#87ceeb';
            ctx.fill();
            ctx.stroke();
            
            // é±¼çœ¼
            ctx.beginPath();
            ctx.arc(radius/3, -radius/3, radius/5, 0, Math.PI * 2);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(radius/3, -radius/3, radius/8, 0, Math.PI * 2);
            ctx.fillStyle = '#000000';
            ctx.fill();
            
            // æ ¹æ®ç­‰çº§æ·»åŠ ä¸åŒçš„è£…é¥°
            if (size >= 3) {
                // å¤§å‹é±¼ç±»æ·»åŠ é³ç‰‡æ•ˆæœ
                ctx.beginPath();
                ctx.arc(-radius/3, radius/4, radius/6, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fill();
            }
            
            if (size >= 4) {
                // æ›´å¤§çš„é±¼ç±»æ·»åŠ èƒŒé³
                ctx.beginPath();
                ctx.moveTo(0, -radius);
                ctx.lineTo(-radius/4, -radius - radius/4);
                ctx.lineTo(radius/4, -radius - radius/4);
                ctx.closePath();
                ctx.fillStyle = colors[fishType] || '#87ceeb';
                ctx.fill();
                ctx.stroke();
            }
            
            // å¦‚æœæ˜¯ç©å®¶ï¼Œæ·»åŠ å…‰ç¯æ•ˆæœ
            if (isPlayer) {
                ctx.beginPath();
                ctx.arc(0, 0, radius + 5, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(255, 215, 0, 0.5)';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            ctx.restore();
        }

        function drawEffects() {
            // æ·»åŠ æ›´ä¸°å¯Œçš„ç²’å­æ•ˆæœ
            const time = Date.now() * 0.01;
            
            // é‡‘è‰²ç²’å­æ•ˆæœ
            for (let i = 0; i < 8; i++) {
                const x = (Math.sin(time + i) * 120 + canvas.width/2) % canvas.width;
                const y = (Math.cos(time + i * 1.3) * 120 + canvas.height/2) % canvas.height;
                const size = Math.max(0.6, 1.2 + Math.sin(time * 2 + i) * 0.8);
                
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 215, 0, ${0.4 + Math.sin(time + i) * 0.3})`;
                ctx.fill();
            }
            
            // é¼ æ ‡ä½ç½®æŒ‡ç¤ºå™¨
            if (mouseControl) {
                ctx.beginPath();
                ctx.arc(mouseX, mouseY, 8, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(255, 215, 0, 0.8)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.beginPath();
                ctx.arc(mouseX, mouseY, 4, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 215, 0, 0.6)';
                ctx.fill();
            }
        }

        function updateUI() {
            if (!wasmInstance) return;
            
            const playerInfo = wasmInstance.exports.get_player_info_wasm();
            const gameStatus = wasmInstance.exports.get_game_status_wasm();
            const invincibleTime = wasmInstance.exports.get_invincible_time_wasm();
            
            const size = (playerInfo >> 24) & 0xFF;
            const fishType = (playerInfo >> 16) & 0xFF;
            const score = playerInfo & 0xFFFF;
            
            const level = (gameStatus >> 16) & 0xFF;
            const transformation = ((gameStatus >> 8) & 0x1) === 1;
            const invincible = ((gameStatus >> 7) & 0x1) === 1;
            const evolutionProgress = gameStatus & 0xFF;
            
            // æ›´æ–°è¿›åŒ–é˜¶æ®µ
            const stage = evolutionStages[fishType] || evolutionStages[0];
            document.getElementById('stageName').textContent = stage.name;
            document.getElementById('stageName').className = `stage-name ${stage.class}`;
            document.getElementById('stageDesc').textContent = stage.desc;
            
            // æ›´æ–°è¿›åŒ–è¿›åº¦ï¼šåˆ°è¾¾æœ€ç»ˆé˜¶æ®µæ—¶æ˜¾ç¤ºâ€œå®Œæˆâ€
            if (fishType >= 7) {
                document.getElementById('evolutionProgress').textContent = `å®Œæˆ`;
                document.getElementById('evolutionBar').style.width = `100%`;
            } else {
                document.getElementById('evolutionProgress').textContent = `${evolutionProgress}/5`;
                document.getElementById('evolutionBar').style.width = `${(evolutionProgress / 5) * 100}%`;
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('scoreValue').textContent = score;
            document.getElementById('levelValue').textContent = level;
            document.getElementById('sizeValue').textContent = size;
            
            // è®¡ç®—å­˜æ´»çš„é±¼æ•° - æ›´æ–°ä¸º18æ¡
            let aliveCount = 0;
            for (let i = 0; i < 18; i++) {
                if (wasmInstance.exports.get_ai_fish_info_wasm(i) >= 0) {
                    aliveCount++;
                }
            }
            document.getElementById('fishCount').textContent = aliveCount;
            
            // æ˜¾ç¤ºæ— æ•ŒçŠ¶æ€
            if (invincible) {
                const invincibleSeconds = Math.ceil(invincibleTime / 60);
                updateGameStatus(`æ— æ•Œæ—¶é—´: ${invincibleSeconds}ç§’`);
            }

            // åŠ¨æ€æ›´æ–°å½“å‰ç”Ÿæ€ï¼ˆæ¯é˜¶æ®µä»…ä¸‰ç±»ï¼‰
            updateEcosystem(fishType);
        }

        // æ ¹æ®é˜¶æ®µæ›´æ–°â€œå½“å‰ç”Ÿæ€â€è¯´æ˜
        function updateEcosystem(fishType) {
            const el = document.getElementById('currentEcosystem');
            if (!el) return;
            const dot = (name, color, tip) => `<div style="margin-bottom:8px;"><span style="color:${color};font-weight:bold;">â— ${name}</span> - ${tip}</div>`;
            const colors = ['#ffb6c1', '#87ceeb', '#2e8b57', '#4682b4', '#ffd700', '#8b008b', '#191970', '#ff4500'];
            let html = '';
            switch (fishType) {
                case 0: // è™¾ç±³
                case 1: // é²²è‹—
                    html = dot('è™¾ç±³', colors[0], 'ä½ çš„é£Ÿç‰©') +
                           dot('é²²è‹—', colors[1], 'åŒç­‰çº§') +
                           dot('é’é±¼', colors[2], 'éœ€è¦é¿å¼€');
                    break;
                case 2: // é’é±¼
                    html = dot('é²²è‹—', colors[1], 'ä½ çš„é£Ÿç‰©') +
                           dot('é’é±¼', colors[2], 'åŒç­‰çº§') +
                           dot('è‰é±¼', colors[3], 'éœ€è¦é¿å¼€');
                    break;
                case 3: // è‰é±¼
                    html = dot('é’é±¼', colors[2], 'ä½ çš„é£Ÿç‰©') +
                           dot('è‰é±¼', colors[3], 'åŒç­‰çº§') +
                           dot('é²¤é±¼', colors[4], 'éœ€è¦é¿å¼€');
                    break;
                case 4: // é²¤é±¼
                    html = dot('è‰é±¼', colors[3], 'ä½ çš„é£Ÿç‰©') +
                           dot('é²¤é±¼', colors[4], 'åŒç­‰çº§') +
                           dot('è›Ÿé¾™', colors[5], 'éœ€è¦é¿å¼€');
                    break;
                case 5: // è›Ÿé¾™
                    html = dot('é²¤é±¼', colors[4], 'ä½ çš„é£Ÿç‰©') +
                           dot('è›Ÿé¾™', colors[5], 'åŒç­‰çº§') +
                           dot('é²²', colors[6], 'éœ€è¦é¿å¼€');
                    break;
                case 6: // é²²
                    html = dot('è›Ÿé¾™', colors[5], 'ä½ çš„é£Ÿç‰©') +
                           dot('é²²', colors[6], 'åŒç­‰çº§') +
                           dot('å¤§é¹', colors[7], 'éœ€è¦é¿å¼€');
                    break;
                case 7: // å¤§é¹
                    html = dot('é²²', colors[6], 'åŒç­‰çº§') +
                           dot('å¤§é¹', colors[7], 'ä½ çš„å½¢æ€') +
                           dot('è™¾ç±³', colors[0], 'è£…é¥°ç”Ÿæ€');
                    break;
                default:
                    html = dot('è™¾ç±³', colors[0], 'ä½ çš„é£Ÿç‰©') +
                           dot('é²²è‹—', colors[1], 'åŒç­‰çº§') +
                           dot('é’é±¼', colors[2], 'éœ€è¦é¿å¼€');
            }
            el.innerHTML = html;
        }

        function updateGameStatus(status) {
            const statusElement = document.getElementById('gameStatus');
            statusElement.textContent = status;
            
            statusElement.className = 'game-status ';
            if (status.includes('å®Œæˆ') || status.includes('æˆåŠŸ')) {
                statusElement.className += 'status-win';
            } else if (status.includes('ç»“æŸ') || status.includes('å¤±è´¥')) {
                statusElement.className += 'status-lose';
            } else {
                statusElement.className += 'status-playing';
            }
        }

        function showTransformation(title, text) {
            const overlay = document.getElementById('overlay');
            overlay.style.display = 'block';
            
            document.getElementById('transformationTitle').textContent = title;
            document.getElementById('transformationText').textContent = text;
            document.getElementById('transformationMessage').style.display = 'block';
        }

        function showGameOver(title, text) {
            const overlay = document.getElementById('overlay');
            overlay.style.display = 'block';
            
            document.getElementById('gameOverTitle').textContent = title;
            document.getElementById('gameOverText').textContent = text;
            document.getElementById('gameOverMessage').style.display = 'block';
        }

        function hideTransformation() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('transformationMessage').style.display = 'none';
        }

        function hideGameOver() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('gameOverMessage').style.display = 'none';
        }

        function restartGame() {
            hideGameOver();
            hideTransformation();
            
            if (wasmInstance) {
                wasmInstance.exports.init_game();
                updateGameStatus('åŒ—å†¥æ¸¸åŠ¨ä¸­...');
                startGameLoop();
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            e.preventDefault();
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // é¼ æ ‡æ§åˆ¶äº‹ä»¶ - ç®€åŒ–ç‰ˆæœ¬
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
        });

        // é»˜è®¤å¯ç”¨é¼ æ ‡æ§åˆ¶ï¼Œæ— éœ€åˆ‡æ¢
        mouseControl = true;
        canvas.style.cursor = 'crosshair';

        // åˆå§‹åŒ–
        window.onload = function() {
            updateGameStatus('æ­£åœ¨åŠ è½½åŒ—å†¥ä¸–ç•Œ...');
            loadWasm();
        };
    </script>
</body>

</html>
